<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>cellbin2.modules.scheduler API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../modules.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;cellbin2.modules</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Scheduler">Scheduler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Scheduler.__init__">Scheduler</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scheduler.weights_root">weights_root</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scheduler.param_chip">param_chip</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scheduler.config">config</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scheduler.p_naming">p_naming</a>
                        </li>
                        <li>
                                <a class="variable" href="#Scheduler.matrix_file">matrix_file</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.run_segmentation">run_segmentation</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.run_single_image">run_single_image</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.run_mul_image">run_mul_image</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.run_merge_masks">run_merge_masks</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.del_files">del_files</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#scheduler_pipeline">scheduler_pipeline</a>
            </li>
            <li>
                    <a class="function" href="#main">main</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../cellbin2.html">cellbin2</a><wbr>.<a href="./../modules.html">modules</a><wbr>.scheduler    </h1>

                
                        <input id="mod-scheduler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-scheduler-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">shutil</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.config</span> <span class="kn">import</span> <span class="n">Config</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.common</span> <span class="kn">import</span> <span class="n">TechType</span><span class="p">,</span> <span class="n">FILES_TO_KEEP</span><span class="p">,</span> <span class="n">ErrorCode</span><span class="p">,</span> <span class="n">FILES_TO_KEEP_RESEARCH</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.stereo</span> <span class="kn">import</span> <span class="n">generate_stereo_file</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.tar</span> <span class="kn">import</span> <span class="n">update_ipr_in_tar</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils</span> <span class="kn">import</span> <span class="n">clog</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">cellbin2.image</span> <span class="kn">import</span> <span class="n">cbimread</span><span class="p">,</span> <span class="n">CBImage</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.stereo_chip</span> <span class="kn">import</span> <span class="n">StereoChip</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils</span> <span class="kn">import</span> <span class="n">ipr</span><span class="p">,</span> <span class="n">rpi</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.weights_manager</span> <span class="kn">import</span> <span class="n">WeightDownloader</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">cellbin2.image</span> <span class="kn">import</span> <span class="n">cbimwrite</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">naming</span><span class="p">,</span> <span class="n">run_state</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules.metadata</span> <span class="kn">import</span> <span class="n">ProcParam</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">,</span> <span class="n">read_param_file</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span> <span class="nn">cellbin2.contrib.fast_correct</span> <span class="kn">import</span> <span class="n">run_fast_correct</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.pro_monitor</span> <span class="kn">import</span> <span class="n">process_decorator</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules.extract.register</span> <span class="kn">import</span> <span class="n">run_register</span><span class="p">,</span> <span class="n">transform_to_register</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules.extract.transform</span> <span class="kn">import</span> <span class="n">run_transform</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules.extract.tissue_seg</span> <span class="kn">import</span> <span class="n">run_tissue_seg</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules.extract.cell_seg</span> <span class="kn">import</span> <span class="n">run_cell_seg</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">from</span> <span class="nn">cellbin2.contrib.mask_manager</span> <span class="kn">import</span> <span class="n">BestTissueCellMask</span><span class="p">,</span> <span class="n">MaskManagerInfo</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules.extract.matrix_extract</span> <span class="kn">import</span> <span class="n">extract4stitched</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    A scheduler class responsible for managing the registration, segmentation, calibration, and matrix extraction processes.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    </span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    Attributes:</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">        weights_root (str): The root directory for storing CNN weight files.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">        param_chip (StereoChip): An instance of StereoChip for handling chip mask information.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        config (Config): An instance of Config for managing configuration settings.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">        _files (Dict[int, ProcFile]): A dictionary to store processed files.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">        _ipr (ImageProcessRecord): An instance of ImageProcessRecord for managing image processing records.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        _channel_images (Dict[str, Union[IFChannel, ImageChannel]]): A dictionary to store channel images.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        _output_path (str): The output directory path.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        p_naming (DumpPipelineFileNaming): An instance of DumpPipelineFileNaming for managing file naming conventions.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        matrix_file: The matrix file to be processed.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">        Initialize the StereoPipeline object with the given configuration file, chip mask file, and weights root.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        Args:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">            config_file (str): Path to the configuration file.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">            chip_mask_file (str): Path to the chip mask file.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">            weights_root (str): Root directory for weights.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights_root</span> <span class="o">=</span> <span class="n">weights_root</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span> <span class="o">=</span> <span class="n">StereoChip</span><span class="p">(</span><span class="n">chip_mask_file</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">ImageProcessRecord</span><span class="p">()</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">ipr</span><span class="o">.</span><span class="n">IFChannel</span><span class="p">,</span> <span class="n">ipr</span><span class="o">.</span><span class="n">ImageChannel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ipr.ImageChannel</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">:</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="c1"># self._image_naming: naming.DumpImageFileNaming</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="c1"># self._matrix_naming: naming.DumpMatrixFileNaming</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="nd">@process_decorator</span><span class="p">(</span><span class="s1">&#39;GiB&#39;</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="k">def</span> <span class="nf">_dump_ipr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">        Dumps the internal representation (ipr) to a specified output path.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">        Args:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">            output_path (str): The path where the ipr will be written.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        Returns:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">            None</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="n">ipr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">ipr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="n">extra_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dump ipr to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="nd">@process_decorator</span><span class="p">(</span><span class="s1">&#39;GiB&#39;</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="k">def</span> <span class="nf">_dump_rpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpi_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">        Dumps the registration pipeline (rpi) data to a specified path.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">        Args:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">            rpi_path (str): The path where the rpi data will be saved.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">        This method iterates through the files in the pipeline, checks for the existence of various image and mask files,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">        and collects the paths of these files into a dictionary. It then writes this dictionary to an HDF5 file using the</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">        `rpi.write` method. Additionally, it logs a message indicating the path where the rpi data was saved.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>                <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">):</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">cell_mask</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">):</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMaskTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cell_mask_raw</span><span class="p">):</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMaskRaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">cell_mask_raw</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>                    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">):</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMaskRawTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">registration_image</span><span class="p">):</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;Image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">registration_image</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">):</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;Image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transformed_image</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">):</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tissue_mask</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMaskTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">tissue_mask_raw</span><span class="p">):</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMaskRaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tissue_mask_raw</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>                    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">):</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMaskRawTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">][</span><span class="s1">&#39;CellMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_nuclear_mask</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">][</span><span class="s1">&#39;TissueMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_tissue_mask</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">][</span><span class="s1">&#39;CellMaskCorrect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_cell_mask</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="n">rpi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">h5_path</span><span class="o">=</span><span class="n">rpi_path</span><span class="p">,</span> <span class="n">extra_images</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dump rpi to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rpi_path</span><span class="p">))</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="k">def</span> <span class="nf">_weights_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">        Check and download the weights for cell and tissue segmentation.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">        This method iterates through the files in the `_files` dictionary and checks if each file has cell or tissue</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        segmentation enabled. If so, it retrieves the corresponding weights path from the configuration and appends the</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        base name of the weights path to the `weights` list. After collecting all unique weights, it attempts to download</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        them using the `WeightDownloader` class. If the download fails, a warning is logged.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">        Returns:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">            int: The status code of the weight download operation. 0 indicates success, non-zero indicates failure.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>                <span class="n">wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="o">.</span><span class="n">get_weights_path</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">wp</span><span class="p">))</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                <span class="n">wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="o">.</span><span class="n">get_weights_path</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">wp</span><span class="p">))</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="n">wd</span> <span class="o">=</span> <span class="n">WeightDownloader</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights_root</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="n">flag</span> <span class="o">=</span> <span class="n">wd</span><span class="o">.</span><span class="n">download_weight_by_names</span><span class="p">(</span><span class="n">weight_names</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to retrieve the weights file from local or server&#39;</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="k">return</span> <span class="n">flag</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>    <span class="k">def</span> <span class="nf">_data_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">        Check the data files for consistency and availability.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">        This method checks if there are any data files to be analyzed. If no data</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">        is found, it logs a warning and returns an error code. If data is found,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">        it checks if each file exists and if it is an image. If any file is missing</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">        or not an image, it logs a warning and exits the program. If all files are</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">        valid images, it checks if all images have the same size. If they do, it</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        logs the image information and returns 0. If they don&#39;t, it logs a warning</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">        and returns an error code. If no image data is found, it logs a message</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        and returns an error code.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Returns:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">            int: An error code indicating the result of the data check.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No data was found that needed to be analyzed&#39;</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="k">return</span> <span class="mi">3</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="n">wh</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                    <span class="k">continue</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                    <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Missing file, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">missFile</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># 缺失文件，非正常退出</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>                <span class="n">wh</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">image</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">wh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The sizes of the images are inconsistent&#39;</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                <span class="k">return</span> <span class="mi">1</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                    <span class="s1">&#39;Images info as (size, channel, depth) == (</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No image data need deal&#39;</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>                <span class="k">return</span> <span class="mi">2</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="k">def</span> <span class="nf">run_segmentation</span><span class="p">(</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>            <span class="n">f</span><span class="p">,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="n">im_path</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="n">ts_raw_save_path</span><span class="p">,</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="n">cs_raw_save_path</span><span class="p">,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="n">ts_save_path</span><span class="p">,</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>            <span class="n">cs_save_path</span><span class="p">,</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="n">cur_c_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ipr</span><span class="o">.</span><span class="n">ImageChannel</span><span class="p">,</span> <span class="n">ipr</span><span class="o">.</span><span class="n">IFChannel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>    <span class="p">):</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">        Run tissue and cell segmentation on the given image file.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        Args:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">            f (ProcFile): The file object containing segmentation settings.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">            im_path (Path): The path to the image file.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">            ts_raw_save_path (Path): The path to save the raw tissue segmentation mask.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">            cs_raw_save_path (Path): The path to save the raw cell segmentation mask.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">            ts_save_path (str): The path to save the final tissue segmentation mask.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">            cs_save_path (str): The path to save the final cell segmentation mask.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">            cur_c_image (object, optional): The current channel image or IF channel image, if available.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        Returns:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">            None</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="n">tissue_mask</span> <span class="o">=</span> <span class="n">run_tissue_seg</span><span class="p">(</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                <span class="n">image_path</span><span class="o">=</span><span class="n">im_path</span><span class="p">,</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="n">ts_raw_save_path</span><span class="p">,</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                <span class="n">chip_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="n">channel_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            <span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="n">tissue_mask</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">run_cell_seg</span><span class="p">(</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                <span class="n">image_path</span><span class="o">=</span><span class="n">im_path</span><span class="p">,</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="n">cs_raw_save_path</span><span class="p">,</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                <span class="n">channel_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>            <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="n">cell_mask</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="n">tissue_mask</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">ts_raw_save_path</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">cs_raw_save_path</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="n">c_box</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="k">if</span> <span class="n">cur_c_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                <span class="n">c_box</span> <span class="o">=</span> <span class="n">cur_c_image</span><span class="o">.</span><span class="n">Stitch</span><span class="o">.</span><span class="n">TransformChipBBox</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="n">input_data</span> <span class="o">=</span> <span class="n">MaskManagerInfo</span><span class="p">(</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="n">tissue_mask</span><span class="o">=</span><span class="n">tissue_mask</span><span class="p">,</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="n">cell_mask</span><span class="o">=</span><span class="n">cell_mask</span><span class="p">,</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="n">chip_box</span><span class="o">=</span><span class="n">c_box</span><span class="p">,</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                <span class="n">stain_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="n">btcm</span> <span class="o">=</span> <span class="n">BestTissueCellMask</span><span class="o">.</span><span class="n">get_best_tissue_cell_mask</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="n">btcm</span><span class="o">.</span><span class="n">best_tissue_mask</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="n">btcm</span><span class="o">.</span><span class="n">best_cell_mask</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">final_cell_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="n">cbimwrite</span><span class="p">(</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="n">cs_save_path</span><span class="p">,</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="n">files</span><span class="o">=</span><span class="n">final_cell_mask</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="k">if</span> <span class="n">final_tissue_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>            <span class="n">cbimwrite</span><span class="p">(</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="n">ts_save_path</span><span class="p">,</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">files</span><span class="o">=</span><span class="n">final_tissue_mask</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>    <span class="k">def</span> <span class="nf">run_single_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">        Process each single image in the pipeline.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">        </span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        This method iterates over each image file, performs necessary transformations,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a><span class="sd">        and applies segmentation. It handles both cases where IPR data is available and</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        where it is not.</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="c1"># Iterate over each file in the dataset</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  File[</span><span class="si">{}</span><span class="s1">] CellBin, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                <span class="n">cur_f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                <span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>                <span class="n">cur_c_image</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                <span class="c1"># Copy the stitched image</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                    <span class="c1"># IPR data is provided</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">tech</span> <span class="o">==</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                        <span class="c1"># TODO: handle two versions of IPR</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                        <span class="n">qc_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span><span class="o">.</span><span class="n">QCInfo</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QcPassFlag&#39;</span><span class="p">):</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                            <span class="n">qc_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QcPassFlag&#39;</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                            <span class="n">qc_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QCPassFlag&#39;</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                        <span class="k">if</span> <span class="n">qc_flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Cannot register under current conditions</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                            <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Image QC not pass, cannot deal this pipeline&#39;</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">qcFail</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                    <span class="c1"># Perform transform operations: Transform &gt; Segmentation &gt; Mask merge &amp; expand</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                    <span class="n">cur_c_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                    <span class="c1"># Transform input and output</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                    <span class="n">run_transform</span><span class="p">(</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                        <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                        <span class="n">channel_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">,</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                        <span class="n">files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span><span class="p">,</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                        <span class="n">if_track</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">trackline</span><span class="p">,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                        <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research_mode</span><span class="p">,</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                    <span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">run_segmentation</span><span class="p">(</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                        <span class="n">im_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                        <span class="n">ts_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                        <span class="n">cs_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                        <span class="n">ts_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                        <span class="n">cs_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                        <span class="n">cur_c_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                    <span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                    <span class="c1"># IPR data is not provided, perform segmentation directly on the input image</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">,</span> <span class="n">cur_f_name</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">run_segmentation</span><span class="p">(</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                        <span class="n">im_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                        <span class="n">ts_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                        <span class="n">cs_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">,</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                        <span class="n">ts_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">,</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                        <span class="n">cs_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                        <span class="n">cur_c_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                    <span class="p">)</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                    <span class="n">cur_m_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>                        <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                        <span class="n">m_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                        <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                    <span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                    <span class="n">cm</span> <span class="o">=</span> <span class="n">extract4stitched</span><span class="p">(</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                        <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                        <span class="n">m_naming</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                        <span class="n">detect_feature</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                    <span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                        <span class="n">run_tissue_seg</span><span class="p">(</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                            <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                            <span class="n">image_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">heatmap</span><span class="p">,</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                            <span class="n">save_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                            <span class="n">chip_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                        <span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                        <span class="n">run_cell_seg</span><span class="p">(</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                            <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                            <span class="n">image_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">heatmap</span><span class="p">,</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                            <span class="n">save_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                        <span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="k">def</span> <span class="nf">run_mul_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        Process multiple images for registration.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">        This method handles the registration of multiple images. It iterates over</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">        the files in self._files and processes only the images. If the image is</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">        registered, it performs the registration process. If not, it transforms</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">        the image to a registered format.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">        :return: None</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="c1"># 这里涉及多张图的配合，因为是配准。所以默认但张图的处理都结束了</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  File[</span><span class="si">{}</span><span class="s1">] CellBin, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">cur_f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                <span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                        <span class="k">continue</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                        <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span><span class="p">]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                        <span class="k">continue</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                    <span class="n">run_register</span><span class="p">(</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                        <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                        <span class="n">files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                        <span class="n">channel_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">,</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>                        <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                        <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                    <span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                        <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span><span class="p">]</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                        <span class="k">if</span> <span class="n">fixed</span><span class="o">.</span><span class="n">is_matrix</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span><span class="p">]</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                    <span class="n">transform_to_register</span><span class="p">(</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                    <span class="p">)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="k">def</span> <span class="nf">run_merge_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        This method processes and merges cell masks for each molecular classification file.</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        It extracts the cell mask from the file, determines the naming convention, and merges</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        the masks if necessary. Finally, it corrects the cell mask using the fast correction</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">        algorithm and saves the results.</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        :return: None</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecular_classify_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  Extract[</span><span class="si">{}</span><span class="s1">], </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="n">picked_mask</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">cell_mask</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>            <span class="n">final_nuclear_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_nuclear_mask</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="n">final_t_mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_tissue_mask</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">final_cell_mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_cell_mask</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">picked_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Just one mask</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                <span class="n">im_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                <span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                <span class="n">to_fast</span> <span class="o">=</span> <span class="n">final_nuclear_path</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Two masks, assuming the first is the nuclear mask and the second is the membrane mask</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                <span class="n">im_naming1</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                <span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                <span class="n">im_naming2</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                <span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                <span class="k">if</span> <span class="n">im_naming1</span><span class="o">.</span><span class="n">stain_type</span> <span class="o">==</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                    <span class="n">im_naming</span> <span class="o">=</span> <span class="n">im_naming2</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                    <span class="n">im_naming</span> <span class="o">=</span> <span class="n">im_naming1</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                <span class="n">merged_cell_mask_path</span> <span class="o">=</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask_merged</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">merged_cell_mask_path</span><span class="p">):</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                    <span class="kn">from</span> <span class="nn">cellbin2.contrib.mask_manager</span> <span class="kn">import</span> <span class="n">merge_cell_mask</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                    <span class="c1"># TODO: Temporarily assume im_naming1 is the nuclear segmentation result,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                    <span class="c1">#       im_naming2 is the membrane segmentation result</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">im_naming1</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">im_naming2</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                        <span class="k">continue</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                    <span class="n">mask1</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">im_naming1</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                    <span class="n">mask2</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">im_naming2</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                    <span class="n">merged_mask</span> <span class="o">=</span> <span class="n">merge_cell_mask</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                    <span class="n">cbimwrite</span><span class="p">(</span><span class="n">merged_cell_mask_path</span><span class="p">,</span> <span class="n">merged_mask</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="n">to_fast</span> <span class="o">=</span> <span class="n">merged_cell_mask_path</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="k">if</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">final_nuclear_path</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="k">if</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">im_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">,</span> <span class="n">final_t_mask_path</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="c1"># Here, we have the final cell mask and final tissue mask</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">final_cell_mask_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_fast</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                <span class="n">fast_mask</span> <span class="o">=</span> <span class="n">run_fast_correct</span><span class="p">(</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                    <span class="n">mask_path</span><span class="o">=</span><span class="n">to_fast</span><span class="p">,</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                    <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_correct</span><span class="o">.</span><span class="n">expand_r</span><span class="p">,</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                    <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_correct</span><span class="o">.</span><span class="n">process</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                <span class="n">cbimwrite</span><span class="p">(</span><span class="n">final_cell_mask_path</span><span class="p">,</span> <span class="n">fast_mask</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ipr_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">research_mode</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">        Run the main pipeline for processing the images.</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a><span class="sd">        Args:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="sd">            chip_no (str): The serial number of the chip.</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">            input_image (str): The path to the input image file.</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="sd">            stain_type (str): The type of stain used in the image.</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a><span class="sd">            param_file (str): The path to the parameter file.</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="sd">            output_path (str): The directory where the output files will be saved.</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="sd">            ipr_path (str): The path to the image process record file.</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="sd">            matrix_path (str): The path to the matrix file.</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="sd">            kit (str): The type of kit used (e.g., Transcriptomics, Protein).</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="sd">            debug (bool): Flag to enable debug mode.</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">            research_mode (bool): Flag to enable research mode.</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">        Returns:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">            None</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">output_path</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">research_mode</span> <span class="o">=</span> <span class="n">research_mode</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="c1"># Load chip information</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">parse_info</span><span class="p">(</span><span class="n">chip_no</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="c1"># Load data</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>            <span class="n">file_path</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">input_json</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>        <span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">molecular_classify_files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="n">pp</span><span class="o">.</span><span class="n">print_files_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">)</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="c1"># Exit if data validation fails</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="n">flag1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_check</span><span class="p">()</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>            <span class="k">return</span> <span class="mi">1</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ipr_path</span><span class="p">):</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ipr_path</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No existing ipr founded, assumes qc has not been done before&quot;</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="c1"># Load model</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="n">flag2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_check</span><span class="p">()</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="n">flag2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_single_image</span><span class="p">()</span>  <span class="c1"># Process a single image (transform -&gt; tissue seg -&gt; cellseg)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_mul_image</span><span class="p">()</span>  <span class="c1"># Register images</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_ipr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_merge_masks</span><span class="p">()</span>  <span class="c1"># Merge multiple masks if needed</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_rpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="k">if</span> <span class="n">research_mode</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                <span class="n">update_ipr_in_tar</span><span class="p">(</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                    <span class="n">tar_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                    <span class="n">ipr_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">,</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>                <span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                <span class="n">matrix_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                    <span class="n">m_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="n">output_path</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>                <span class="n">matrix_template</span> <span class="o">=</span> <span class="n">matrix_naming</span><span class="o">.</span><span class="n">matrix_template</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>                <span class="n">matrix_template</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="n">generate_stereo_file</span><span class="p">(</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>                <span class="n">registered_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="n">compressed_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="p">,</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>                <span class="n">matrix_template</span><span class="o">=</span><span class="n">matrix_template</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">stereo</span><span class="p">,</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>                <span class="n">sn</span><span class="o">=</span><span class="n">chip_no</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>            <span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>            <span class="n">f_to_keep</span> <span class="o">=</span> <span class="n">FILES_TO_KEEP_RESEARCH</span> <span class="k">if</span> <span class="n">research_mode</span> <span class="k">else</span> <span class="n">FILES_TO_KEEP</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">del_files</span><span class="p">(</span><span class="n">f_to_keep</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>    <span class="k">def</span> <span class="nf">del_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_to_keep</span><span class="p">):</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="sd">        Deletes files from the output directory, excluding those specified to be kept.</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">        Args:</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">            f_to_keep (list): List of file properties that should not be deleted.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">        Returns:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">            None</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>        <span class="c1"># List to store all file paths</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="n">all_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="c1"># List to store file paths that should be kept</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>        <span class="n">k_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="c1"># List to store file paths that should be removed</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>        <span class="n">remove_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>        
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="c1"># Iterate over files in self._files</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>            <span class="c1"># Get group name for the file</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>            <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>            <span class="c1"># Check if the file is a matrix</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_matrix</span><span class="p">:</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>                <span class="c1"># Create DumpMatrixFileNaming object for matrix files</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>                    <span class="n">m_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>                <span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>                <span class="c1"># Create DumpImageFileNaming object for image files</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>                <span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="c1"># Iterate over attributes of the file naming object</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f_name</span><span class="p">):</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                <span class="n">att</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="n">pt</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                <span class="c1"># Check if the attribute is a property and the file exists</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="ow">and</span> <span class="n">att</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>                    <span class="n">all_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>                    
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>                    <span class="c1"># Check if the file should be removed or kept</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                    <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_to_keep</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                        <span class="n">remove_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>                        <span class="n">k_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="c1"># Iterate over attributes of self.p_naming</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="k">for</span> <span class="n">p_p</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">):</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>            <span class="n">p_att</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">,</span> <span class="n">p_p</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="n">p_pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_p</span><span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>            
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="c1"># Check if the attribute is a property and the file exists</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_pt</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p_att</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                <span class="n">all_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>                <span class="c1"># Check if the file should be removed or kept</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                <span class="k">if</span> <span class="n">p_pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_to_keep</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                    <span class="n">remove_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                    <span class="n">k_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>        <span class="c1"># Iterate over files in the output directory</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">):</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>            
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="c1"># Remove the file if it is in the remove_ list</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">remove_</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a><span class="k">def</span> <span class="nf">scheduler_pipeline</span><span class="p">(</span><span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>                       <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ipr_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>                       <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">research_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a><span class="sd">    This function serves as the main pipeline for scheduling the image processing tasks.</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a><span class="sd">    Args:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a><span class="sd">        weights_root (str): Local directory path for storing CNN weight files.</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a><span class="sd">        chip_no (str): Sample chip number.</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a><span class="sd">        input_image (str): Local path of the stained image.</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a><span class="sd">        stain_type (str): Staining type corresponding to the stained image.</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a><span class="sd">        param_file (str): Local path of the parameter file.</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a><span class="sd">        output_path (str): Local directory path for storing output files.</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a><span class="sd">        matrix_path (str): Local directory path for storing the expression matrix.</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a><span class="sd">        ipr_path (str): Local directory path for storing the image processing record file.</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a><span class="sd">        kit (str): Kit type (e.g., Transcriptomics, Protein).</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a><span class="sd">        debug (bool, optional): Debug mode flag. Defaults to False.</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a><span class="sd">        research_mode (bool, optional): Research mode flag. Defaults to False.</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a><span class="sd">    Returns:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a><span class="sd">        int: Status code.</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>    <span class="n">curr_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>    <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;../config/cellbin.yaml&#39;</span><span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>    <span class="n">chip_mask_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;../config/chip_mask.json&#39;</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>    <span class="c1"># Initialize the Scheduler with configuration and weights</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>    <span class="n">iqc</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="o">=</span><span class="n">chip_mask_file</span><span class="p">,</span> <span class="n">weights_root</span><span class="o">=</span><span class="n">weights_root</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>    <span class="c1"># Run the main pipeline with the provided parameters</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>    <span class="n">iqc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="n">input_image</span><span class="o">=</span><span class="n">input_image</span><span class="p">,</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">stain_type</span><span class="o">=</span><span class="n">stain_type</span><span class="p">,</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="n">param_file</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="n">ipr_path</span><span class="o">=</span><span class="n">ipr_path</span><span class="p">,</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>            <span class="n">matrix_path</span><span class="o">=</span><span class="n">matrix_path</span><span class="p">,</span> <span class="n">kit</span><span class="o">=</span><span class="n">kit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">research_mode</span><span class="o">=</span><span class="n">research_mode</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">para</span><span class="p">):</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="sd">    The main function that initializes and runs the scheduler pipeline.</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">    Args:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">        args (argparse.Namespace): Parsed command - line arguments containing the configuration and input data.</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="sd">        para (dict): Additional parameters required for the pipeline.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a><span class="sd">    Returns:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">        None</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>    <span class="c1"># Call the scheduler_pipeline function with the parsed arguments</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>    <span class="n">scheduler_pipeline</span><span class="p">(</span><span class="n">weights_root</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">weights_root</span><span class="p">,</span> <span class="n">chip_no</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>                       <span class="n">input_image</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">image_path</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">stain_type</span><span class="p">,</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>                       <span class="n">param_file</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">param_file</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>                       <span class="n">ipr_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ipr_path</span><span class="p">,</span> <span class="n">matrix_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">matrix_path</span><span class="p">,</span> <span class="n">kit</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">kit</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>    <span class="kn">import</span> <span class="nn">argparse</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>    <span class="n">_VERSION_</span> <span class="o">=</span> <span class="s1">&#39;2.0&#39;</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">_VERSION_</span><span class="p">)</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--chip_no&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;chip_no&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The SN of chip.&quot;</span><span class="p">)</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--image_path&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;image_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of input file.&quot;</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--stain_type&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;stain_type&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The stain type of input image.&quot;</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--param_file&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;param_file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of input param file.&quot;</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output_path&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The results output folder.&quot;</span><span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="s2">&quot;--weights_root&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;weights_root&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The weights folder.&quot;</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="s2">&quot;--kit&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;kit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Kit Type.(Transcriptomics, Protein)&quot;</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--ipr_path&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ipr_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path of image process record file.&quot;</span><span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--matrix_path&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;matrix_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path of matrix file.&quot;</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Scheduler">
                            <input id="Scheduler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Scheduler</span>:

                <label class="view-source-button" for="Scheduler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler-32"><a href="#Scheduler-32"><span class="linenos"> 32</span></a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="Scheduler-33"><a href="#Scheduler-33"><span class="linenos"> 33</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-34"><a href="#Scheduler-34"><span class="linenos"> 34</span></a><span class="sd">    A scheduler class responsible for managing the registration, segmentation, calibration, and matrix extraction processes.</span>
</span><span id="Scheduler-35"><a href="#Scheduler-35"><span class="linenos"> 35</span></a><span class="sd">    </span>
</span><span id="Scheduler-36"><a href="#Scheduler-36"><span class="linenos"> 36</span></a><span class="sd">    Attributes:</span>
</span><span id="Scheduler-37"><a href="#Scheduler-37"><span class="linenos"> 37</span></a><span class="sd">        weights_root (str): The root directory for storing CNN weight files.</span>
</span><span id="Scheduler-38"><a href="#Scheduler-38"><span class="linenos"> 38</span></a><span class="sd">        param_chip (StereoChip): An instance of StereoChip for handling chip mask information.</span>
</span><span id="Scheduler-39"><a href="#Scheduler-39"><span class="linenos"> 39</span></a><span class="sd">        config (Config): An instance of Config for managing configuration settings.</span>
</span><span id="Scheduler-40"><a href="#Scheduler-40"><span class="linenos"> 40</span></a><span class="sd">        _files (Dict[int, ProcFile]): A dictionary to store processed files.</span>
</span><span id="Scheduler-41"><a href="#Scheduler-41"><span class="linenos"> 41</span></a><span class="sd">        _ipr (ImageProcessRecord): An instance of ImageProcessRecord for managing image processing records.</span>
</span><span id="Scheduler-42"><a href="#Scheduler-42"><span class="linenos"> 42</span></a><span class="sd">        _channel_images (Dict[str, Union[IFChannel, ImageChannel]]): A dictionary to store channel images.</span>
</span><span id="Scheduler-43"><a href="#Scheduler-43"><span class="linenos"> 43</span></a><span class="sd">        _output_path (str): The output directory path.</span>
</span><span id="Scheduler-44"><a href="#Scheduler-44"><span class="linenos"> 44</span></a><span class="sd">        p_naming (DumpPipelineFileNaming): An instance of DumpPipelineFileNaming for managing file naming conventions.</span>
</span><span id="Scheduler-45"><a href="#Scheduler-45"><span class="linenos"> 45</span></a><span class="sd">        matrix_file: The matrix file to be processed.</span>
</span><span id="Scheduler-46"><a href="#Scheduler-46"><span class="linenos"> 46</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Scheduler-47"><a href="#Scheduler-47"><span class="linenos"> 47</span></a>
</span><span id="Scheduler-48"><a href="#Scheduler-48"><span class="linenos"> 48</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scheduler-49"><a href="#Scheduler-49"><span class="linenos"> 49</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-50"><a href="#Scheduler-50"><span class="linenos"> 50</span></a><span class="sd">        Initialize the StereoPipeline object with the given configuration file, chip mask file, and weights root.</span>
</span><span id="Scheduler-51"><a href="#Scheduler-51"><span class="linenos"> 51</span></a>
</span><span id="Scheduler-52"><a href="#Scheduler-52"><span class="linenos"> 52</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-53"><a href="#Scheduler-53"><span class="linenos"> 53</span></a><span class="sd">            config_file (str): Path to the configuration file.</span>
</span><span id="Scheduler-54"><a href="#Scheduler-54"><span class="linenos"> 54</span></a><span class="sd">            chip_mask_file (str): Path to the chip mask file.</span>
</span><span id="Scheduler-55"><a href="#Scheduler-55"><span class="linenos"> 55</span></a><span class="sd">            weights_root (str): Root directory for weights.</span>
</span><span id="Scheduler-56"><a href="#Scheduler-56"><span class="linenos"> 56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-57"><a href="#Scheduler-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights_root</span> <span class="o">=</span> <span class="n">weights_root</span>
</span><span id="Scheduler-58"><a href="#Scheduler-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span> <span class="o">=</span> <span class="n">StereoChip</span><span class="p">(</span><span class="n">chip_mask_file</span><span class="p">)</span>
</span><span id="Scheduler-59"><a href="#Scheduler-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">)</span>
</span><span id="Scheduler-60"><a href="#Scheduler-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Scheduler-61"><a href="#Scheduler-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">ImageProcessRecord</span><span class="p">()</span>
</span><span id="Scheduler-62"><a href="#Scheduler-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">ipr</span><span class="o">.</span><span class="n">IFChannel</span><span class="p">,</span> <span class="n">ipr</span><span class="o">.</span><span class="n">ImageChannel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ipr.ImageChannel</span>
</span><span id="Scheduler-63"><a href="#Scheduler-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="Scheduler-64"><a href="#Scheduler-64"><span class="linenos"> 64</span></a>
</span><span id="Scheduler-65"><a href="#Scheduler-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">:</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler-66"><a href="#Scheduler-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler-67"><a href="#Scheduler-67"><span class="linenos"> 67</span></a>        <span class="c1"># self._image_naming: naming.DumpImageFileNaming</span>
</span><span id="Scheduler-68"><a href="#Scheduler-68"><span class="linenos"> 68</span></a>        <span class="c1"># self._matrix_naming: naming.DumpMatrixFileNaming</span>
</span><span id="Scheduler-69"><a href="#Scheduler-69"><span class="linenos"> 69</span></a>
</span><span id="Scheduler-70"><a href="#Scheduler-70"><span class="linenos"> 70</span></a>    <span class="nd">@process_decorator</span><span class="p">(</span><span class="s1">&#39;GiB&#39;</span><span class="p">)</span>
</span><span id="Scheduler-71"><a href="#Scheduler-71"><span class="linenos"> 71</span></a>    <span class="k">def</span> <span class="nf">_dump_ipr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scheduler-72"><a href="#Scheduler-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-73"><a href="#Scheduler-73"><span class="linenos"> 73</span></a><span class="sd">        Dumps the internal representation (ipr) to a specified output path.</span>
</span><span id="Scheduler-74"><a href="#Scheduler-74"><span class="linenos"> 74</span></a>
</span><span id="Scheduler-75"><a href="#Scheduler-75"><span class="linenos"> 75</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-76"><a href="#Scheduler-76"><span class="linenos"> 76</span></a><span class="sd">            output_path (str): The path where the ipr will be written.</span>
</span><span id="Scheduler-77"><a href="#Scheduler-77"><span class="linenos"> 77</span></a>
</span><span id="Scheduler-78"><a href="#Scheduler-78"><span class="linenos"> 78</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-79"><a href="#Scheduler-79"><span class="linenos"> 79</span></a><span class="sd">            None</span>
</span><span id="Scheduler-80"><a href="#Scheduler-80"><span class="linenos"> 80</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-81"><a href="#Scheduler-81"><span class="linenos"> 81</span></a>        <span class="n">ipr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span> <span class="n">ipr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="n">extra_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">)</span>
</span><span id="Scheduler-82"><a href="#Scheduler-82"><span class="linenos"> 82</span></a>        <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dump ipr to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
</span><span id="Scheduler-83"><a href="#Scheduler-83"><span class="linenos"> 83</span></a>
</span><span id="Scheduler-84"><a href="#Scheduler-84"><span class="linenos"> 84</span></a>    <span class="nd">@process_decorator</span><span class="p">(</span><span class="s1">&#39;GiB&#39;</span><span class="p">)</span>
</span><span id="Scheduler-85"><a href="#Scheduler-85"><span class="linenos"> 85</span></a>    <span class="k">def</span> <span class="nf">_dump_rpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpi_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scheduler-86"><a href="#Scheduler-86"><span class="linenos"> 86</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-87"><a href="#Scheduler-87"><span class="linenos"> 87</span></a><span class="sd">        Dumps the registration pipeline (rpi) data to a specified path.</span>
</span><span id="Scheduler-88"><a href="#Scheduler-88"><span class="linenos"> 88</span></a>
</span><span id="Scheduler-89"><a href="#Scheduler-89"><span class="linenos"> 89</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-90"><a href="#Scheduler-90"><span class="linenos"> 90</span></a><span class="sd">            rpi_path (str): The path where the rpi data will be saved.</span>
</span><span id="Scheduler-91"><a href="#Scheduler-91"><span class="linenos"> 91</span></a>
</span><span id="Scheduler-92"><a href="#Scheduler-92"><span class="linenos"> 92</span></a><span class="sd">        This method iterates through the files in the pipeline, checks for the existence of various image and mask files,</span>
</span><span id="Scheduler-93"><a href="#Scheduler-93"><span class="linenos"> 93</span></a><span class="sd">        and collects the paths of these files into a dictionary. It then writes this dictionary to an HDF5 file using the</span>
</span><span id="Scheduler-94"><a href="#Scheduler-94"><span class="linenos"> 94</span></a><span class="sd">        `rpi.write` method. Additionally, it logs a message indicating the path where the rpi data was saved.</span>
</span><span id="Scheduler-95"><a href="#Scheduler-95"><span class="linenos"> 95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-96"><a href="#Scheduler-96"><span class="linenos"> 96</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Scheduler-97"><a href="#Scheduler-97"><span class="linenos"> 97</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-98"><a href="#Scheduler-98"><span class="linenos"> 98</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="Scheduler-99"><a href="#Scheduler-99"><span class="linenos"> 99</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="Scheduler-100"><a href="#Scheduler-100"><span class="linenos">100</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-101"><a href="#Scheduler-101"><span class="linenos">101</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="Scheduler-102"><a href="#Scheduler-102"><span class="linenos">102</span></a>
</span><span id="Scheduler-103"><a href="#Scheduler-103"><span class="linenos">103</span></a>                <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Scheduler-104"><a href="#Scheduler-104"><span class="linenos">104</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">):</span>
</span><span id="Scheduler-105"><a href="#Scheduler-105"><span class="linenos">105</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">cell_mask</span>
</span><span id="Scheduler-106"><a href="#Scheduler-106"><span class="linenos">106</span></a>                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">):</span>
</span><span id="Scheduler-107"><a href="#Scheduler-107"><span class="linenos">107</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMaskTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask</span>
</span><span id="Scheduler-108"><a href="#Scheduler-108"><span class="linenos">108</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="Scheduler-109"><a href="#Scheduler-109"><span class="linenos">109</span></a>                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cell_mask_raw</span><span class="p">):</span>
</span><span id="Scheduler-110"><a href="#Scheduler-110"><span class="linenos">110</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMaskRaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">cell_mask_raw</span>
</span><span id="Scheduler-111"><a href="#Scheduler-111"><span class="linenos">111</span></a>                    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">):</span>
</span><span id="Scheduler-112"><a href="#Scheduler-112"><span class="linenos">112</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;CellMaskRawTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span>
</span><span id="Scheduler-113"><a href="#Scheduler-113"><span class="linenos">113</span></a>
</span><span id="Scheduler-114"><a href="#Scheduler-114"><span class="linenos">114</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">registration_image</span><span class="p">):</span>
</span><span id="Scheduler-115"><a href="#Scheduler-115"><span class="linenos">115</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;Image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">registration_image</span>
</span><span id="Scheduler-116"><a href="#Scheduler-116"><span class="linenos">116</span></a>                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">):</span>
</span><span id="Scheduler-117"><a href="#Scheduler-117"><span class="linenos">117</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;Image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transformed_image</span>
</span><span id="Scheduler-118"><a href="#Scheduler-118"><span class="linenos">118</span></a>
</span><span id="Scheduler-119"><a href="#Scheduler-119"><span class="linenos">119</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">):</span>
</span><span id="Scheduler-120"><a href="#Scheduler-120"><span class="linenos">120</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tissue_mask</span>
</span><span id="Scheduler-121"><a href="#Scheduler-121"><span class="linenos">121</span></a>                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">):</span>
</span><span id="Scheduler-122"><a href="#Scheduler-122"><span class="linenos">122</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMaskTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask</span>
</span><span id="Scheduler-123"><a href="#Scheduler-123"><span class="linenos">123</span></a>
</span><span id="Scheduler-124"><a href="#Scheduler-124"><span class="linenos">124</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="Scheduler-125"><a href="#Scheduler-125"><span class="linenos">125</span></a>                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">tissue_mask_raw</span><span class="p">):</span>
</span><span id="Scheduler-126"><a href="#Scheduler-126"><span class="linenos">126</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMaskRaw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">tissue_mask_raw</span>
</span><span id="Scheduler-127"><a href="#Scheduler-127"><span class="linenos">127</span></a>                    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">):</span>
</span><span id="Scheduler-128"><a href="#Scheduler-128"><span class="linenos">128</span></a>                        <span class="n">data</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="s1">&#39;TissueMaskRawTransform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span>
</span><span id="Scheduler-129"><a href="#Scheduler-129"><span class="linenos">129</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Scheduler-130"><a href="#Scheduler-130"><span class="linenos">130</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">][</span><span class="s1">&#39;CellMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_nuclear_mask</span>
</span><span id="Scheduler-131"><a href="#Scheduler-131"><span class="linenos">131</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">][</span><span class="s1">&#39;TissueMask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_tissue_mask</span>
</span><span id="Scheduler-132"><a href="#Scheduler-132"><span class="linenos">132</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">][</span><span class="s1">&#39;CellMaskCorrect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_cell_mask</span>
</span><span id="Scheduler-133"><a href="#Scheduler-133"><span class="linenos">133</span></a>        <span class="n">rpi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">h5_path</span><span class="o">=</span><span class="n">rpi_path</span><span class="p">,</span> <span class="n">extra_images</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="Scheduler-134"><a href="#Scheduler-134"><span class="linenos">134</span></a>        <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dump rpi to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rpi_path</span><span class="p">))</span>
</span><span id="Scheduler-135"><a href="#Scheduler-135"><span class="linenos">135</span></a>
</span><span id="Scheduler-136"><a href="#Scheduler-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="nf">_weights_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="Scheduler-137"><a href="#Scheduler-137"><span class="linenos">137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-138"><a href="#Scheduler-138"><span class="linenos">138</span></a><span class="sd">        Check and download the weights for cell and tissue segmentation.</span>
</span><span id="Scheduler-139"><a href="#Scheduler-139"><span class="linenos">139</span></a>
</span><span id="Scheduler-140"><a href="#Scheduler-140"><span class="linenos">140</span></a><span class="sd">        This method iterates through the files in the `_files` dictionary and checks if each file has cell or tissue</span>
</span><span id="Scheduler-141"><a href="#Scheduler-141"><span class="linenos">141</span></a><span class="sd">        segmentation enabled. If so, it retrieves the corresponding weights path from the configuration and appends the</span>
</span><span id="Scheduler-142"><a href="#Scheduler-142"><span class="linenos">142</span></a><span class="sd">        base name of the weights path to the `weights` list. After collecting all unique weights, it attempts to download</span>
</span><span id="Scheduler-143"><a href="#Scheduler-143"><span class="linenos">143</span></a><span class="sd">        them using the `WeightDownloader` class. If the download fails, a warning is logged.</span>
</span><span id="Scheduler-144"><a href="#Scheduler-144"><span class="linenos">144</span></a>
</span><span id="Scheduler-145"><a href="#Scheduler-145"><span class="linenos">145</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-146"><a href="#Scheduler-146"><span class="linenos">146</span></a><span class="sd">            int: The status code of the weight download operation. 0 indicates success, non-zero indicates failure.</span>
</span><span id="Scheduler-147"><a href="#Scheduler-147"><span class="linenos">147</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-148"><a href="#Scheduler-148"><span class="linenos">148</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler-149"><a href="#Scheduler-149"><span class="linenos">149</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-150"><a href="#Scheduler-150"><span class="linenos">150</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-151"><a href="#Scheduler-151"><span class="linenos">151</span></a>                <span class="n">wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="o">.</span><span class="n">get_weights_path</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="p">)</span>
</span><span id="Scheduler-152"><a href="#Scheduler-152"><span class="linenos">152</span></a>                <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">wp</span><span class="p">))</span>
</span><span id="Scheduler-153"><a href="#Scheduler-153"><span class="linenos">153</span></a>
</span><span id="Scheduler-154"><a href="#Scheduler-154"><span class="linenos">154</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-155"><a href="#Scheduler-155"><span class="linenos">155</span></a>                <span class="n">wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="o">.</span><span class="n">get_weights_path</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="p">)</span>
</span><span id="Scheduler-156"><a href="#Scheduler-156"><span class="linenos">156</span></a>                <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">wp</span><span class="p">))</span>
</span><span id="Scheduler-157"><a href="#Scheduler-157"><span class="linenos">157</span></a>
</span><span id="Scheduler-158"><a href="#Scheduler-158"><span class="linenos">158</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
</span><span id="Scheduler-159"><a href="#Scheduler-159"><span class="linenos">159</span></a>        <span class="n">wd</span> <span class="o">=</span> <span class="n">WeightDownloader</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights_root</span><span class="p">)</span>
</span><span id="Scheduler-160"><a href="#Scheduler-160"><span class="linenos">160</span></a>        <span class="n">flag</span> <span class="o">=</span> <span class="n">wd</span><span class="o">.</span><span class="n">download_weight_by_names</span><span class="p">(</span><span class="n">weight_names</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Scheduler-161"><a href="#Scheduler-161"><span class="linenos">161</span></a>        <span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to retrieve the weights file from local or server&#39;</span><span class="p">)</span>
</span><span id="Scheduler-162"><a href="#Scheduler-162"><span class="linenos">162</span></a>
</span><span id="Scheduler-163"><a href="#Scheduler-163"><span class="linenos">163</span></a>        <span class="k">return</span> <span class="n">flag</span>
</span><span id="Scheduler-164"><a href="#Scheduler-164"><span class="linenos">164</span></a>
</span><span id="Scheduler-165"><a href="#Scheduler-165"><span class="linenos">165</span></a>    <span class="k">def</span> <span class="nf">_data_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="Scheduler-166"><a href="#Scheduler-166"><span class="linenos">166</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-167"><a href="#Scheduler-167"><span class="linenos">167</span></a><span class="sd">        Check the data files for consistency and availability.</span>
</span><span id="Scheduler-168"><a href="#Scheduler-168"><span class="linenos">168</span></a>
</span><span id="Scheduler-169"><a href="#Scheduler-169"><span class="linenos">169</span></a><span class="sd">        This method checks if there are any data files to be analyzed. If no data</span>
</span><span id="Scheduler-170"><a href="#Scheduler-170"><span class="linenos">170</span></a><span class="sd">        is found, it logs a warning and returns an error code. If data is found,</span>
</span><span id="Scheduler-171"><a href="#Scheduler-171"><span class="linenos">171</span></a><span class="sd">        it checks if each file exists and if it is an image. If any file is missing</span>
</span><span id="Scheduler-172"><a href="#Scheduler-172"><span class="linenos">172</span></a><span class="sd">        or not an image, it logs a warning and exits the program. If all files are</span>
</span><span id="Scheduler-173"><a href="#Scheduler-173"><span class="linenos">173</span></a><span class="sd">        valid images, it checks if all images have the same size. If they do, it</span>
</span><span id="Scheduler-174"><a href="#Scheduler-174"><span class="linenos">174</span></a><span class="sd">        logs the image information and returns 0. If they don&#39;t, it logs a warning</span>
</span><span id="Scheduler-175"><a href="#Scheduler-175"><span class="linenos">175</span></a><span class="sd">        and returns an error code. If no image data is found, it logs a message</span>
</span><span id="Scheduler-176"><a href="#Scheduler-176"><span class="linenos">176</span></a><span class="sd">        and returns an error code.</span>
</span><span id="Scheduler-177"><a href="#Scheduler-177"><span class="linenos">177</span></a>
</span><span id="Scheduler-178"><a href="#Scheduler-178"><span class="linenos">178</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-179"><a href="#Scheduler-179"><span class="linenos">179</span></a><span class="sd">            int: An error code indicating the result of the data check.</span>
</span><span id="Scheduler-180"><a href="#Scheduler-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-181"><a href="#Scheduler-181"><span class="linenos">181</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler-182"><a href="#Scheduler-182"><span class="linenos">182</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No data was found that needed to be analyzed&#39;</span><span class="p">)</span>
</span><span id="Scheduler-183"><a href="#Scheduler-183"><span class="linenos">183</span></a>            <span class="k">return</span> <span class="mi">3</span>
</span><span id="Scheduler-184"><a href="#Scheduler-184"><span class="linenos">184</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-185"><a href="#Scheduler-185"><span class="linenos">185</span></a>            <span class="n">wh</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler-186"><a href="#Scheduler-186"><span class="linenos">186</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-187"><a href="#Scheduler-187"><span class="linenos">187</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="Scheduler-188"><a href="#Scheduler-188"><span class="linenos">188</span></a>                    <span class="k">continue</span>
</span><span id="Scheduler-189"><a href="#Scheduler-189"><span class="linenos">189</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="Scheduler-190"><a href="#Scheduler-190"><span class="linenos">190</span></a>                    <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Missing file, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="Scheduler-191"><a href="#Scheduler-191"><span class="linenos">191</span></a>                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">missFile</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># 缺失文件，非正常退出</span>
</span><span id="Scheduler-192"><a href="#Scheduler-192"><span class="linenos">192</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="Scheduler-193"><a href="#Scheduler-193"><span class="linenos">193</span></a>                <span class="n">wh</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">image</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
</span><span id="Scheduler-194"><a href="#Scheduler-194"><span class="linenos">194</span></a>
</span><span id="Scheduler-195"><a href="#Scheduler-195"><span class="linenos">195</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">wh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Scheduler-196"><a href="#Scheduler-196"><span class="linenos">196</span></a>            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler-197"><a href="#Scheduler-197"><span class="linenos">197</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The sizes of the images are inconsistent&#39;</span><span class="p">)</span>
</span><span id="Scheduler-198"><a href="#Scheduler-198"><span class="linenos">198</span></a>                <span class="k">return</span> <span class="mi">1</span>
</span><span id="Scheduler-199"><a href="#Scheduler-199"><span class="linenos">199</span></a>            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler-200"><a href="#Scheduler-200"><span class="linenos">200</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="Scheduler-201"><a href="#Scheduler-201"><span class="linenos">201</span></a>                    <span class="s1">&#39;Images info as (size, channel, depth) == (</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">depth</span><span class="p">))</span>
</span><span id="Scheduler-202"><a href="#Scheduler-202"><span class="linenos">202</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-203"><a href="#Scheduler-203"><span class="linenos">203</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No image data need deal&#39;</span><span class="p">)</span>
</span><span id="Scheduler-204"><a href="#Scheduler-204"><span class="linenos">204</span></a>                <span class="k">return</span> <span class="mi">2</span>
</span><span id="Scheduler-205"><a href="#Scheduler-205"><span class="linenos">205</span></a>        <span class="k">return</span> <span class="mi">0</span>
</span><span id="Scheduler-206"><a href="#Scheduler-206"><span class="linenos">206</span></a>
</span><span id="Scheduler-207"><a href="#Scheduler-207"><span class="linenos">207</span></a>    <span class="k">def</span> <span class="nf">run_segmentation</span><span class="p">(</span>
</span><span id="Scheduler-208"><a href="#Scheduler-208"><span class="linenos">208</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler-209"><a href="#Scheduler-209"><span class="linenos">209</span></a>            <span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-210"><a href="#Scheduler-210"><span class="linenos">210</span></a>            <span class="n">im_path</span><span class="p">,</span>
</span><span id="Scheduler-211"><a href="#Scheduler-211"><span class="linenos">211</span></a>            <span class="n">ts_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler-212"><a href="#Scheduler-212"><span class="linenos">212</span></a>            <span class="n">cs_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler-213"><a href="#Scheduler-213"><span class="linenos">213</span></a>            <span class="n">ts_save_path</span><span class="p">,</span>
</span><span id="Scheduler-214"><a href="#Scheduler-214"><span class="linenos">214</span></a>            <span class="n">cs_save_path</span><span class="p">,</span>
</span><span id="Scheduler-215"><a href="#Scheduler-215"><span class="linenos">215</span></a>            <span class="n">cur_c_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ipr</span><span class="o">.</span><span class="n">ImageChannel</span><span class="p">,</span> <span class="n">ipr</span><span class="o">.</span><span class="n">IFChannel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler-216"><a href="#Scheduler-216"><span class="linenos">216</span></a>    <span class="p">):</span>
</span><span id="Scheduler-217"><a href="#Scheduler-217"><span class="linenos">217</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-218"><a href="#Scheduler-218"><span class="linenos">218</span></a><span class="sd">        Run tissue and cell segmentation on the given image file.</span>
</span><span id="Scheduler-219"><a href="#Scheduler-219"><span class="linenos">219</span></a>
</span><span id="Scheduler-220"><a href="#Scheduler-220"><span class="linenos">220</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-221"><a href="#Scheduler-221"><span class="linenos">221</span></a><span class="sd">            f (ProcFile): The file object containing segmentation settings.</span>
</span><span id="Scheduler-222"><a href="#Scheduler-222"><span class="linenos">222</span></a><span class="sd">            im_path (Path): The path to the image file.</span>
</span><span id="Scheduler-223"><a href="#Scheduler-223"><span class="linenos">223</span></a><span class="sd">            ts_raw_save_path (Path): The path to save the raw tissue segmentation mask.</span>
</span><span id="Scheduler-224"><a href="#Scheduler-224"><span class="linenos">224</span></a><span class="sd">            cs_raw_save_path (Path): The path to save the raw cell segmentation mask.</span>
</span><span id="Scheduler-225"><a href="#Scheduler-225"><span class="linenos">225</span></a><span class="sd">            ts_save_path (str): The path to save the final tissue segmentation mask.</span>
</span><span id="Scheduler-226"><a href="#Scheduler-226"><span class="linenos">226</span></a><span class="sd">            cs_save_path (str): The path to save the final cell segmentation mask.</span>
</span><span id="Scheduler-227"><a href="#Scheduler-227"><span class="linenos">227</span></a><span class="sd">            cur_c_image (object, optional): The current channel image or IF channel image, if available.</span>
</span><span id="Scheduler-228"><a href="#Scheduler-228"><span class="linenos">228</span></a>
</span><span id="Scheduler-229"><a href="#Scheduler-229"><span class="linenos">229</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-230"><a href="#Scheduler-230"><span class="linenos">230</span></a><span class="sd">            None</span>
</span><span id="Scheduler-231"><a href="#Scheduler-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-232"><a href="#Scheduler-232"><span class="linenos">232</span></a>        <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler-233"><a href="#Scheduler-233"><span class="linenos">233</span></a>        <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler-234"><a href="#Scheduler-234"><span class="linenos">234</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-235"><a href="#Scheduler-235"><span class="linenos">235</span></a>            <span class="n">tissue_mask</span> <span class="o">=</span> <span class="n">run_tissue_seg</span><span class="p">(</span>
</span><span id="Scheduler-236"><a href="#Scheduler-236"><span class="linenos">236</span></a>                <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-237"><a href="#Scheduler-237"><span class="linenos">237</span></a>                <span class="n">image_path</span><span class="o">=</span><span class="n">im_path</span><span class="p">,</span>
</span><span id="Scheduler-238"><a href="#Scheduler-238"><span class="linenos">238</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="n">ts_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler-239"><a href="#Scheduler-239"><span class="linenos">239</span></a>                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler-240"><a href="#Scheduler-240"><span class="linenos">240</span></a>                <span class="n">chip_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler-241"><a href="#Scheduler-241"><span class="linenos">241</span></a>                <span class="n">channel_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler-242"><a href="#Scheduler-242"><span class="linenos">242</span></a>            <span class="p">)</span>
</span><span id="Scheduler-243"><a href="#Scheduler-243"><span class="linenos">243</span></a>            <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="n">tissue_mask</span>
</span><span id="Scheduler-244"><a href="#Scheduler-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-245"><a href="#Scheduler-245"><span class="linenos">245</span></a>            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">run_cell_seg</span><span class="p">(</span>
</span><span id="Scheduler-246"><a href="#Scheduler-246"><span class="linenos">246</span></a>                <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-247"><a href="#Scheduler-247"><span class="linenos">247</span></a>                <span class="n">image_path</span><span class="o">=</span><span class="n">im_path</span><span class="p">,</span>
</span><span id="Scheduler-248"><a href="#Scheduler-248"><span class="linenos">248</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="n">cs_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler-249"><a href="#Scheduler-249"><span class="linenos">249</span></a>                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler-250"><a href="#Scheduler-250"><span class="linenos">250</span></a>                <span class="n">channel_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler-251"><a href="#Scheduler-251"><span class="linenos">251</span></a>            <span class="p">)</span>
</span><span id="Scheduler-252"><a href="#Scheduler-252"><span class="linenos">252</span></a>            <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="n">cell_mask</span>
</span><span id="Scheduler-253"><a href="#Scheduler-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-254"><a href="#Scheduler-254"><span class="linenos">254</span></a>            <span class="n">tissue_mask</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">ts_raw_save_path</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler-255"><a href="#Scheduler-255"><span class="linenos">255</span></a>            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">cs_raw_save_path</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler-256"><a href="#Scheduler-256"><span class="linenos">256</span></a>            <span class="n">c_box</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler-257"><a href="#Scheduler-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">cur_c_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-258"><a href="#Scheduler-258"><span class="linenos">258</span></a>                <span class="n">c_box</span> <span class="o">=</span> <span class="n">cur_c_image</span><span class="o">.</span><span class="n">Stitch</span><span class="o">.</span><span class="n">TransformChipBBox</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Scheduler-259"><a href="#Scheduler-259"><span class="linenos">259</span></a>            <span class="n">input_data</span> <span class="o">=</span> <span class="n">MaskManagerInfo</span><span class="p">(</span>
</span><span id="Scheduler-260"><a href="#Scheduler-260"><span class="linenos">260</span></a>                <span class="n">tissue_mask</span><span class="o">=</span><span class="n">tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler-261"><a href="#Scheduler-261"><span class="linenos">261</span></a>                <span class="n">cell_mask</span><span class="o">=</span><span class="n">cell_mask</span><span class="p">,</span>
</span><span id="Scheduler-262"><a href="#Scheduler-262"><span class="linenos">262</span></a>                <span class="n">chip_box</span><span class="o">=</span><span class="n">c_box</span><span class="p">,</span>
</span><span id="Scheduler-263"><a href="#Scheduler-263"><span class="linenos">263</span></a>                <span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scheduler-264"><a href="#Scheduler-264"><span class="linenos">264</span></a>                <span class="n">stain_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span>
</span><span id="Scheduler-265"><a href="#Scheduler-265"><span class="linenos">265</span></a>            <span class="p">)</span>
</span><span id="Scheduler-266"><a href="#Scheduler-266"><span class="linenos">266</span></a>            <span class="n">btcm</span> <span class="o">=</span> <span class="n">BestTissueCellMask</span><span class="o">.</span><span class="n">get_best_tissue_cell_mask</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="Scheduler-267"><a href="#Scheduler-267"><span class="linenos">267</span></a>            <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="n">btcm</span><span class="o">.</span><span class="n">best_tissue_mask</span>
</span><span id="Scheduler-268"><a href="#Scheduler-268"><span class="linenos">268</span></a>            <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="n">btcm</span><span class="o">.</span><span class="n">best_cell_mask</span>
</span><span id="Scheduler-269"><a href="#Scheduler-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">final_cell_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-270"><a href="#Scheduler-270"><span class="linenos">270</span></a>            <span class="n">cbimwrite</span><span class="p">(</span>
</span><span id="Scheduler-271"><a href="#Scheduler-271"><span class="linenos">271</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="n">cs_save_path</span><span class="p">,</span>
</span><span id="Scheduler-272"><a href="#Scheduler-272"><span class="linenos">272</span></a>                <span class="n">files</span><span class="o">=</span><span class="n">final_cell_mask</span>
</span><span id="Scheduler-273"><a href="#Scheduler-273"><span class="linenos">273</span></a>            <span class="p">)</span>
</span><span id="Scheduler-274"><a href="#Scheduler-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="n">final_tissue_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-275"><a href="#Scheduler-275"><span class="linenos">275</span></a>            <span class="n">cbimwrite</span><span class="p">(</span>
</span><span id="Scheduler-276"><a href="#Scheduler-276"><span class="linenos">276</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="n">ts_save_path</span><span class="p">,</span>
</span><span id="Scheduler-277"><a href="#Scheduler-277"><span class="linenos">277</span></a>                <span class="n">files</span><span class="o">=</span><span class="n">final_tissue_mask</span>
</span><span id="Scheduler-278"><a href="#Scheduler-278"><span class="linenos">278</span></a>            <span class="p">)</span>
</span><span id="Scheduler-279"><a href="#Scheduler-279"><span class="linenos">279</span></a>
</span><span id="Scheduler-280"><a href="#Scheduler-280"><span class="linenos">280</span></a>    <span class="k">def</span> <span class="nf">run_single_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scheduler-281"><a href="#Scheduler-281"><span class="linenos">281</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-282"><a href="#Scheduler-282"><span class="linenos">282</span></a><span class="sd">        Process each single image in the pipeline.</span>
</span><span id="Scheduler-283"><a href="#Scheduler-283"><span class="linenos">283</span></a><span class="sd">        </span>
</span><span id="Scheduler-284"><a href="#Scheduler-284"><span class="linenos">284</span></a><span class="sd">        This method iterates over each image file, performs necessary transformations,</span>
</span><span id="Scheduler-285"><a href="#Scheduler-285"><span class="linenos">285</span></a><span class="sd">        and applies segmentation. It handles both cases where IPR data is available and</span>
</span><span id="Scheduler-286"><a href="#Scheduler-286"><span class="linenos">286</span></a><span class="sd">        where it is not.</span>
</span><span id="Scheduler-287"><a href="#Scheduler-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-288"><a href="#Scheduler-288"><span class="linenos">288</span></a>        <span class="c1"># Iterate over each file in the dataset</span>
</span><span id="Scheduler-289"><a href="#Scheduler-289"><span class="linenos">289</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-290"><a href="#Scheduler-290"><span class="linenos">290</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  File[</span><span class="si">{}</span><span class="s1">] CellBin, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="Scheduler-291"><a href="#Scheduler-291"><span class="linenos">291</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="Scheduler-292"><a href="#Scheduler-292"><span class="linenos">292</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="Scheduler-293"><a href="#Scheduler-293"><span class="linenos">293</span></a>                <span class="n">cur_f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-294"><a href="#Scheduler-294"><span class="linenos">294</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-295"><a href="#Scheduler-295"><span class="linenos">295</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="Scheduler-296"><a href="#Scheduler-296"><span class="linenos">296</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler-297"><a href="#Scheduler-297"><span class="linenos">297</span></a>                <span class="p">)</span>
</span><span id="Scheduler-298"><a href="#Scheduler-298"><span class="linenos">298</span></a>                <span class="n">cur_c_image</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler-299"><a href="#Scheduler-299"><span class="linenos">299</span></a>                <span class="c1"># Copy the stitched image</span>
</span><span id="Scheduler-300"><a href="#Scheduler-300"><span class="linenos">300</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">)</span>
</span><span id="Scheduler-301"><a href="#Scheduler-301"><span class="linenos">301</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-302"><a href="#Scheduler-302"><span class="linenos">302</span></a>                    <span class="c1"># IPR data is provided</span>
</span><span id="Scheduler-303"><a href="#Scheduler-303"><span class="linenos">303</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">tech</span> <span class="o">==</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="p">:</span>
</span><span id="Scheduler-304"><a href="#Scheduler-304"><span class="linenos">304</span></a>                        <span class="c1"># TODO: handle two versions of IPR</span>
</span><span id="Scheduler-305"><a href="#Scheduler-305"><span class="linenos">305</span></a>                        <span class="n">qc_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span><span class="o">.</span><span class="n">QCInfo</span>
</span><span id="Scheduler-306"><a href="#Scheduler-306"><span class="linenos">306</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QcPassFlag&#39;</span><span class="p">):</span>
</span><span id="Scheduler-307"><a href="#Scheduler-307"><span class="linenos">307</span></a>                            <span class="n">qc_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QcPassFlag&#39;</span><span class="p">)</span>
</span><span id="Scheduler-308"><a href="#Scheduler-308"><span class="linenos">308</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-309"><a href="#Scheduler-309"><span class="linenos">309</span></a>                            <span class="n">qc_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QCPassFlag&#39;</span><span class="p">)</span>
</span><span id="Scheduler-310"><a href="#Scheduler-310"><span class="linenos">310</span></a>                        <span class="k">if</span> <span class="n">qc_flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Cannot register under current conditions</span>
</span><span id="Scheduler-311"><a href="#Scheduler-311"><span class="linenos">311</span></a>                            <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Image QC not pass, cannot deal this pipeline&#39;</span><span class="p">)</span>
</span><span id="Scheduler-312"><a href="#Scheduler-312"><span class="linenos">312</span></a>                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">qcFail</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="Scheduler-313"><a href="#Scheduler-313"><span class="linenos">313</span></a>                    <span class="c1"># Perform transform operations: Transform &gt; Segmentation &gt; Mask merge &amp; expand</span>
</span><span id="Scheduler-314"><a href="#Scheduler-314"><span class="linenos">314</span></a>                    <span class="n">cur_c_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span>
</span><span id="Scheduler-315"><a href="#Scheduler-315"><span class="linenos">315</span></a>                    <span class="c1"># Transform input and output</span>
</span><span id="Scheduler-316"><a href="#Scheduler-316"><span class="linenos">316</span></a>                    <span class="n">run_transform</span><span class="p">(</span>
</span><span id="Scheduler-317"><a href="#Scheduler-317"><span class="linenos">317</span></a>                        <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-318"><a href="#Scheduler-318"><span class="linenos">318</span></a>                        <span class="n">channel_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">,</span>
</span><span id="Scheduler-319"><a href="#Scheduler-319"><span class="linenos">319</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler-320"><a href="#Scheduler-320"><span class="linenos">320</span></a>                        <span class="n">files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span>
</span><span id="Scheduler-321"><a href="#Scheduler-321"><span class="linenos">321</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span><span class="p">,</span>
</span><span id="Scheduler-322"><a href="#Scheduler-322"><span class="linenos">322</span></a>                        <span class="n">if_track</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">trackline</span><span class="p">,</span>
</span><span id="Scheduler-323"><a href="#Scheduler-323"><span class="linenos">323</span></a>                        <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research_mode</span><span class="p">,</span>
</span><span id="Scheduler-324"><a href="#Scheduler-324"><span class="linenos">324</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-325"><a href="#Scheduler-325"><span class="linenos">325</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">run_segmentation</span><span class="p">(</span>
</span><span id="Scheduler-326"><a href="#Scheduler-326"><span class="linenos">326</span></a>                        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-327"><a href="#Scheduler-327"><span class="linenos">327</span></a>                        <span class="n">im_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">,</span>
</span><span id="Scheduler-328"><a href="#Scheduler-328"><span class="linenos">328</span></a>                        <span class="n">ts_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler-329"><a href="#Scheduler-329"><span class="linenos">329</span></a>                        <span class="n">cs_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler-330"><a href="#Scheduler-330"><span class="linenos">330</span></a>                        <span class="n">ts_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler-331"><a href="#Scheduler-331"><span class="linenos">331</span></a>                        <span class="n">cs_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">,</span>
</span><span id="Scheduler-332"><a href="#Scheduler-332"><span class="linenos">332</span></a>                        <span class="n">cur_c_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler-333"><a href="#Scheduler-333"><span class="linenos">333</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-334"><a href="#Scheduler-334"><span class="linenos">334</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-335"><a href="#Scheduler-335"><span class="linenos">335</span></a>                    <span class="c1"># IPR data is not provided, perform segmentation directly on the input image</span>
</span><span id="Scheduler-336"><a href="#Scheduler-336"><span class="linenos">336</span></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">,</span> <span class="n">cur_f_name</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">)</span>
</span><span id="Scheduler-337"><a href="#Scheduler-337"><span class="linenos">337</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">run_segmentation</span><span class="p">(</span>
</span><span id="Scheduler-338"><a href="#Scheduler-338"><span class="linenos">338</span></a>                        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-339"><a href="#Scheduler-339"><span class="linenos">339</span></a>                        <span class="n">im_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">,</span>
</span><span id="Scheduler-340"><a href="#Scheduler-340"><span class="linenos">340</span></a>                        <span class="n">ts_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler-341"><a href="#Scheduler-341"><span class="linenos">341</span></a>                        <span class="n">cs_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler-342"><a href="#Scheduler-342"><span class="linenos">342</span></a>                        <span class="n">ts_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler-343"><a href="#Scheduler-343"><span class="linenos">343</span></a>                        <span class="n">cs_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">,</span>
</span><span id="Scheduler-344"><a href="#Scheduler-344"><span class="linenos">344</span></a>                        <span class="n">cur_c_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler-345"><a href="#Scheduler-345"><span class="linenos">345</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-346"><a href="#Scheduler-346"><span class="linenos">346</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-347"><a href="#Scheduler-347"><span class="linenos">347</span></a>                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-348"><a href="#Scheduler-348"><span class="linenos">348</span></a>                    <span class="n">cur_m_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-349"><a href="#Scheduler-349"><span class="linenos">349</span></a>                        <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-350"><a href="#Scheduler-350"><span class="linenos">350</span></a>                        <span class="n">m_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Scheduler-351"><a href="#Scheduler-351"><span class="linenos">351</span></a>                        <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="Scheduler-352"><a href="#Scheduler-352"><span class="linenos">352</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-353"><a href="#Scheduler-353"><span class="linenos">353</span></a>                    <span class="n">cm</span> <span class="o">=</span> <span class="n">extract4stitched</span><span class="p">(</span>
</span><span id="Scheduler-354"><a href="#Scheduler-354"><span class="linenos">354</span></a>                        <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-355"><a href="#Scheduler-355"><span class="linenos">355</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler-356"><a href="#Scheduler-356"><span class="linenos">356</span></a>                        <span class="n">m_naming</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="p">,</span>
</span><span id="Scheduler-357"><a href="#Scheduler-357"><span class="linenos">357</span></a>                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler-358"><a href="#Scheduler-358"><span class="linenos">358</span></a>                        <span class="n">detect_feature</span><span class="o">=</span><span class="kc">False</span>
</span><span id="Scheduler-359"><a href="#Scheduler-359"><span class="linenos">359</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-360"><a href="#Scheduler-360"><span class="linenos">360</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-361"><a href="#Scheduler-361"><span class="linenos">361</span></a>                        <span class="n">run_tissue_seg</span><span class="p">(</span>
</span><span id="Scheduler-362"><a href="#Scheduler-362"><span class="linenos">362</span></a>                            <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-363"><a href="#Scheduler-363"><span class="linenos">363</span></a>                            <span class="n">image_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">heatmap</span><span class="p">,</span>
</span><span id="Scheduler-364"><a href="#Scheduler-364"><span class="linenos">364</span></a>                            <span class="n">save_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler-365"><a href="#Scheduler-365"><span class="linenos">365</span></a>                            <span class="n">chip_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler-366"><a href="#Scheduler-366"><span class="linenos">366</span></a>                            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler-367"><a href="#Scheduler-367"><span class="linenos">367</span></a>                        <span class="p">)</span>
</span><span id="Scheduler-368"><a href="#Scheduler-368"><span class="linenos">368</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler-369"><a href="#Scheduler-369"><span class="linenos">369</span></a>                        <span class="n">run_cell_seg</span><span class="p">(</span>
</span><span id="Scheduler-370"><a href="#Scheduler-370"><span class="linenos">370</span></a>                            <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-371"><a href="#Scheduler-371"><span class="linenos">371</span></a>                            <span class="n">image_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">heatmap</span><span class="p">,</span>
</span><span id="Scheduler-372"><a href="#Scheduler-372"><span class="linenos">372</span></a>                            <span class="n">save_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span>
</span><span id="Scheduler-373"><a href="#Scheduler-373"><span class="linenos">373</span></a>                            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler-374"><a href="#Scheduler-374"><span class="linenos">374</span></a>                        <span class="p">)</span>
</span><span id="Scheduler-375"><a href="#Scheduler-375"><span class="linenos">375</span></a>
</span><span id="Scheduler-376"><a href="#Scheduler-376"><span class="linenos">376</span></a>    <span class="k">def</span> <span class="nf">run_mul_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scheduler-377"><a href="#Scheduler-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-378"><a href="#Scheduler-378"><span class="linenos">378</span></a><span class="sd">        Process multiple images for registration.</span>
</span><span id="Scheduler-379"><a href="#Scheduler-379"><span class="linenos">379</span></a>
</span><span id="Scheduler-380"><a href="#Scheduler-380"><span class="linenos">380</span></a><span class="sd">        This method handles the registration of multiple images. It iterates over</span>
</span><span id="Scheduler-381"><a href="#Scheduler-381"><span class="linenos">381</span></a><span class="sd">        the files in self._files and processes only the images. If the image is</span>
</span><span id="Scheduler-382"><a href="#Scheduler-382"><span class="linenos">382</span></a><span class="sd">        registered, it performs the registration process. If not, it transforms</span>
</span><span id="Scheduler-383"><a href="#Scheduler-383"><span class="linenos">383</span></a><span class="sd">        the image to a registered format.</span>
</span><span id="Scheduler-384"><a href="#Scheduler-384"><span class="linenos">384</span></a>
</span><span id="Scheduler-385"><a href="#Scheduler-385"><span class="linenos">385</span></a><span class="sd">        :return: None</span>
</span><span id="Scheduler-386"><a href="#Scheduler-386"><span class="linenos">386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-387"><a href="#Scheduler-387"><span class="linenos">387</span></a>        <span class="c1"># 这里涉及多张图的配合，因为是配准。所以默认但张图的处理都结束了</span>
</span><span id="Scheduler-388"><a href="#Scheduler-388"><span class="linenos">388</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-389"><a href="#Scheduler-389"><span class="linenos">389</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="Scheduler-390"><a href="#Scheduler-390"><span class="linenos">390</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  File[</span><span class="si">{}</span><span class="s1">] CellBin, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="Scheduler-391"><a href="#Scheduler-391"><span class="linenos">391</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="Scheduler-392"><a href="#Scheduler-392"><span class="linenos">392</span></a>                <span class="n">cur_f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-393"><a href="#Scheduler-393"><span class="linenos">393</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-394"><a href="#Scheduler-394"><span class="linenos">394</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="Scheduler-395"><a href="#Scheduler-395"><span class="linenos">395</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler-396"><a href="#Scheduler-396"><span class="linenos">396</span></a>                <span class="p">)</span>
</span><span id="Scheduler-397"><a href="#Scheduler-397"><span class="linenos">397</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-398"><a href="#Scheduler-398"><span class="linenos">398</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler-399"><a href="#Scheduler-399"><span class="linenos">399</span></a>                        <span class="k">continue</span>
</span><span id="Scheduler-400"><a href="#Scheduler-400"><span class="linenos">400</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span>
</span><span id="Scheduler-401"><a href="#Scheduler-401"><span class="linenos">401</span></a>                        <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span><span class="p">]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler-402"><a href="#Scheduler-402"><span class="linenos">402</span></a>                        <span class="k">continue</span>
</span><span id="Scheduler-403"><a href="#Scheduler-403"><span class="linenos">403</span></a>                    <span class="n">run_register</span><span class="p">(</span>
</span><span id="Scheduler-404"><a href="#Scheduler-404"><span class="linenos">404</span></a>                        <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler-405"><a href="#Scheduler-405"><span class="linenos">405</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span><span class="p">,</span>
</span><span id="Scheduler-406"><a href="#Scheduler-406"><span class="linenos">406</span></a>                        <span class="n">files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span>
</span><span id="Scheduler-407"><a href="#Scheduler-407"><span class="linenos">407</span></a>                        <span class="n">channel_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">,</span>
</span><span id="Scheduler-408"><a href="#Scheduler-408"><span class="linenos">408</span></a>                        <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="Scheduler-409"><a href="#Scheduler-409"><span class="linenos">409</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler-410"><a href="#Scheduler-410"><span class="linenos">410</span></a>                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler-411"><a href="#Scheduler-411"><span class="linenos">411</span></a>                        <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
</span><span id="Scheduler-412"><a href="#Scheduler-412"><span class="linenos">412</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-413"><a href="#Scheduler-413"><span class="linenos">413</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler-414"><a href="#Scheduler-414"><span class="linenos">414</span></a>                        <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span><span class="p">]</span>
</span><span id="Scheduler-415"><a href="#Scheduler-415"><span class="linenos">415</span></a>                        <span class="k">if</span> <span class="n">fixed</span><span class="o">.</span><span class="n">is_matrix</span><span class="p">:</span>
</span><span id="Scheduler-416"><a href="#Scheduler-416"><span class="linenos">416</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span><span class="p">]</span>
</span><span id="Scheduler-417"><a href="#Scheduler-417"><span class="linenos">417</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-418"><a href="#Scheduler-418"><span class="linenos">418</span></a>                    <span class="n">transform_to_register</span><span class="p">(</span>
</span><span id="Scheduler-419"><a href="#Scheduler-419"><span class="linenos">419</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span>
</span><span id="Scheduler-420"><a href="#Scheduler-420"><span class="linenos">420</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-421"><a href="#Scheduler-421"><span class="linenos">421</span></a>
</span><span id="Scheduler-422"><a href="#Scheduler-422"><span class="linenos">422</span></a>    <span class="k">def</span> <span class="nf">run_merge_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scheduler-423"><a href="#Scheduler-423"><span class="linenos">423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-424"><a href="#Scheduler-424"><span class="linenos">424</span></a><span class="sd">        This method processes and merges cell masks for each molecular classification file.</span>
</span><span id="Scheduler-425"><a href="#Scheduler-425"><span class="linenos">425</span></a><span class="sd">        It extracts the cell mask from the file, determines the naming convention, and merges</span>
</span><span id="Scheduler-426"><a href="#Scheduler-426"><span class="linenos">426</span></a><span class="sd">        the masks if necessary. Finally, it corrects the cell mask using the fast correction</span>
</span><span id="Scheduler-427"><a href="#Scheduler-427"><span class="linenos">427</span></a><span class="sd">        algorithm and saves the results.</span>
</span><span id="Scheduler-428"><a href="#Scheduler-428"><span class="linenos">428</span></a>
</span><span id="Scheduler-429"><a href="#Scheduler-429"><span class="linenos">429</span></a><span class="sd">        :return: None</span>
</span><span id="Scheduler-430"><a href="#Scheduler-430"><span class="linenos">430</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-431"><a href="#Scheduler-431"><span class="linenos">431</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecular_classify_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-432"><a href="#Scheduler-432"><span class="linenos">432</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  Extract[</span><span class="si">{}</span><span class="s1">], </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
</span><span id="Scheduler-433"><a href="#Scheduler-433"><span class="linenos">433</span></a>            <span class="n">picked_mask</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">cell_mask</span>
</span><span id="Scheduler-434"><a href="#Scheduler-434"><span class="linenos">434</span></a>            <span class="n">final_nuclear_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_nuclear_mask</span>
</span><span id="Scheduler-435"><a href="#Scheduler-435"><span class="linenos">435</span></a>            <span class="n">final_t_mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_tissue_mask</span>
</span><span id="Scheduler-436"><a href="#Scheduler-436"><span class="linenos">436</span></a>            <span class="n">final_cell_mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_cell_mask</span>
</span><span id="Scheduler-437"><a href="#Scheduler-437"><span class="linenos">437</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">picked_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Just one mask</span>
</span><span id="Scheduler-438"><a href="#Scheduler-438"><span class="linenos">438</span></a>                <span class="n">im_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-439"><a href="#Scheduler-439"><span class="linenos">439</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-440"><a href="#Scheduler-440"><span class="linenos">440</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="Scheduler-441"><a href="#Scheduler-441"><span class="linenos">441</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler-442"><a href="#Scheduler-442"><span class="linenos">442</span></a>                <span class="p">)</span>
</span><span id="Scheduler-443"><a href="#Scheduler-443"><span class="linenos">443</span></a>                <span class="n">to_fast</span> <span class="o">=</span> <span class="n">final_nuclear_path</span>
</span><span id="Scheduler-444"><a href="#Scheduler-444"><span class="linenos">444</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Two masks, assuming the first is the nuclear mask and the second is the membrane mask</span>
</span><span id="Scheduler-445"><a href="#Scheduler-445"><span class="linenos">445</span></a>                <span class="n">im_naming1</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-446"><a href="#Scheduler-446"><span class="linenos">446</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-447"><a href="#Scheduler-447"><span class="linenos">447</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="Scheduler-448"><a href="#Scheduler-448"><span class="linenos">448</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler-449"><a href="#Scheduler-449"><span class="linenos">449</span></a>                <span class="p">)</span>
</span><span id="Scheduler-450"><a href="#Scheduler-450"><span class="linenos">450</span></a>                <span class="n">im_naming2</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-451"><a href="#Scheduler-451"><span class="linenos">451</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-452"><a href="#Scheduler-452"><span class="linenos">452</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="Scheduler-453"><a href="#Scheduler-453"><span class="linenos">453</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler-454"><a href="#Scheduler-454"><span class="linenos">454</span></a>                <span class="p">)</span>
</span><span id="Scheduler-455"><a href="#Scheduler-455"><span class="linenos">455</span></a>                <span class="k">if</span> <span class="n">im_naming1</span><span class="o">.</span><span class="n">stain_type</span> <span class="o">==</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="Scheduler-456"><a href="#Scheduler-456"><span class="linenos">456</span></a>                    <span class="n">im_naming</span> <span class="o">=</span> <span class="n">im_naming2</span>
</span><span id="Scheduler-457"><a href="#Scheduler-457"><span class="linenos">457</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-458"><a href="#Scheduler-458"><span class="linenos">458</span></a>                    <span class="n">im_naming</span> <span class="o">=</span> <span class="n">im_naming1</span>
</span><span id="Scheduler-459"><a href="#Scheduler-459"><span class="linenos">459</span></a>                <span class="n">merged_cell_mask_path</span> <span class="o">=</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask_merged</span>
</span><span id="Scheduler-460"><a href="#Scheduler-460"><span class="linenos">460</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">merged_cell_mask_path</span><span class="p">):</span>
</span><span id="Scheduler-461"><a href="#Scheduler-461"><span class="linenos">461</span></a>                    <span class="kn">from</span> <span class="nn">cellbin2.contrib.mask_manager</span> <span class="kn">import</span> <span class="n">merge_cell_mask</span>
</span><span id="Scheduler-462"><a href="#Scheduler-462"><span class="linenos">462</span></a>                    <span class="c1"># TODO: Temporarily assume im_naming1 is the nuclear segmentation result,</span>
</span><span id="Scheduler-463"><a href="#Scheduler-463"><span class="linenos">463</span></a>                    <span class="c1">#       im_naming2 is the membrane segmentation result</span>
</span><span id="Scheduler-464"><a href="#Scheduler-464"><span class="linenos">464</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">im_naming1</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">im_naming2</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler-465"><a href="#Scheduler-465"><span class="linenos">465</span></a>                        <span class="k">continue</span>
</span><span id="Scheduler-466"><a href="#Scheduler-466"><span class="linenos">466</span></a>                    <span class="n">mask1</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">im_naming1</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler-467"><a href="#Scheduler-467"><span class="linenos">467</span></a>                    <span class="n">mask2</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">im_naming2</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler-468"><a href="#Scheduler-468"><span class="linenos">468</span></a>                    <span class="n">merged_mask</span> <span class="o">=</span> <span class="n">merge_cell_mask</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">)</span>
</span><span id="Scheduler-469"><a href="#Scheduler-469"><span class="linenos">469</span></a>                    <span class="n">cbimwrite</span><span class="p">(</span><span class="n">merged_cell_mask_path</span><span class="p">,</span> <span class="n">merged_mask</span><span class="p">)</span>
</span><span id="Scheduler-470"><a href="#Scheduler-470"><span class="linenos">470</span></a>                <span class="n">to_fast</span> <span class="o">=</span> <span class="n">merged_cell_mask_path</span>
</span><span id="Scheduler-471"><a href="#Scheduler-471"><span class="linenos">471</span></a>            <span class="k">if</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler-472"><a href="#Scheduler-472"><span class="linenos">472</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">final_nuclear_path</span><span class="p">)</span>
</span><span id="Scheduler-473"><a href="#Scheduler-473"><span class="linenos">473</span></a>            <span class="k">if</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler-474"><a href="#Scheduler-474"><span class="linenos">474</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">im_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">,</span> <span class="n">final_t_mask_path</span><span class="p">)</span>
</span><span id="Scheduler-475"><a href="#Scheduler-475"><span class="linenos">475</span></a>            <span class="c1"># Here, we have the final cell mask and final tissue mask</span>
</span><span id="Scheduler-476"><a href="#Scheduler-476"><span class="linenos">476</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">final_cell_mask_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_fast</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler-477"><a href="#Scheduler-477"><span class="linenos">477</span></a>                <span class="n">fast_mask</span> <span class="o">=</span> <span class="n">run_fast_correct</span><span class="p">(</span>
</span><span id="Scheduler-478"><a href="#Scheduler-478"><span class="linenos">478</span></a>                    <span class="n">mask_path</span><span class="o">=</span><span class="n">to_fast</span><span class="p">,</span>
</span><span id="Scheduler-479"><a href="#Scheduler-479"><span class="linenos">479</span></a>                    <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_correct</span><span class="o">.</span><span class="n">expand_r</span><span class="p">,</span>
</span><span id="Scheduler-480"><a href="#Scheduler-480"><span class="linenos">480</span></a>                    <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_correct</span><span class="o">.</span><span class="n">process</span>
</span><span id="Scheduler-481"><a href="#Scheduler-481"><span class="linenos">481</span></a>                <span class="p">)</span>
</span><span id="Scheduler-482"><a href="#Scheduler-482"><span class="linenos">482</span></a>                <span class="n">cbimwrite</span><span class="p">(</span><span class="n">final_cell_mask_path</span><span class="p">,</span> <span class="n">fast_mask</span><span class="p">)</span>
</span><span id="Scheduler-483"><a href="#Scheduler-483"><span class="linenos">483</span></a>
</span><span id="Scheduler-484"><a href="#Scheduler-484"><span class="linenos">484</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scheduler-485"><a href="#Scheduler-485"><span class="linenos">485</span></a>            <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scheduler-486"><a href="#Scheduler-486"><span class="linenos">486</span></a>            <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ipr_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scheduler-487"><a href="#Scheduler-487"><span class="linenos">487</span></a>            <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">research_mode</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="Scheduler-488"><a href="#Scheduler-488"><span class="linenos">488</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-489"><a href="#Scheduler-489"><span class="linenos">489</span></a><span class="sd">        Run the main pipeline for processing the images.</span>
</span><span id="Scheduler-490"><a href="#Scheduler-490"><span class="linenos">490</span></a>
</span><span id="Scheduler-491"><a href="#Scheduler-491"><span class="linenos">491</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-492"><a href="#Scheduler-492"><span class="linenos">492</span></a><span class="sd">            chip_no (str): The serial number of the chip.</span>
</span><span id="Scheduler-493"><a href="#Scheduler-493"><span class="linenos">493</span></a><span class="sd">            input_image (str): The path to the input image file.</span>
</span><span id="Scheduler-494"><a href="#Scheduler-494"><span class="linenos">494</span></a><span class="sd">            stain_type (str): The type of stain used in the image.</span>
</span><span id="Scheduler-495"><a href="#Scheduler-495"><span class="linenos">495</span></a><span class="sd">            param_file (str): The path to the parameter file.</span>
</span><span id="Scheduler-496"><a href="#Scheduler-496"><span class="linenos">496</span></a><span class="sd">            output_path (str): The directory where the output files will be saved.</span>
</span><span id="Scheduler-497"><a href="#Scheduler-497"><span class="linenos">497</span></a><span class="sd">            ipr_path (str): The path to the image process record file.</span>
</span><span id="Scheduler-498"><a href="#Scheduler-498"><span class="linenos">498</span></a><span class="sd">            matrix_path (str): The path to the matrix file.</span>
</span><span id="Scheduler-499"><a href="#Scheduler-499"><span class="linenos">499</span></a><span class="sd">            kit (str): The type of kit used (e.g., Transcriptomics, Protein).</span>
</span><span id="Scheduler-500"><a href="#Scheduler-500"><span class="linenos">500</span></a><span class="sd">            debug (bool): Flag to enable debug mode.</span>
</span><span id="Scheduler-501"><a href="#Scheduler-501"><span class="linenos">501</span></a><span class="sd">            research_mode (bool): Flag to enable research mode.</span>
</span><span id="Scheduler-502"><a href="#Scheduler-502"><span class="linenos">502</span></a>
</span><span id="Scheduler-503"><a href="#Scheduler-503"><span class="linenos">503</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-504"><a href="#Scheduler-504"><span class="linenos">504</span></a><span class="sd">            None</span>
</span><span id="Scheduler-505"><a href="#Scheduler-505"><span class="linenos">505</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-506"><a href="#Scheduler-506"><span class="linenos">506</span></a>
</span><span id="Scheduler-507"><a href="#Scheduler-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">output_path</span>
</span><span id="Scheduler-508"><a href="#Scheduler-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="Scheduler-509"><a href="#Scheduler-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">research_mode</span> <span class="o">=</span> <span class="n">research_mode</span>
</span><span id="Scheduler-510"><a href="#Scheduler-510"><span class="linenos">510</span></a>        <span class="c1"># Load chip information</span>
</span><span id="Scheduler-511"><a href="#Scheduler-511"><span class="linenos">511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">parse_info</span><span class="p">(</span><span class="n">chip_no</span><span class="p">)</span>
</span><span id="Scheduler-512"><a href="#Scheduler-512"><span class="linenos">512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="Scheduler-513"><a href="#Scheduler-513"><span class="linenos">513</span></a>
</span><span id="Scheduler-514"><a href="#Scheduler-514"><span class="linenos">514</span></a>        <span class="c1"># Load data</span>
</span><span id="Scheduler-515"><a href="#Scheduler-515"><span class="linenos">515</span></a>        <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span>
</span><span id="Scheduler-516"><a href="#Scheduler-516"><span class="linenos">516</span></a>            <span class="n">file_path</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span>
</span><span id="Scheduler-517"><a href="#Scheduler-517"><span class="linenos">517</span></a>            <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler-518"><a href="#Scheduler-518"><span class="linenos">518</span></a>            <span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">input_json</span>
</span><span id="Scheduler-519"><a href="#Scheduler-519"><span class="linenos">519</span></a>        <span class="p">)</span>
</span><span id="Scheduler-520"><a href="#Scheduler-520"><span class="linenos">520</span></a>
</span><span id="Scheduler-521"><a href="#Scheduler-521"><span class="linenos">521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scheduler-522"><a href="#Scheduler-522"><span class="linenos">522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">molecular_classify_files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span>
</span><span id="Scheduler-523"><a href="#Scheduler-523"><span class="linenos">523</span></a>        <span class="n">pp</span><span class="o">.</span><span class="n">print_files_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">)</span>
</span><span id="Scheduler-524"><a href="#Scheduler-524"><span class="linenos">524</span></a>
</span><span id="Scheduler-525"><a href="#Scheduler-525"><span class="linenos">525</span></a>        <span class="c1"># Exit if data validation fails</span>
</span><span id="Scheduler-526"><a href="#Scheduler-526"><span class="linenos">526</span></a>        <span class="n">flag1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_check</span><span class="p">()</span>
</span><span id="Scheduler-527"><a href="#Scheduler-527"><span class="linenos">527</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
</span><span id="Scheduler-528"><a href="#Scheduler-528"><span class="linenos">528</span></a>            <span class="k">return</span> <span class="mi">1</span>
</span><span id="Scheduler-529"><a href="#Scheduler-529"><span class="linenos">529</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Scheduler-530"><a href="#Scheduler-530"><span class="linenos">530</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ipr_path</span><span class="p">):</span>
</span><span id="Scheduler-531"><a href="#Scheduler-531"><span class="linenos">531</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ipr_path</span><span class="p">)</span>
</span><span id="Scheduler-532"><a href="#Scheduler-532"><span class="linenos">532</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-533"><a href="#Scheduler-533"><span class="linenos">533</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No existing ipr founded, assumes qc has not been done before&quot;</span><span class="p">)</span>
</span><span id="Scheduler-534"><a href="#Scheduler-534"><span class="linenos">534</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Scheduler-535"><a href="#Scheduler-535"><span class="linenos">535</span></a>
</span><span id="Scheduler-536"><a href="#Scheduler-536"><span class="linenos">536</span></a>        <span class="c1"># Load model</span>
</span><span id="Scheduler-537"><a href="#Scheduler-537"><span class="linenos">537</span></a>        <span class="n">flag2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_check</span><span class="p">()</span>
</span><span id="Scheduler-538"><a href="#Scheduler-538"><span class="linenos">538</span></a>        <span class="k">if</span> <span class="n">flag2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Scheduler-539"><a href="#Scheduler-539"><span class="linenos">539</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Scheduler-540"><a href="#Scheduler-540"><span class="linenos">540</span></a>
</span><span id="Scheduler-541"><a href="#Scheduler-541"><span class="linenos">541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_single_image</span><span class="p">()</span>  <span class="c1"># Process a single image (transform -&gt; tissue seg -&gt; cellseg)</span>
</span><span id="Scheduler-542"><a href="#Scheduler-542"><span class="linenos">542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_mul_image</span><span class="p">()</span>  <span class="c1"># Register images</span>
</span><span id="Scheduler-543"><a href="#Scheduler-543"><span class="linenos">543</span></a>
</span><span id="Scheduler-544"><a href="#Scheduler-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-545"><a href="#Scheduler-545"><span class="linenos">545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_ipr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">)</span>
</span><span id="Scheduler-546"><a href="#Scheduler-546"><span class="linenos">546</span></a>
</span><span id="Scheduler-547"><a href="#Scheduler-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_merge_masks</span><span class="p">()</span>  <span class="c1"># Merge multiple masks if needed</span>
</span><span id="Scheduler-548"><a href="#Scheduler-548"><span class="linenos">548</span></a>
</span><span id="Scheduler-549"><a href="#Scheduler-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
</span><span id="Scheduler-550"><a href="#Scheduler-550"><span class="linenos">550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_rpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">)</span>
</span><span id="Scheduler-551"><a href="#Scheduler-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="n">research_mode</span><span class="p">:</span>
</span><span id="Scheduler-552"><a href="#Scheduler-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler-553"><a href="#Scheduler-553"><span class="linenos">553</span></a>                <span class="n">update_ipr_in_tar</span><span class="p">(</span>
</span><span id="Scheduler-554"><a href="#Scheduler-554"><span class="linenos">554</span></a>                    <span class="n">tar_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="p">,</span>
</span><span id="Scheduler-555"><a href="#Scheduler-555"><span class="linenos">555</span></a>                    <span class="n">ipr_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">,</span>
</span><span id="Scheduler-556"><a href="#Scheduler-556"><span class="linenos">556</span></a>                <span class="p">)</span>
</span><span id="Scheduler-557"><a href="#Scheduler-557"><span class="linenos">557</span></a>
</span><span id="Scheduler-558"><a href="#Scheduler-558"><span class="linenos">558</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-559"><a href="#Scheduler-559"><span class="linenos">559</span></a>                <span class="n">matrix_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-560"><a href="#Scheduler-560"><span class="linenos">560</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="Scheduler-561"><a href="#Scheduler-561"><span class="linenos">561</span></a>                    <span class="n">m_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Scheduler-562"><a href="#Scheduler-562"><span class="linenos">562</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="n">output_path</span>
</span><span id="Scheduler-563"><a href="#Scheduler-563"><span class="linenos">563</span></a>                <span class="p">)</span>
</span><span id="Scheduler-564"><a href="#Scheduler-564"><span class="linenos">564</span></a>                <span class="n">matrix_template</span> <span class="o">=</span> <span class="n">matrix_naming</span><span class="o">.</span><span class="n">matrix_template</span>
</span><span id="Scheduler-565"><a href="#Scheduler-565"><span class="linenos">565</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-566"><a href="#Scheduler-566"><span class="linenos">566</span></a>                <span class="n">matrix_template</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Scheduler-567"><a href="#Scheduler-567"><span class="linenos">567</span></a>
</span><span id="Scheduler-568"><a href="#Scheduler-568"><span class="linenos">568</span></a>            <span class="n">generate_stereo_file</span><span class="p">(</span>
</span><span id="Scheduler-569"><a href="#Scheduler-569"><span class="linenos">569</span></a>                <span class="n">registered_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">,</span>
</span><span id="Scheduler-570"><a href="#Scheduler-570"><span class="linenos">570</span></a>                <span class="n">compressed_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="p">,</span>
</span><span id="Scheduler-571"><a href="#Scheduler-571"><span class="linenos">571</span></a>                <span class="n">matrix_template</span><span class="o">=</span><span class="n">matrix_template</span><span class="p">,</span>
</span><span id="Scheduler-572"><a href="#Scheduler-572"><span class="linenos">572</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">stereo</span><span class="p">,</span>
</span><span id="Scheduler-573"><a href="#Scheduler-573"><span class="linenos">573</span></a>                <span class="n">sn</span><span class="o">=</span><span class="n">chip_no</span>
</span><span id="Scheduler-574"><a href="#Scheduler-574"><span class="linenos">574</span></a>            <span class="p">)</span>
</span><span id="Scheduler-575"><a href="#Scheduler-575"><span class="linenos">575</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="Scheduler-576"><a href="#Scheduler-576"><span class="linenos">576</span></a>            <span class="n">f_to_keep</span> <span class="o">=</span> <span class="n">FILES_TO_KEEP_RESEARCH</span> <span class="k">if</span> <span class="n">research_mode</span> <span class="k">else</span> <span class="n">FILES_TO_KEEP</span>
</span><span id="Scheduler-577"><a href="#Scheduler-577"><span class="linenos">577</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">del_files</span><span class="p">(</span><span class="n">f_to_keep</span><span class="p">)</span>
</span><span id="Scheduler-578"><a href="#Scheduler-578"><span class="linenos">578</span></a>
</span><span id="Scheduler-579"><a href="#Scheduler-579"><span class="linenos">579</span></a>    <span class="k">def</span> <span class="nf">del_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_to_keep</span><span class="p">):</span>
</span><span id="Scheduler-580"><a href="#Scheduler-580"><span class="linenos">580</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler-581"><a href="#Scheduler-581"><span class="linenos">581</span></a><span class="sd">        Deletes files from the output directory, excluding those specified to be kept.</span>
</span><span id="Scheduler-582"><a href="#Scheduler-582"><span class="linenos">582</span></a>
</span><span id="Scheduler-583"><a href="#Scheduler-583"><span class="linenos">583</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-584"><a href="#Scheduler-584"><span class="linenos">584</span></a><span class="sd">            f_to_keep (list): List of file properties that should not be deleted.</span>
</span><span id="Scheduler-585"><a href="#Scheduler-585"><span class="linenos">585</span></a>
</span><span id="Scheduler-586"><a href="#Scheduler-586"><span class="linenos">586</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-587"><a href="#Scheduler-587"><span class="linenos">587</span></a><span class="sd">            None</span>
</span><span id="Scheduler-588"><a href="#Scheduler-588"><span class="linenos">588</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-589"><a href="#Scheduler-589"><span class="linenos">589</span></a>        <span class="c1"># List to store all file paths</span>
</span><span id="Scheduler-590"><a href="#Scheduler-590"><span class="linenos">590</span></a>        <span class="n">all_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler-591"><a href="#Scheduler-591"><span class="linenos">591</span></a>        <span class="c1"># List to store file paths that should be kept</span>
</span><span id="Scheduler-592"><a href="#Scheduler-592"><span class="linenos">592</span></a>        <span class="n">k_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler-593"><a href="#Scheduler-593"><span class="linenos">593</span></a>        <span class="c1"># List to store file paths that should be removed</span>
</span><span id="Scheduler-594"><a href="#Scheduler-594"><span class="linenos">594</span></a>        <span class="n">remove_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler-595"><a href="#Scheduler-595"><span class="linenos">595</span></a>        
</span><span id="Scheduler-596"><a href="#Scheduler-596"><span class="linenos">596</span></a>        <span class="c1"># Iterate over files in self._files</span>
</span><span id="Scheduler-597"><a href="#Scheduler-597"><span class="linenos">597</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-598"><a href="#Scheduler-598"><span class="linenos">598</span></a>            <span class="c1"># Get group name for the file</span>
</span><span id="Scheduler-599"><a href="#Scheduler-599"><span class="linenos">599</span></a>            <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="Scheduler-600"><a href="#Scheduler-600"><span class="linenos">600</span></a>            
</span><span id="Scheduler-601"><a href="#Scheduler-601"><span class="linenos">601</span></a>            <span class="c1"># Check if the file is a matrix</span>
</span><span id="Scheduler-602"><a href="#Scheduler-602"><span class="linenos">602</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_matrix</span><span class="p">:</span>
</span><span id="Scheduler-603"><a href="#Scheduler-603"><span class="linenos">603</span></a>                <span class="c1"># Create DumpMatrixFileNaming object for matrix files</span>
</span><span id="Scheduler-604"><a href="#Scheduler-604"><span class="linenos">604</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-605"><a href="#Scheduler-605"><span class="linenos">605</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-606"><a href="#Scheduler-606"><span class="linenos">606</span></a>                    <span class="n">m_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Scheduler-607"><a href="#Scheduler-607"><span class="linenos">607</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="Scheduler-608"><a href="#Scheduler-608"><span class="linenos">608</span></a>                <span class="p">)</span>
</span><span id="Scheduler-609"><a href="#Scheduler-609"><span class="linenos">609</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-610"><a href="#Scheduler-610"><span class="linenos">610</span></a>                <span class="c1"># Create DumpImageFileNaming object for image files</span>
</span><span id="Scheduler-611"><a href="#Scheduler-611"><span class="linenos">611</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler-612"><a href="#Scheduler-612"><span class="linenos">612</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler-613"><a href="#Scheduler-613"><span class="linenos">613</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="Scheduler-614"><a href="#Scheduler-614"><span class="linenos">614</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler-615"><a href="#Scheduler-615"><span class="linenos">615</span></a>                <span class="p">)</span>
</span><span id="Scheduler-616"><a href="#Scheduler-616"><span class="linenos">616</span></a>            
</span><span id="Scheduler-617"><a href="#Scheduler-617"><span class="linenos">617</span></a>            <span class="c1"># Iterate over attributes of the file naming object</span>
</span><span id="Scheduler-618"><a href="#Scheduler-618"><span class="linenos">618</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f_name</span><span class="p">):</span>
</span><span id="Scheduler-619"><a href="#Scheduler-619"><span class="linenos">619</span></a>                <span class="n">att</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Scheduler-620"><a href="#Scheduler-620"><span class="linenos">620</span></a>                <span class="n">pt</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Scheduler-621"><a href="#Scheduler-621"><span class="linenos">621</span></a>                
</span><span id="Scheduler-622"><a href="#Scheduler-622"><span class="linenos">622</span></a>                <span class="c1"># Check if the attribute is a property and the file exists</span>
</span><span id="Scheduler-623"><a href="#Scheduler-623"><span class="linenos">623</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="ow">and</span> <span class="n">att</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler-624"><a href="#Scheduler-624"><span class="linenos">624</span></a>                    <span class="n">all_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="Scheduler-625"><a href="#Scheduler-625"><span class="linenos">625</span></a>                    
</span><span id="Scheduler-626"><a href="#Scheduler-626"><span class="linenos">626</span></a>                    <span class="c1"># Check if the file should be removed or kept</span>
</span><span id="Scheduler-627"><a href="#Scheduler-627"><span class="linenos">627</span></a>                    <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_to_keep</span><span class="p">:</span>
</span><span id="Scheduler-628"><a href="#Scheduler-628"><span class="linenos">628</span></a>                        <span class="n">remove_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="Scheduler-629"><a href="#Scheduler-629"><span class="linenos">629</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-630"><a href="#Scheduler-630"><span class="linenos">630</span></a>                        <span class="n">k_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="Scheduler-631"><a href="#Scheduler-631"><span class="linenos">631</span></a>        
</span><span id="Scheduler-632"><a href="#Scheduler-632"><span class="linenos">632</span></a>        <span class="c1"># Iterate over attributes of self.p_naming</span>
</span><span id="Scheduler-633"><a href="#Scheduler-633"><span class="linenos">633</span></a>        <span class="k">for</span> <span class="n">p_p</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">):</span>
</span><span id="Scheduler-634"><a href="#Scheduler-634"><span class="linenos">634</span></a>            <span class="n">p_att</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">,</span> <span class="n">p_p</span><span class="p">)</span>
</span><span id="Scheduler-635"><a href="#Scheduler-635"><span class="linenos">635</span></a>            <span class="n">p_pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_p</span><span class="p">)</span>
</span><span id="Scheduler-636"><a href="#Scheduler-636"><span class="linenos">636</span></a>            
</span><span id="Scheduler-637"><a href="#Scheduler-637"><span class="linenos">637</span></a>            <span class="c1"># Check if the attribute is a property and the file exists</span>
</span><span id="Scheduler-638"><a href="#Scheduler-638"><span class="linenos">638</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_pt</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p_att</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler-639"><a href="#Scheduler-639"><span class="linenos">639</span></a>                <span class="n">all_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="Scheduler-640"><a href="#Scheduler-640"><span class="linenos">640</span></a>                
</span><span id="Scheduler-641"><a href="#Scheduler-641"><span class="linenos">641</span></a>                <span class="c1"># Check if the file should be removed or kept</span>
</span><span id="Scheduler-642"><a href="#Scheduler-642"><span class="linenos">642</span></a>                <span class="k">if</span> <span class="n">p_pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_to_keep</span><span class="p">:</span>
</span><span id="Scheduler-643"><a href="#Scheduler-643"><span class="linenos">643</span></a>                    <span class="n">remove_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="Scheduler-644"><a href="#Scheduler-644"><span class="linenos">644</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler-645"><a href="#Scheduler-645"><span class="linenos">645</span></a>                    <span class="n">k_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="Scheduler-646"><a href="#Scheduler-646"><span class="linenos">646</span></a>        
</span><span id="Scheduler-647"><a href="#Scheduler-647"><span class="linenos">647</span></a>        <span class="c1"># Iterate over files in the output directory</span>
</span><span id="Scheduler-648"><a href="#Scheduler-648"><span class="linenos">648</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">):</span>
</span><span id="Scheduler-649"><a href="#Scheduler-649"><span class="linenos">649</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="Scheduler-650"><a href="#Scheduler-650"><span class="linenos">650</span></a>            
</span><span id="Scheduler-651"><a href="#Scheduler-651"><span class="linenos">651</span></a>            <span class="c1"># Remove the file if it is in the remove_ list</span>
</span><span id="Scheduler-652"><a href="#Scheduler-652"><span class="linenos">652</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">remove_</span><span class="p">:</span>
</span><span id="Scheduler-653"><a href="#Scheduler-653"><span class="linenos">653</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A scheduler class responsible for managing the registration, segmentation, calibration, and matrix extraction processes.</p>

<h6 id="attributes">Attributes:</h6>

<ul>
<li><strong>weights_root (str):</strong>  The root directory for storing CNN weight files.</li>
<li><strong>param_chip (StereoChip):</strong>  An instance of StereoChip for handling chip mask information.</li>
<li><strong>config (Config):</strong>  An instance of Config for managing configuration settings.</li>
<li><strong>_files (Dict[int, ProcFile]):</strong>  A dictionary to store processed files.</li>
<li><strong>_ipr (ImageProcessRecord):</strong>  An instance of ImageProcessRecord for managing image processing records.</li>
<li><strong>_channel_images (Dict[str, Union[IFChannel, ImageChannel]]):</strong>  A dictionary to store channel images.</li>
<li><strong>_output_path (str):</strong>  The output directory path.</li>
<li><strong>p_naming (DumpPipelineFileNaming):</strong>  An instance of DumpPipelineFileNaming for managing file naming conventions.</li>
<li><strong>matrix_file:</strong>  The matrix file to be processed.</li>
</ul>
</div>


                            <div id="Scheduler.__init__" class="classattr">
                                        <input id="Scheduler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Scheduler</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="Scheduler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.__init__-48"><a href="#Scheduler.__init__-48"><span class="linenos">48</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Scheduler.__init__-49"><a href="#Scheduler.__init__-49"><span class="linenos">49</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler.__init__-50"><a href="#Scheduler.__init__-50"><span class="linenos">50</span></a><span class="sd">        Initialize the StereoPipeline object with the given configuration file, chip mask file, and weights root.</span>
</span><span id="Scheduler.__init__-51"><a href="#Scheduler.__init__-51"><span class="linenos">51</span></a>
</span><span id="Scheduler.__init__-52"><a href="#Scheduler.__init__-52"><span class="linenos">52</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler.__init__-53"><a href="#Scheduler.__init__-53"><span class="linenos">53</span></a><span class="sd">            config_file (str): Path to the configuration file.</span>
</span><span id="Scheduler.__init__-54"><a href="#Scheduler.__init__-54"><span class="linenos">54</span></a><span class="sd">            chip_mask_file (str): Path to the chip mask file.</span>
</span><span id="Scheduler.__init__-55"><a href="#Scheduler.__init__-55"><span class="linenos">55</span></a><span class="sd">            weights_root (str): Root directory for weights.</span>
</span><span id="Scheduler.__init__-56"><a href="#Scheduler.__init__-56"><span class="linenos">56</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.__init__-57"><a href="#Scheduler.__init__-57"><span class="linenos">57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights_root</span> <span class="o">=</span> <span class="n">weights_root</span>
</span><span id="Scheduler.__init__-58"><a href="#Scheduler.__init__-58"><span class="linenos">58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span> <span class="o">=</span> <span class="n">StereoChip</span><span class="p">(</span><span class="n">chip_mask_file</span><span class="p">)</span>
</span><span id="Scheduler.__init__-59"><a href="#Scheduler.__init__-59"><span class="linenos">59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">)</span>
</span><span id="Scheduler.__init__-60"><a href="#Scheduler.__init__-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Scheduler.__init__-61"><a href="#Scheduler.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">ImageProcessRecord</span><span class="p">()</span>
</span><span id="Scheduler.__init__-62"><a href="#Scheduler.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">ipr</span><span class="o">.</span><span class="n">IFChannel</span><span class="p">,</span> <span class="n">ipr</span><span class="o">.</span><span class="n">ImageChannel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ipr.ImageChannel</span>
</span><span id="Scheduler.__init__-63"><a href="#Scheduler.__init__-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="Scheduler.__init__-64"><a href="#Scheduler.__init__-64"><span class="linenos">64</span></a>
</span><span id="Scheduler.__init__-65"><a href="#Scheduler.__init__-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">:</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler.__init__-66"><a href="#Scheduler.__init__-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler.__init__-67"><a href="#Scheduler.__init__-67"><span class="linenos">67</span></a>        <span class="c1"># self._image_naming: naming.DumpImageFileNaming</span>
</span><span id="Scheduler.__init__-68"><a href="#Scheduler.__init__-68"><span class="linenos">68</span></a>        <span class="c1"># self._matrix_naming: naming.DumpMatrixFileNaming</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the StereoPipeline object with the given configuration file, chip mask file, and weights root.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>config_file (str):</strong>  Path to the configuration file.</li>
<li><strong>chip_mask_file (str):</strong>  Path to the chip mask file.</li>
<li><strong>weights_root (str):</strong>  Root directory for weights.</li>
</ul>
</div>


                            </div>
                            <div id="Scheduler.weights_root" class="classattr">
                                <div class="attr variable">
            <span class="name">weights_root</span>

        
    </div>
    <a class="headerlink" href="#Scheduler.weights_root"></a>
    
    

                            </div>
                            <div id="Scheduler.param_chip" class="classattr">
                                <div class="attr variable">
            <span class="name">param_chip</span>

        
    </div>
    <a class="headerlink" href="#Scheduler.param_chip"></a>
    
    

                            </div>
                            <div id="Scheduler.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span>

        
    </div>
    <a class="headerlink" href="#Scheduler.config"></a>
    
    

                            </div>
                            <div id="Scheduler.p_naming" class="classattr">
                                <div class="attr variable">
            <span class="name">p_naming</span><span class="annotation">: <a href="naming.html#DumpPipelineFileNaming">cellbin2.modules.naming.DumpPipelineFileNaming</a></span>

        
    </div>
    <a class="headerlink" href="#Scheduler.p_naming"></a>
    
    

                            </div>
                            <div id="Scheduler.matrix_file" class="classattr">
                                <div class="attr variable">
            <span class="name">matrix_file</span>

        
    </div>
    <a class="headerlink" href="#Scheduler.matrix_file"></a>
    
    

                            </div>
                            <div id="Scheduler.run_segmentation" class="classattr">
                                        <input id="Scheduler.run_segmentation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_segmentation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">f</span>,</span><span class="param">	<span class="n">im_path</span>,</span><span class="param">	<span class="n">ts_raw_save_path</span>,</span><span class="param">	<span class="n">cs_raw_save_path</span>,</span><span class="param">	<span class="n">ts_save_path</span>,</span><span class="param">	<span class="n">cs_save_path</span>,</span><span class="param">	<span class="n">cur_c_image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="../utils/ipr.html#ImageChannel">cellbin2.utils.ipr.ImageChannel</a></span><span class="p">,</span> <span class="n"><a href="../utils/ipr.html#IFChannel">cellbin2.utils.ipr.IFChannel</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scheduler.run_segmentation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.run_segmentation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.run_segmentation-207"><a href="#Scheduler.run_segmentation-207"><span class="linenos">207</span></a>    <span class="k">def</span> <span class="nf">run_segmentation</span><span class="p">(</span>
</span><span id="Scheduler.run_segmentation-208"><a href="#Scheduler.run_segmentation-208"><span class="linenos">208</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-209"><a href="#Scheduler.run_segmentation-209"><span class="linenos">209</span></a>            <span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-210"><a href="#Scheduler.run_segmentation-210"><span class="linenos">210</span></a>            <span class="n">im_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-211"><a href="#Scheduler.run_segmentation-211"><span class="linenos">211</span></a>            <span class="n">ts_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-212"><a href="#Scheduler.run_segmentation-212"><span class="linenos">212</span></a>            <span class="n">cs_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-213"><a href="#Scheduler.run_segmentation-213"><span class="linenos">213</span></a>            <span class="n">ts_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-214"><a href="#Scheduler.run_segmentation-214"><span class="linenos">214</span></a>            <span class="n">cs_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-215"><a href="#Scheduler.run_segmentation-215"><span class="linenos">215</span></a>            <span class="n">cur_c_image</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ipr</span><span class="o">.</span><span class="n">ImageChannel</span><span class="p">,</span> <span class="n">ipr</span><span class="o">.</span><span class="n">IFChannel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler.run_segmentation-216"><a href="#Scheduler.run_segmentation-216"><span class="linenos">216</span></a>    <span class="p">):</span>
</span><span id="Scheduler.run_segmentation-217"><a href="#Scheduler.run_segmentation-217"><span class="linenos">217</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler.run_segmentation-218"><a href="#Scheduler.run_segmentation-218"><span class="linenos">218</span></a><span class="sd">        Run tissue and cell segmentation on the given image file.</span>
</span><span id="Scheduler.run_segmentation-219"><a href="#Scheduler.run_segmentation-219"><span class="linenos">219</span></a>
</span><span id="Scheduler.run_segmentation-220"><a href="#Scheduler.run_segmentation-220"><span class="linenos">220</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler.run_segmentation-221"><a href="#Scheduler.run_segmentation-221"><span class="linenos">221</span></a><span class="sd">            f (ProcFile): The file object containing segmentation settings.</span>
</span><span id="Scheduler.run_segmentation-222"><a href="#Scheduler.run_segmentation-222"><span class="linenos">222</span></a><span class="sd">            im_path (Path): The path to the image file.</span>
</span><span id="Scheduler.run_segmentation-223"><a href="#Scheduler.run_segmentation-223"><span class="linenos">223</span></a><span class="sd">            ts_raw_save_path (Path): The path to save the raw tissue segmentation mask.</span>
</span><span id="Scheduler.run_segmentation-224"><a href="#Scheduler.run_segmentation-224"><span class="linenos">224</span></a><span class="sd">            cs_raw_save_path (Path): The path to save the raw cell segmentation mask.</span>
</span><span id="Scheduler.run_segmentation-225"><a href="#Scheduler.run_segmentation-225"><span class="linenos">225</span></a><span class="sd">            ts_save_path (str): The path to save the final tissue segmentation mask.</span>
</span><span id="Scheduler.run_segmentation-226"><a href="#Scheduler.run_segmentation-226"><span class="linenos">226</span></a><span class="sd">            cs_save_path (str): The path to save the final cell segmentation mask.</span>
</span><span id="Scheduler.run_segmentation-227"><a href="#Scheduler.run_segmentation-227"><span class="linenos">227</span></a><span class="sd">            cur_c_image (object, optional): The current channel image or IF channel image, if available.</span>
</span><span id="Scheduler.run_segmentation-228"><a href="#Scheduler.run_segmentation-228"><span class="linenos">228</span></a>
</span><span id="Scheduler.run_segmentation-229"><a href="#Scheduler.run_segmentation-229"><span class="linenos">229</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler.run_segmentation-230"><a href="#Scheduler.run_segmentation-230"><span class="linenos">230</span></a><span class="sd">            None</span>
</span><span id="Scheduler.run_segmentation-231"><a href="#Scheduler.run_segmentation-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.run_segmentation-232"><a href="#Scheduler.run_segmentation-232"><span class="linenos">232</span></a>        <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler.run_segmentation-233"><a href="#Scheduler.run_segmentation-233"><span class="linenos">233</span></a>        <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler.run_segmentation-234"><a href="#Scheduler.run_segmentation-234"><span class="linenos">234</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="Scheduler.run_segmentation-235"><a href="#Scheduler.run_segmentation-235"><span class="linenos">235</span></a>            <span class="n">tissue_mask</span> <span class="o">=</span> <span class="n">run_tissue_seg</span><span class="p">(</span>
</span><span id="Scheduler.run_segmentation-236"><a href="#Scheduler.run_segmentation-236"><span class="linenos">236</span></a>                <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-237"><a href="#Scheduler.run_segmentation-237"><span class="linenos">237</span></a>                <span class="n">image_path</span><span class="o">=</span><span class="n">im_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-238"><a href="#Scheduler.run_segmentation-238"><span class="linenos">238</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="n">ts_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-239"><a href="#Scheduler.run_segmentation-239"><span class="linenos">239</span></a>                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-240"><a href="#Scheduler.run_segmentation-240"><span class="linenos">240</span></a>                <span class="n">chip_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-241"><a href="#Scheduler.run_segmentation-241"><span class="linenos">241</span></a>                <span class="n">channel_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler.run_segmentation-242"><a href="#Scheduler.run_segmentation-242"><span class="linenos">242</span></a>            <span class="p">)</span>
</span><span id="Scheduler.run_segmentation-243"><a href="#Scheduler.run_segmentation-243"><span class="linenos">243</span></a>            <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="n">tissue_mask</span>
</span><span id="Scheduler.run_segmentation-244"><a href="#Scheduler.run_segmentation-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler.run_segmentation-245"><a href="#Scheduler.run_segmentation-245"><span class="linenos">245</span></a>            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">run_cell_seg</span><span class="p">(</span>
</span><span id="Scheduler.run_segmentation-246"><a href="#Scheduler.run_segmentation-246"><span class="linenos">246</span></a>                <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-247"><a href="#Scheduler.run_segmentation-247"><span class="linenos">247</span></a>                <span class="n">image_path</span><span class="o">=</span><span class="n">im_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-248"><a href="#Scheduler.run_segmentation-248"><span class="linenos">248</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="n">cs_raw_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-249"><a href="#Scheduler.run_segmentation-249"><span class="linenos">249</span></a>                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-250"><a href="#Scheduler.run_segmentation-250"><span class="linenos">250</span></a>                <span class="n">channel_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler.run_segmentation-251"><a href="#Scheduler.run_segmentation-251"><span class="linenos">251</span></a>            <span class="p">)</span>
</span><span id="Scheduler.run_segmentation-252"><a href="#Scheduler.run_segmentation-252"><span class="linenos">252</span></a>            <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="n">cell_mask</span>
</span><span id="Scheduler.run_segmentation-253"><a href="#Scheduler.run_segmentation-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler.run_segmentation-254"><a href="#Scheduler.run_segmentation-254"><span class="linenos">254</span></a>            <span class="n">tissue_mask</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">ts_raw_save_path</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler.run_segmentation-255"><a href="#Scheduler.run_segmentation-255"><span class="linenos">255</span></a>            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">cs_raw_save_path</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler.run_segmentation-256"><a href="#Scheduler.run_segmentation-256"><span class="linenos">256</span></a>            <span class="n">c_box</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler.run_segmentation-257"><a href="#Scheduler.run_segmentation-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">cur_c_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run_segmentation-258"><a href="#Scheduler.run_segmentation-258"><span class="linenos">258</span></a>                <span class="n">c_box</span> <span class="o">=</span> <span class="n">cur_c_image</span><span class="o">.</span><span class="n">Stitch</span><span class="o">.</span><span class="n">TransformChipBBox</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</span><span id="Scheduler.run_segmentation-259"><a href="#Scheduler.run_segmentation-259"><span class="linenos">259</span></a>            <span class="n">input_data</span> <span class="o">=</span> <span class="n">MaskManagerInfo</span><span class="p">(</span>
</span><span id="Scheduler.run_segmentation-260"><a href="#Scheduler.run_segmentation-260"><span class="linenos">260</span></a>                <span class="n">tissue_mask</span><span class="o">=</span><span class="n">tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-261"><a href="#Scheduler.run_segmentation-261"><span class="linenos">261</span></a>                <span class="n">cell_mask</span><span class="o">=</span><span class="n">cell_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-262"><a href="#Scheduler.run_segmentation-262"><span class="linenos">262</span></a>                <span class="n">chip_box</span><span class="o">=</span><span class="n">c_box</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-263"><a href="#Scheduler.run_segmentation-263"><span class="linenos">263</span></a>                <span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-264"><a href="#Scheduler.run_segmentation-264"><span class="linenos">264</span></a>                <span class="n">stain_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span>
</span><span id="Scheduler.run_segmentation-265"><a href="#Scheduler.run_segmentation-265"><span class="linenos">265</span></a>            <span class="p">)</span>
</span><span id="Scheduler.run_segmentation-266"><a href="#Scheduler.run_segmentation-266"><span class="linenos">266</span></a>            <span class="n">btcm</span> <span class="o">=</span> <span class="n">BestTissueCellMask</span><span class="o">.</span><span class="n">get_best_tissue_cell_mask</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">)</span>
</span><span id="Scheduler.run_segmentation-267"><a href="#Scheduler.run_segmentation-267"><span class="linenos">267</span></a>            <span class="n">final_tissue_mask</span> <span class="o">=</span> <span class="n">btcm</span><span class="o">.</span><span class="n">best_tissue_mask</span>
</span><span id="Scheduler.run_segmentation-268"><a href="#Scheduler.run_segmentation-268"><span class="linenos">268</span></a>            <span class="n">final_cell_mask</span> <span class="o">=</span> <span class="n">btcm</span><span class="o">.</span><span class="n">best_cell_mask</span>
</span><span id="Scheduler.run_segmentation-269"><a href="#Scheduler.run_segmentation-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">final_cell_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run_segmentation-270"><a href="#Scheduler.run_segmentation-270"><span class="linenos">270</span></a>            <span class="n">cbimwrite</span><span class="p">(</span>
</span><span id="Scheduler.run_segmentation-271"><a href="#Scheduler.run_segmentation-271"><span class="linenos">271</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="n">cs_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-272"><a href="#Scheduler.run_segmentation-272"><span class="linenos">272</span></a>                <span class="n">files</span><span class="o">=</span><span class="n">final_cell_mask</span>
</span><span id="Scheduler.run_segmentation-273"><a href="#Scheduler.run_segmentation-273"><span class="linenos">273</span></a>            <span class="p">)</span>
</span><span id="Scheduler.run_segmentation-274"><a href="#Scheduler.run_segmentation-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="n">final_tissue_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run_segmentation-275"><a href="#Scheduler.run_segmentation-275"><span class="linenos">275</span></a>            <span class="n">cbimwrite</span><span class="p">(</span>
</span><span id="Scheduler.run_segmentation-276"><a href="#Scheduler.run_segmentation-276"><span class="linenos">276</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="n">ts_save_path</span><span class="p">,</span>
</span><span id="Scheduler.run_segmentation-277"><a href="#Scheduler.run_segmentation-277"><span class="linenos">277</span></a>                <span class="n">files</span><span class="o">=</span><span class="n">final_tissue_mask</span>
</span><span id="Scheduler.run_segmentation-278"><a href="#Scheduler.run_segmentation-278"><span class="linenos">278</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run tissue and cell segmentation on the given image file.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>f (ProcFile):</strong>  The file object containing segmentation settings.</li>
<li><strong>im_path (Path):</strong>  The path to the image file.</li>
<li><strong>ts_raw_save_path (Path):</strong>  The path to save the raw tissue segmentation mask.</li>
<li><strong>cs_raw_save_path (Path):</strong>  The path to save the raw cell segmentation mask.</li>
<li><strong>ts_save_path (str):</strong>  The path to save the final tissue segmentation mask.</li>
<li><strong>cs_save_path (str):</strong>  The path to save the final cell segmentation mask.</li>
<li><strong>cur_c_image (object, optional):</strong>  The current channel image or IF channel image, if available.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="Scheduler.run_single_image" class="classattr">
                                        <input id="Scheduler.run_single_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_single_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scheduler.run_single_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.run_single_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.run_single_image-280"><a href="#Scheduler.run_single_image-280"><span class="linenos">280</span></a>    <span class="k">def</span> <span class="nf">run_single_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scheduler.run_single_image-281"><a href="#Scheduler.run_single_image-281"><span class="linenos">281</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler.run_single_image-282"><a href="#Scheduler.run_single_image-282"><span class="linenos">282</span></a><span class="sd">        Process each single image in the pipeline.</span>
</span><span id="Scheduler.run_single_image-283"><a href="#Scheduler.run_single_image-283"><span class="linenos">283</span></a><span class="sd">        </span>
</span><span id="Scheduler.run_single_image-284"><a href="#Scheduler.run_single_image-284"><span class="linenos">284</span></a><span class="sd">        This method iterates over each image file, performs necessary transformations,</span>
</span><span id="Scheduler.run_single_image-285"><a href="#Scheduler.run_single_image-285"><span class="linenos">285</span></a><span class="sd">        and applies segmentation. It handles both cases where IPR data is available and</span>
</span><span id="Scheduler.run_single_image-286"><a href="#Scheduler.run_single_image-286"><span class="linenos">286</span></a><span class="sd">        where it is not.</span>
</span><span id="Scheduler.run_single_image-287"><a href="#Scheduler.run_single_image-287"><span class="linenos">287</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.run_single_image-288"><a href="#Scheduler.run_single_image-288"><span class="linenos">288</span></a>        <span class="c1"># Iterate over each file in the dataset</span>
</span><span id="Scheduler.run_single_image-289"><a href="#Scheduler.run_single_image-289"><span class="linenos">289</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler.run_single_image-290"><a href="#Scheduler.run_single_image-290"><span class="linenos">290</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  File[</span><span class="si">{}</span><span class="s1">] CellBin, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="Scheduler.run_single_image-291"><a href="#Scheduler.run_single_image-291"><span class="linenos">291</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-292"><a href="#Scheduler.run_single_image-292"><span class="linenos">292</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="Scheduler.run_single_image-293"><a href="#Scheduler.run_single_image-293"><span class="linenos">293</span></a>                <span class="n">cur_f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-294"><a href="#Scheduler.run_single_image-294"><span class="linenos">294</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-295"><a href="#Scheduler.run_single_image-295"><span class="linenos">295</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-296"><a href="#Scheduler.run_single_image-296"><span class="linenos">296</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler.run_single_image-297"><a href="#Scheduler.run_single_image-297"><span class="linenos">297</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run_single_image-298"><a href="#Scheduler.run_single_image-298"><span class="linenos">298</span></a>                <span class="n">cur_c_image</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Scheduler.run_single_image-299"><a href="#Scheduler.run_single_image-299"><span class="linenos">299</span></a>                <span class="c1"># Copy the stitched image</span>
</span><span id="Scheduler.run_single_image-300"><a href="#Scheduler.run_single_image-300"><span class="linenos">300</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span> <span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">)</span>
</span><span id="Scheduler.run_single_image-301"><a href="#Scheduler.run_single_image-301"><span class="linenos">301</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-302"><a href="#Scheduler.run_single_image-302"><span class="linenos">302</span></a>                    <span class="c1"># IPR data is provided</span>
</span><span id="Scheduler.run_single_image-303"><a href="#Scheduler.run_single_image-303"><span class="linenos">303</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">tech</span> <span class="o">==</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-304"><a href="#Scheduler.run_single_image-304"><span class="linenos">304</span></a>                        <span class="c1"># TODO: handle two versions of IPR</span>
</span><span id="Scheduler.run_single_image-305"><a href="#Scheduler.run_single_image-305"><span class="linenos">305</span></a>                        <span class="n">qc_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span><span class="o">.</span><span class="n">QCInfo</span>
</span><span id="Scheduler.run_single_image-306"><a href="#Scheduler.run_single_image-306"><span class="linenos">306</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QcPassFlag&#39;</span><span class="p">):</span>
</span><span id="Scheduler.run_single_image-307"><a href="#Scheduler.run_single_image-307"><span class="linenos">307</span></a>                            <span class="n">qc_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QcPassFlag&#39;</span><span class="p">)</span>
</span><span id="Scheduler.run_single_image-308"><a href="#Scheduler.run_single_image-308"><span class="linenos">308</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-309"><a href="#Scheduler.run_single_image-309"><span class="linenos">309</span></a>                            <span class="n">qc_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">qc_</span><span class="p">,</span> <span class="s1">&#39;QCPassFlag&#39;</span><span class="p">)</span>
</span><span id="Scheduler.run_single_image-310"><a href="#Scheduler.run_single_image-310"><span class="linenos">310</span></a>                        <span class="k">if</span> <span class="n">qc_flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Cannot register under current conditions</span>
</span><span id="Scheduler.run_single_image-311"><a href="#Scheduler.run_single_image-311"><span class="linenos">311</span></a>                            <span class="n">clog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Image QC not pass, cannot deal this pipeline&#39;</span><span class="p">)</span>
</span><span id="Scheduler.run_single_image-312"><a href="#Scheduler.run_single_image-312"><span class="linenos">312</span></a>                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">qcFail</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="Scheduler.run_single_image-313"><a href="#Scheduler.run_single_image-313"><span class="linenos">313</span></a>                    <span class="c1"># Perform transform operations: Transform &gt; Segmentation &gt; Mask merge &amp; expand</span>
</span><span id="Scheduler.run_single_image-314"><a href="#Scheduler.run_single_image-314"><span class="linenos">314</span></a>                    <span class="n">cur_c_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">[</span><span class="n">g_name</span><span class="p">]</span>
</span><span id="Scheduler.run_single_image-315"><a href="#Scheduler.run_single_image-315"><span class="linenos">315</span></a>                    <span class="c1"># Transform input and output</span>
</span><span id="Scheduler.run_single_image-316"><a href="#Scheduler.run_single_image-316"><span class="linenos">316</span></a>                    <span class="n">run_transform</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-317"><a href="#Scheduler.run_single_image-317"><span class="linenos">317</span></a>                        <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-318"><a href="#Scheduler.run_single_image-318"><span class="linenos">318</span></a>                        <span class="n">channel_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-319"><a href="#Scheduler.run_single_image-319"><span class="linenos">319</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-320"><a href="#Scheduler.run_single_image-320"><span class="linenos">320</span></a>                        <span class="n">files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-321"><a href="#Scheduler.run_single_image-321"><span class="linenos">321</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-322"><a href="#Scheduler.run_single_image-322"><span class="linenos">322</span></a>                        <span class="n">if_track</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">trackline</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-323"><a href="#Scheduler.run_single_image-323"><span class="linenos">323</span></a>                        <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research_mode</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-324"><a href="#Scheduler.run_single_image-324"><span class="linenos">324</span></a>                    <span class="p">)</span>
</span><span id="Scheduler.run_single_image-325"><a href="#Scheduler.run_single_image-325"><span class="linenos">325</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">run_segmentation</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-326"><a href="#Scheduler.run_single_image-326"><span class="linenos">326</span></a>                        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-327"><a href="#Scheduler.run_single_image-327"><span class="linenos">327</span></a>                        <span class="n">im_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-328"><a href="#Scheduler.run_single_image-328"><span class="linenos">328</span></a>                        <span class="n">ts_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-329"><a href="#Scheduler.run_single_image-329"><span class="linenos">329</span></a>                        <span class="n">cs_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-330"><a href="#Scheduler.run_single_image-330"><span class="linenos">330</span></a>                        <span class="n">ts_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-331"><a href="#Scheduler.run_single_image-331"><span class="linenos">331</span></a>                        <span class="n">cs_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-332"><a href="#Scheduler.run_single_image-332"><span class="linenos">332</span></a>                        <span class="n">cur_c_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler.run_single_image-333"><a href="#Scheduler.run_single_image-333"><span class="linenos">333</span></a>                    <span class="p">)</span>
</span><span id="Scheduler.run_single_image-334"><a href="#Scheduler.run_single_image-334"><span class="linenos">334</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-335"><a href="#Scheduler.run_single_image-335"><span class="linenos">335</span></a>                    <span class="c1"># IPR data is not provided, perform segmentation directly on the input image</span>
</span><span id="Scheduler.run_single_image-336"><a href="#Scheduler.run_single_image-336"><span class="linenos">336</span></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">,</span> <span class="n">cur_f_name</span><span class="o">.</span><span class="n">transformed_image</span><span class="p">)</span>
</span><span id="Scheduler.run_single_image-337"><a href="#Scheduler.run_single_image-337"><span class="linenos">337</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">run_segmentation</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-338"><a href="#Scheduler.run_single_image-338"><span class="linenos">338</span></a>                        <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-339"><a href="#Scheduler.run_single_image-339"><span class="linenos">339</span></a>                        <span class="n">im_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">stitch_image</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-340"><a href="#Scheduler.run_single_image-340"><span class="linenos">340</span></a>                        <span class="n">ts_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-341"><a href="#Scheduler.run_single_image-341"><span class="linenos">341</span></a>                        <span class="n">cs_raw_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask_raw</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-342"><a href="#Scheduler.run_single_image-342"><span class="linenos">342</span></a>                        <span class="n">ts_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-343"><a href="#Scheduler.run_single_image-343"><span class="linenos">343</span></a>                        <span class="n">cs_save_path</span><span class="o">=</span><span class="n">cur_f_name</span><span class="o">.</span><span class="n">transform_cell_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-344"><a href="#Scheduler.run_single_image-344"><span class="linenos">344</span></a>                        <span class="n">cur_c_image</span><span class="o">=</span><span class="n">cur_c_image</span>
</span><span id="Scheduler.run_single_image-345"><a href="#Scheduler.run_single_image-345"><span class="linenos">345</span></a>                    <span class="p">)</span>
</span><span id="Scheduler.run_single_image-346"><a href="#Scheduler.run_single_image-346"><span class="linenos">346</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-347"><a href="#Scheduler.run_single_image-347"><span class="linenos">347</span></a>                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-348"><a href="#Scheduler.run_single_image-348"><span class="linenos">348</span></a>                    <span class="n">cur_m_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-349"><a href="#Scheduler.run_single_image-349"><span class="linenos">349</span></a>                        <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-350"><a href="#Scheduler.run_single_image-350"><span class="linenos">350</span></a>                        <span class="n">m_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-351"><a href="#Scheduler.run_single_image-351"><span class="linenos">351</span></a>                        <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-352"><a href="#Scheduler.run_single_image-352"><span class="linenos">352</span></a>                    <span class="p">)</span>
</span><span id="Scheduler.run_single_image-353"><a href="#Scheduler.run_single_image-353"><span class="linenos">353</span></a>                    <span class="n">cm</span> <span class="o">=</span> <span class="n">extract4stitched</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-354"><a href="#Scheduler.run_single_image-354"><span class="linenos">354</span></a>                        <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-355"><a href="#Scheduler.run_single_image-355"><span class="linenos">355</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-356"><a href="#Scheduler.run_single_image-356"><span class="linenos">356</span></a>                        <span class="n">m_naming</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-357"><a href="#Scheduler.run_single_image-357"><span class="linenos">357</span></a>                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-358"><a href="#Scheduler.run_single_image-358"><span class="linenos">358</span></a>                        <span class="n">detect_feature</span><span class="o">=</span><span class="kc">False</span>
</span><span id="Scheduler.run_single_image-359"><a href="#Scheduler.run_single_image-359"><span class="linenos">359</span></a>                    <span class="p">)</span>
</span><span id="Scheduler.run_single_image-360"><a href="#Scheduler.run_single_image-360"><span class="linenos">360</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tissue_segmentation</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-361"><a href="#Scheduler.run_single_image-361"><span class="linenos">361</span></a>                        <span class="n">run_tissue_seg</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-362"><a href="#Scheduler.run_single_image-362"><span class="linenos">362</span></a>                            <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-363"><a href="#Scheduler.run_single_image-363"><span class="linenos">363</span></a>                            <span class="n">image_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">heatmap</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-364"><a href="#Scheduler.run_single_image-364"><span class="linenos">364</span></a>                            <span class="n">save_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-365"><a href="#Scheduler.run_single_image-365"><span class="linenos">365</span></a>                            <span class="n">chip_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-366"><a href="#Scheduler.run_single_image-366"><span class="linenos">366</span></a>                            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-367"><a href="#Scheduler.run_single_image-367"><span class="linenos">367</span></a>                        <span class="p">)</span>
</span><span id="Scheduler.run_single_image-368"><a href="#Scheduler.run_single_image-368"><span class="linenos">368</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">cell_segmentation</span><span class="p">:</span>
</span><span id="Scheduler.run_single_image-369"><a href="#Scheduler.run_single_image-369"><span class="linenos">369</span></a>                        <span class="n">run_cell_seg</span><span class="p">(</span>
</span><span id="Scheduler.run_single_image-370"><a href="#Scheduler.run_single_image-370"><span class="linenos">370</span></a>                            <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-371"><a href="#Scheduler.run_single_image-371"><span class="linenos">371</span></a>                            <span class="n">image_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">heatmap</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-372"><a href="#Scheduler.run_single_image-372"><span class="linenos">372</span></a>                            <span class="n">save_path</span><span class="o">=</span><span class="n">cur_m_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-373"><a href="#Scheduler.run_single_image-373"><span class="linenos">373</span></a>                            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler.run_single_image-374"><a href="#Scheduler.run_single_image-374"><span class="linenos">374</span></a>                        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Process each single image in the pipeline.</p>

<p>This method iterates over each image file, performs necessary transformations,
and applies segmentation. It handles both cases where IPR data is available and
where it is not.</p>
</div>


                            </div>
                            <div id="Scheduler.run_mul_image" class="classattr">
                                        <input id="Scheduler.run_mul_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_mul_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scheduler.run_mul_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.run_mul_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.run_mul_image-376"><a href="#Scheduler.run_mul_image-376"><span class="linenos">376</span></a>    <span class="k">def</span> <span class="nf">run_mul_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scheduler.run_mul_image-377"><a href="#Scheduler.run_mul_image-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler.run_mul_image-378"><a href="#Scheduler.run_mul_image-378"><span class="linenos">378</span></a><span class="sd">        Process multiple images for registration.</span>
</span><span id="Scheduler.run_mul_image-379"><a href="#Scheduler.run_mul_image-379"><span class="linenos">379</span></a>
</span><span id="Scheduler.run_mul_image-380"><a href="#Scheduler.run_mul_image-380"><span class="linenos">380</span></a><span class="sd">        This method handles the registration of multiple images. It iterates over</span>
</span><span id="Scheduler.run_mul_image-381"><a href="#Scheduler.run_mul_image-381"><span class="linenos">381</span></a><span class="sd">        the files in self._files and processes only the images. If the image is</span>
</span><span id="Scheduler.run_mul_image-382"><a href="#Scheduler.run_mul_image-382"><span class="linenos">382</span></a><span class="sd">        registered, it performs the registration process. If not, it transforms</span>
</span><span id="Scheduler.run_mul_image-383"><a href="#Scheduler.run_mul_image-383"><span class="linenos">383</span></a><span class="sd">        the image to a registered format.</span>
</span><span id="Scheduler.run_mul_image-384"><a href="#Scheduler.run_mul_image-384"><span class="linenos">384</span></a>
</span><span id="Scheduler.run_mul_image-385"><a href="#Scheduler.run_mul_image-385"><span class="linenos">385</span></a><span class="sd">        :return: None</span>
</span><span id="Scheduler.run_mul_image-386"><a href="#Scheduler.run_mul_image-386"><span class="linenos">386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.run_mul_image-387"><a href="#Scheduler.run_mul_image-387"><span class="linenos">387</span></a>        <span class="c1"># 这里涉及多张图的配合，因为是配准。所以默认但张图的处理都结束了</span>
</span><span id="Scheduler.run_mul_image-388"><a href="#Scheduler.run_mul_image-388"><span class="linenos">388</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler.run_mul_image-389"><a href="#Scheduler.run_mul_image-389"><span class="linenos">389</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_image</span><span class="p">:</span>
</span><span id="Scheduler.run_mul_image-390"><a href="#Scheduler.run_mul_image-390"><span class="linenos">390</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  File[</span><span class="si">{}</span><span class="s1">] CellBin, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file_path</span><span class="p">))</span>
</span><span id="Scheduler.run_mul_image-391"><a href="#Scheduler.run_mul_image-391"><span class="linenos">391</span></a>                <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="Scheduler.run_mul_image-392"><a href="#Scheduler.run_mul_image-392"><span class="linenos">392</span></a>                <span class="n">cur_f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.run_mul_image-393"><a href="#Scheduler.run_mul_image-393"><span class="linenos">393</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-394"><a href="#Scheduler.run_mul_image-394"><span class="linenos">394</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-395"><a href="#Scheduler.run_mul_image-395"><span class="linenos">395</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler.run_mul_image-396"><a href="#Scheduler.run_mul_image-396"><span class="linenos">396</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run_mul_image-397"><a href="#Scheduler.run_mul_image-397"><span class="linenos">397</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run_mul_image-398"><a href="#Scheduler.run_mul_image-398"><span class="linenos">398</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler.run_mul_image-399"><a href="#Scheduler.run_mul_image-399"><span class="linenos">399</span></a>                        <span class="k">continue</span>
</span><span id="Scheduler.run_mul_image-400"><a href="#Scheduler.run_mul_image-400"><span class="linenos">400</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span>
</span><span id="Scheduler.run_mul_image-401"><a href="#Scheduler.run_mul_image-401"><span class="linenos">401</span></a>                        <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span><span class="p">]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler.run_mul_image-402"><a href="#Scheduler.run_mul_image-402"><span class="linenos">402</span></a>                        <span class="k">continue</span>
</span><span id="Scheduler.run_mul_image-403"><a href="#Scheduler.run_mul_image-403"><span class="linenos">403</span></a>                    <span class="n">run_register</span><span class="p">(</span>
</span><span id="Scheduler.run_mul_image-404"><a href="#Scheduler.run_mul_image-404"><span class="linenos">404</span></a>                        <span class="n">image_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-405"><a href="#Scheduler.run_mul_image-405"><span class="linenos">405</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-406"><a href="#Scheduler.run_mul_image-406"><span class="linenos">406</span></a>                        <span class="n">files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-407"><a href="#Scheduler.run_mul_image-407"><span class="linenos">407</span></a>                        <span class="n">channel_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-408"><a href="#Scheduler.run_mul_image-408"><span class="linenos">408</span></a>                        <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-409"><a href="#Scheduler.run_mul_image-409"><span class="linenos">409</span></a>                        <span class="n">param_chip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-410"><a href="#Scheduler.run_mul_image-410"><span class="linenos">410</span></a>                        <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler.run_mul_image-411"><a href="#Scheduler.run_mul_image-411"><span class="linenos">411</span></a>                        <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
</span><span id="Scheduler.run_mul_image-412"><a href="#Scheduler.run_mul_image-412"><span class="linenos">412</span></a>                    <span class="p">)</span>
</span><span id="Scheduler.run_mul_image-413"><a href="#Scheduler.run_mul_image-413"><span class="linenos">413</span></a>                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Scheduler.run_mul_image-414"><a href="#Scheduler.run_mul_image-414"><span class="linenos">414</span></a>                        <span class="n">fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span><span class="p">]</span>
</span><span id="Scheduler.run_mul_image-415"><a href="#Scheduler.run_mul_image-415"><span class="linenos">415</span></a>                        <span class="k">if</span> <span class="n">fixed</span><span class="o">.</span><span class="n">is_matrix</span><span class="p">:</span>
</span><span id="Scheduler.run_mul_image-416"><a href="#Scheduler.run_mul_image-416"><span class="linenos">416</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span><span class="p">]</span>
</span><span id="Scheduler.run_mul_image-417"><a href="#Scheduler.run_mul_image-417"><span class="linenos">417</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.run_mul_image-418"><a href="#Scheduler.run_mul_image-418"><span class="linenos">418</span></a>                    <span class="n">transform_to_register</span><span class="p">(</span>
</span><span id="Scheduler.run_mul_image-419"><a href="#Scheduler.run_mul_image-419"><span class="linenos">419</span></a>                        <span class="n">cur_f_name</span><span class="o">=</span><span class="n">cur_f_name</span>
</span><span id="Scheduler.run_mul_image-420"><a href="#Scheduler.run_mul_image-420"><span class="linenos">420</span></a>                    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Process multiple images for registration.</p>

<p>This method handles the registration of multiple images. It iterates over
the files in self._files and processes only the images. If the image is
registered, it performs the registration process. If not, it transforms
the image to a registered format.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="Scheduler.run_merge_masks" class="classattr">
                                        <input id="Scheduler.run_merge_masks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_merge_masks</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scheduler.run_merge_masks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.run_merge_masks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.run_merge_masks-422"><a href="#Scheduler.run_merge_masks-422"><span class="linenos">422</span></a>    <span class="k">def</span> <span class="nf">run_merge_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Scheduler.run_merge_masks-423"><a href="#Scheduler.run_merge_masks-423"><span class="linenos">423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler.run_merge_masks-424"><a href="#Scheduler.run_merge_masks-424"><span class="linenos">424</span></a><span class="sd">        This method processes and merges cell masks for each molecular classification file.</span>
</span><span id="Scheduler.run_merge_masks-425"><a href="#Scheduler.run_merge_masks-425"><span class="linenos">425</span></a><span class="sd">        It extracts the cell mask from the file, determines the naming convention, and merges</span>
</span><span id="Scheduler.run_merge_masks-426"><a href="#Scheduler.run_merge_masks-426"><span class="linenos">426</span></a><span class="sd">        the masks if necessary. Finally, it corrects the cell mask using the fast correction</span>
</span><span id="Scheduler.run_merge_masks-427"><a href="#Scheduler.run_merge_masks-427"><span class="linenos">427</span></a><span class="sd">        algorithm and saves the results.</span>
</span><span id="Scheduler.run_merge_masks-428"><a href="#Scheduler.run_merge_masks-428"><span class="linenos">428</span></a>
</span><span id="Scheduler.run_merge_masks-429"><a href="#Scheduler.run_merge_masks-429"><span class="linenos">429</span></a><span class="sd">        :return: None</span>
</span><span id="Scheduler.run_merge_masks-430"><a href="#Scheduler.run_merge_masks-430"><span class="linenos">430</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.run_merge_masks-431"><a href="#Scheduler.run_merge_masks-431"><span class="linenos">431</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecular_classify_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler.run_merge_masks-432"><a href="#Scheduler.run_merge_masks-432"><span class="linenos">432</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;======&gt;  Extract[</span><span class="si">{}</span><span class="s1">], </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
</span><span id="Scheduler.run_merge_masks-433"><a href="#Scheduler.run_merge_masks-433"><span class="linenos">433</span></a>            <span class="n">picked_mask</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">cell_mask</span>
</span><span id="Scheduler.run_merge_masks-434"><a href="#Scheduler.run_merge_masks-434"><span class="linenos">434</span></a>            <span class="n">final_nuclear_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_nuclear_mask</span>
</span><span id="Scheduler.run_merge_masks-435"><a href="#Scheduler.run_merge_masks-435"><span class="linenos">435</span></a>            <span class="n">final_t_mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_tissue_mask</span>
</span><span id="Scheduler.run_merge_masks-436"><a href="#Scheduler.run_merge_masks-436"><span class="linenos">436</span></a>            <span class="n">final_cell_mask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">final_cell_mask</span>
</span><span id="Scheduler.run_merge_masks-437"><a href="#Scheduler.run_merge_masks-437"><span class="linenos">437</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">picked_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Just one mask</span>
</span><span id="Scheduler.run_merge_masks-438"><a href="#Scheduler.run_merge_masks-438"><span class="linenos">438</span></a>                <span class="n">im_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.run_merge_masks-439"><a href="#Scheduler.run_merge_masks-439"><span class="linenos">439</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.run_merge_masks-440"><a href="#Scheduler.run_merge_masks-440"><span class="linenos">440</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="Scheduler.run_merge_masks-441"><a href="#Scheduler.run_merge_masks-441"><span class="linenos">441</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler.run_merge_masks-442"><a href="#Scheduler.run_merge_masks-442"><span class="linenos">442</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-443"><a href="#Scheduler.run_merge_masks-443"><span class="linenos">443</span></a>                <span class="n">to_fast</span> <span class="o">=</span> <span class="n">final_nuclear_path</span>
</span><span id="Scheduler.run_merge_masks-444"><a href="#Scheduler.run_merge_masks-444"><span class="linenos">444</span></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Two masks, assuming the first is the nuclear mask and the second is the membrane mask</span>
</span><span id="Scheduler.run_merge_masks-445"><a href="#Scheduler.run_merge_masks-445"><span class="linenos">445</span></a>                <span class="n">im_naming1</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.run_merge_masks-446"><a href="#Scheduler.run_merge_masks-446"><span class="linenos">446</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.run_merge_masks-447"><a href="#Scheduler.run_merge_masks-447"><span class="linenos">447</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="Scheduler.run_merge_masks-448"><a href="#Scheduler.run_merge_masks-448"><span class="linenos">448</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler.run_merge_masks-449"><a href="#Scheduler.run_merge_masks-449"><span class="linenos">449</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-450"><a href="#Scheduler.run_merge_masks-450"><span class="linenos">450</span></a>                <span class="n">im_naming2</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.run_merge_masks-451"><a href="#Scheduler.run_merge_masks-451"><span class="linenos">451</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.run_merge_masks-452"><a href="#Scheduler.run_merge_masks-452"><span class="linenos">452</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="n">picked_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">),</span>
</span><span id="Scheduler.run_merge_masks-453"><a href="#Scheduler.run_merge_masks-453"><span class="linenos">453</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler.run_merge_masks-454"><a href="#Scheduler.run_merge_masks-454"><span class="linenos">454</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-455"><a href="#Scheduler.run_merge_masks-455"><span class="linenos">455</span></a>                <span class="k">if</span> <span class="n">im_naming1</span><span class="o">.</span><span class="n">stain_type</span> <span class="o">==</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="Scheduler.run_merge_masks-456"><a href="#Scheduler.run_merge_masks-456"><span class="linenos">456</span></a>                    <span class="n">im_naming</span> <span class="o">=</span> <span class="n">im_naming2</span>
</span><span id="Scheduler.run_merge_masks-457"><a href="#Scheduler.run_merge_masks-457"><span class="linenos">457</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.run_merge_masks-458"><a href="#Scheduler.run_merge_masks-458"><span class="linenos">458</span></a>                    <span class="n">im_naming</span> <span class="o">=</span> <span class="n">im_naming1</span>
</span><span id="Scheduler.run_merge_masks-459"><a href="#Scheduler.run_merge_masks-459"><span class="linenos">459</span></a>                <span class="n">merged_cell_mask_path</span> <span class="o">=</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask_merged</span>
</span><span id="Scheduler.run_merge_masks-460"><a href="#Scheduler.run_merge_masks-460"><span class="linenos">460</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">merged_cell_mask_path</span><span class="p">):</span>
</span><span id="Scheduler.run_merge_masks-461"><a href="#Scheduler.run_merge_masks-461"><span class="linenos">461</span></a>                    <span class="kn">from</span> <span class="nn">cellbin2.contrib.mask_manager</span> <span class="kn">import</span> <span class="n">merge_cell_mask</span>
</span><span id="Scheduler.run_merge_masks-462"><a href="#Scheduler.run_merge_masks-462"><span class="linenos">462</span></a>                    <span class="c1"># TODO: Temporarily assume im_naming1 is the nuclear segmentation result,</span>
</span><span id="Scheduler.run_merge_masks-463"><a href="#Scheduler.run_merge_masks-463"><span class="linenos">463</span></a>                    <span class="c1">#       im_naming2 is the membrane segmentation result</span>
</span><span id="Scheduler.run_merge_masks-464"><a href="#Scheduler.run_merge_masks-464"><span class="linenos">464</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">im_naming1</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">im_naming2</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler.run_merge_masks-465"><a href="#Scheduler.run_merge_masks-465"><span class="linenos">465</span></a>                        <span class="k">continue</span>
</span><span id="Scheduler.run_merge_masks-466"><a href="#Scheduler.run_merge_masks-466"><span class="linenos">466</span></a>                    <span class="n">mask1</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">im_naming1</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-467"><a href="#Scheduler.run_merge_masks-467"><span class="linenos">467</span></a>                    <span class="n">mask2</span> <span class="o">=</span> <span class="n">cbimread</span><span class="p">(</span><span class="n">im_naming2</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">only_np</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-468"><a href="#Scheduler.run_merge_masks-468"><span class="linenos">468</span></a>                    <span class="n">merged_mask</span> <span class="o">=</span> <span class="n">merge_cell_mask</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-469"><a href="#Scheduler.run_merge_masks-469"><span class="linenos">469</span></a>                    <span class="n">cbimwrite</span><span class="p">(</span><span class="n">merged_cell_mask_path</span><span class="p">,</span> <span class="n">merged_mask</span><span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-470"><a href="#Scheduler.run_merge_masks-470"><span class="linenos">470</span></a>                <span class="n">to_fast</span> <span class="o">=</span> <span class="n">merged_cell_mask_path</span>
</span><span id="Scheduler.run_merge_masks-471"><a href="#Scheduler.run_merge_masks-471"><span class="linenos">471</span></a>            <span class="k">if</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler.run_merge_masks-472"><a href="#Scheduler.run_merge_masks-472"><span class="linenos">472</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">im_naming</span><span class="o">.</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">final_nuclear_path</span><span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-473"><a href="#Scheduler.run_merge_masks-473"><span class="linenos">473</span></a>            <span class="k">if</span> <span class="n">im_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler.run_merge_masks-474"><a href="#Scheduler.run_merge_masks-474"><span class="linenos">474</span></a>                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">im_naming</span><span class="o">.</span><span class="n">tissue_mask</span><span class="p">,</span> <span class="n">final_t_mask_path</span><span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-475"><a href="#Scheduler.run_merge_masks-475"><span class="linenos">475</span></a>            <span class="c1"># Here, we have the final cell mask and final tissue mask</span>
</span><span id="Scheduler.run_merge_masks-476"><a href="#Scheduler.run_merge_masks-476"><span class="linenos">476</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">final_cell_mask_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_fast</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler.run_merge_masks-477"><a href="#Scheduler.run_merge_masks-477"><span class="linenos">477</span></a>                <span class="n">fast_mask</span> <span class="o">=</span> <span class="n">run_fast_correct</span><span class="p">(</span>
</span><span id="Scheduler.run_merge_masks-478"><a href="#Scheduler.run_merge_masks-478"><span class="linenos">478</span></a>                    <span class="n">mask_path</span><span class="o">=</span><span class="n">to_fast</span><span class="p">,</span>
</span><span id="Scheduler.run_merge_masks-479"><a href="#Scheduler.run_merge_masks-479"><span class="linenos">479</span></a>                    <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_correct</span><span class="o">.</span><span class="n">expand_r</span><span class="p">,</span>
</span><span id="Scheduler.run_merge_masks-480"><a href="#Scheduler.run_merge_masks-480"><span class="linenos">480</span></a>                    <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cell_correct</span><span class="o">.</span><span class="n">process</span>
</span><span id="Scheduler.run_merge_masks-481"><a href="#Scheduler.run_merge_masks-481"><span class="linenos">481</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run_merge_masks-482"><a href="#Scheduler.run_merge_masks-482"><span class="linenos">482</span></a>                <span class="n">cbimwrite</span><span class="p">(</span><span class="n">final_cell_mask_path</span><span class="p">,</span> <span class="n">fast_mask</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This method processes and merges cell masks for each molecular classification file.
It extracts the cell mask from the file, determines the naming convention, and merges
the masks if necessary. Finally, it corrects the cell mask using the fast correction
algorithm and saves the results.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="Scheduler.run" class="classattr">
                                        <input id="Scheduler.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">ipr_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">kit</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span>,</span><span class="param">	<span class="n">research_mode</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scheduler.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.run-484"><a href="#Scheduler.run-484"><span class="linenos">484</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scheduler.run-485"><a href="#Scheduler.run-485"><span class="linenos">485</span></a>            <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scheduler.run-486"><a href="#Scheduler.run-486"><span class="linenos">486</span></a>            <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ipr_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Scheduler.run-487"><a href="#Scheduler.run-487"><span class="linenos">487</span></a>            <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">research_mode</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="Scheduler.run-488"><a href="#Scheduler.run-488"><span class="linenos">488</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler.run-489"><a href="#Scheduler.run-489"><span class="linenos">489</span></a><span class="sd">        Run the main pipeline for processing the images.</span>
</span><span id="Scheduler.run-490"><a href="#Scheduler.run-490"><span class="linenos">490</span></a>
</span><span id="Scheduler.run-491"><a href="#Scheduler.run-491"><span class="linenos">491</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler.run-492"><a href="#Scheduler.run-492"><span class="linenos">492</span></a><span class="sd">            chip_no (str): The serial number of the chip.</span>
</span><span id="Scheduler.run-493"><a href="#Scheduler.run-493"><span class="linenos">493</span></a><span class="sd">            input_image (str): The path to the input image file.</span>
</span><span id="Scheduler.run-494"><a href="#Scheduler.run-494"><span class="linenos">494</span></a><span class="sd">            stain_type (str): The type of stain used in the image.</span>
</span><span id="Scheduler.run-495"><a href="#Scheduler.run-495"><span class="linenos">495</span></a><span class="sd">            param_file (str): The path to the parameter file.</span>
</span><span id="Scheduler.run-496"><a href="#Scheduler.run-496"><span class="linenos">496</span></a><span class="sd">            output_path (str): The directory where the output files will be saved.</span>
</span><span id="Scheduler.run-497"><a href="#Scheduler.run-497"><span class="linenos">497</span></a><span class="sd">            ipr_path (str): The path to the image process record file.</span>
</span><span id="Scheduler.run-498"><a href="#Scheduler.run-498"><span class="linenos">498</span></a><span class="sd">            matrix_path (str): The path to the matrix file.</span>
</span><span id="Scheduler.run-499"><a href="#Scheduler.run-499"><span class="linenos">499</span></a><span class="sd">            kit (str): The type of kit used (e.g., Transcriptomics, Protein).</span>
</span><span id="Scheduler.run-500"><a href="#Scheduler.run-500"><span class="linenos">500</span></a><span class="sd">            debug (bool): Flag to enable debug mode.</span>
</span><span id="Scheduler.run-501"><a href="#Scheduler.run-501"><span class="linenos">501</span></a><span class="sd">            research_mode (bool): Flag to enable research mode.</span>
</span><span id="Scheduler.run-502"><a href="#Scheduler.run-502"><span class="linenos">502</span></a>
</span><span id="Scheduler.run-503"><a href="#Scheduler.run-503"><span class="linenos">503</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler.run-504"><a href="#Scheduler.run-504"><span class="linenos">504</span></a><span class="sd">            None</span>
</span><span id="Scheduler.run-505"><a href="#Scheduler.run-505"><span class="linenos">505</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.run-506"><a href="#Scheduler.run-506"><span class="linenos">506</span></a>
</span><span id="Scheduler.run-507"><a href="#Scheduler.run-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">output_path</span>
</span><span id="Scheduler.run-508"><a href="#Scheduler.run-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="Scheduler.run-509"><a href="#Scheduler.run-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">research_mode</span> <span class="o">=</span> <span class="n">research_mode</span>
</span><span id="Scheduler.run-510"><a href="#Scheduler.run-510"><span class="linenos">510</span></a>        <span class="c1"># Load chip information</span>
</span><span id="Scheduler.run-511"><a href="#Scheduler.run-511"><span class="linenos">511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">parse_info</span><span class="p">(</span><span class="n">chip_no</span><span class="p">)</span>
</span><span id="Scheduler.run-512"><a href="#Scheduler.run-512"><span class="linenos">512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="Scheduler.run-513"><a href="#Scheduler.run-513"><span class="linenos">513</span></a>
</span><span id="Scheduler.run-514"><a href="#Scheduler.run-514"><span class="linenos">514</span></a>        <span class="c1"># Load data</span>
</span><span id="Scheduler.run-515"><a href="#Scheduler.run-515"><span class="linenos">515</span></a>        <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span>
</span><span id="Scheduler.run-516"><a href="#Scheduler.run-516"><span class="linenos">516</span></a>            <span class="n">file_path</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span>
</span><span id="Scheduler.run-517"><a href="#Scheduler.run-517"><span class="linenos">517</span></a>            <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
</span><span id="Scheduler.run-518"><a href="#Scheduler.run-518"><span class="linenos">518</span></a>            <span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">input_json</span>
</span><span id="Scheduler.run-519"><a href="#Scheduler.run-519"><span class="linenos">519</span></a>        <span class="p">)</span>
</span><span id="Scheduler.run-520"><a href="#Scheduler.run-520"><span class="linenos">520</span></a>
</span><span id="Scheduler.run-521"><a href="#Scheduler.run-521"><span class="linenos">521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Scheduler.run-522"><a href="#Scheduler.run-522"><span class="linenos">522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">molecular_classify_files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span>
</span><span id="Scheduler.run-523"><a href="#Scheduler.run-523"><span class="linenos">523</span></a>        <span class="n">pp</span><span class="o">.</span><span class="n">print_files_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;Scheduler&#39;</span><span class="p">)</span>
</span><span id="Scheduler.run-524"><a href="#Scheduler.run-524"><span class="linenos">524</span></a>
</span><span id="Scheduler.run-525"><a href="#Scheduler.run-525"><span class="linenos">525</span></a>        <span class="c1"># Exit if data validation fails</span>
</span><span id="Scheduler.run-526"><a href="#Scheduler.run-526"><span class="linenos">526</span></a>        <span class="n">flag1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_check</span><span class="p">()</span>
</span><span id="Scheduler.run-527"><a href="#Scheduler.run-527"><span class="linenos">527</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
</span><span id="Scheduler.run-528"><a href="#Scheduler.run-528"><span class="linenos">528</span></a>            <span class="k">return</span> <span class="mi">1</span>
</span><span id="Scheduler.run-529"><a href="#Scheduler.run-529"><span class="linenos">529</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Scheduler.run-530"><a href="#Scheduler.run-530"><span class="linenos">530</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ipr_path</span><span class="p">):</span>
</span><span id="Scheduler.run-531"><a href="#Scheduler.run-531"><span class="linenos">531</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ipr_path</span><span class="p">)</span>
</span><span id="Scheduler.run-532"><a href="#Scheduler.run-532"><span class="linenos">532</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.run-533"><a href="#Scheduler.run-533"><span class="linenos">533</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No existing ipr founded, assumes qc has not been done before&quot;</span><span class="p">)</span>
</span><span id="Scheduler.run-534"><a href="#Scheduler.run-534"><span class="linenos">534</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Scheduler.run-535"><a href="#Scheduler.run-535"><span class="linenos">535</span></a>
</span><span id="Scheduler.run-536"><a href="#Scheduler.run-536"><span class="linenos">536</span></a>        <span class="c1"># Load model</span>
</span><span id="Scheduler.run-537"><a href="#Scheduler.run-537"><span class="linenos">537</span></a>        <span class="n">flag2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_check</span><span class="p">()</span>
</span><span id="Scheduler.run-538"><a href="#Scheduler.run-538"><span class="linenos">538</span></a>        <span class="k">if</span> <span class="n">flag2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Scheduler.run-539"><a href="#Scheduler.run-539"><span class="linenos">539</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Scheduler.run-540"><a href="#Scheduler.run-540"><span class="linenos">540</span></a>
</span><span id="Scheduler.run-541"><a href="#Scheduler.run-541"><span class="linenos">541</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_single_image</span><span class="p">()</span>  <span class="c1"># Process a single image (transform -&gt; tissue seg -&gt; cellseg)</span>
</span><span id="Scheduler.run-542"><a href="#Scheduler.run-542"><span class="linenos">542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_mul_image</span><span class="p">()</span>  <span class="c1"># Register images</span>
</span><span id="Scheduler.run-543"><a href="#Scheduler.run-543"><span class="linenos">543</span></a>
</span><span id="Scheduler.run-544"><a href="#Scheduler.run-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run-545"><a href="#Scheduler.run-545"><span class="linenos">545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_ipr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">)</span>
</span><span id="Scheduler.run-546"><a href="#Scheduler.run-546"><span class="linenos">546</span></a>
</span><span id="Scheduler.run-547"><a href="#Scheduler.run-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_merge_masks</span><span class="p">()</span>  <span class="c1"># Merge multiple masks if needed</span>
</span><span id="Scheduler.run-548"><a href="#Scheduler.run-548"><span class="linenos">548</span></a>
</span><span id="Scheduler.run-549"><a href="#Scheduler.run-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">flag1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
</span><span id="Scheduler.run-550"><a href="#Scheduler.run-550"><span class="linenos">550</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dump_rpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">)</span>
</span><span id="Scheduler.run-551"><a href="#Scheduler.run-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="n">research_mode</span><span class="p">:</span>
</span><span id="Scheduler.run-552"><a href="#Scheduler.run-552"><span class="linenos">552</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler.run-553"><a href="#Scheduler.run-553"><span class="linenos">553</span></a>                <span class="n">update_ipr_in_tar</span><span class="p">(</span>
</span><span id="Scheduler.run-554"><a href="#Scheduler.run-554"><span class="linenos">554</span></a>                    <span class="n">tar_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="p">,</span>
</span><span id="Scheduler.run-555"><a href="#Scheduler.run-555"><span class="linenos">555</span></a>                    <span class="n">ipr_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">,</span>
</span><span id="Scheduler.run-556"><a href="#Scheduler.run-556"><span class="linenos">556</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run-557"><a href="#Scheduler.run-557"><span class="linenos">557</span></a>
</span><span id="Scheduler.run-558"><a href="#Scheduler.run-558"><span class="linenos">558</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run-559"><a href="#Scheduler.run-559"><span class="linenos">559</span></a>                <span class="n">matrix_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.run-560"><a href="#Scheduler.run-560"><span class="linenos">560</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="Scheduler.run-561"><a href="#Scheduler.run-561"><span class="linenos">561</span></a>                    <span class="n">m_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix_file</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Scheduler.run-562"><a href="#Scheduler.run-562"><span class="linenos">562</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="n">output_path</span>
</span><span id="Scheduler.run-563"><a href="#Scheduler.run-563"><span class="linenos">563</span></a>                <span class="p">)</span>
</span><span id="Scheduler.run-564"><a href="#Scheduler.run-564"><span class="linenos">564</span></a>                <span class="n">matrix_template</span> <span class="o">=</span> <span class="n">matrix_naming</span><span class="o">.</span><span class="n">matrix_template</span>
</span><span id="Scheduler.run-565"><a href="#Scheduler.run-565"><span class="linenos">565</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.run-566"><a href="#Scheduler.run-566"><span class="linenos">566</span></a>                <span class="n">matrix_template</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Scheduler.run-567"><a href="#Scheduler.run-567"><span class="linenos">567</span></a>
</span><span id="Scheduler.run-568"><a href="#Scheduler.run-568"><span class="linenos">568</span></a>            <span class="n">generate_stereo_file</span><span class="p">(</span>
</span><span id="Scheduler.run-569"><a href="#Scheduler.run-569"><span class="linenos">569</span></a>                <span class="n">registered_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">,</span>
</span><span id="Scheduler.run-570"><a href="#Scheduler.run-570"><span class="linenos">570</span></a>                <span class="n">compressed_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">tar_gz</span><span class="p">,</span>
</span><span id="Scheduler.run-571"><a href="#Scheduler.run-571"><span class="linenos">571</span></a>                <span class="n">matrix_template</span><span class="o">=</span><span class="n">matrix_template</span><span class="p">,</span>
</span><span id="Scheduler.run-572"><a href="#Scheduler.run-572"><span class="linenos">572</span></a>                <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="n">stereo</span><span class="p">,</span>
</span><span id="Scheduler.run-573"><a href="#Scheduler.run-573"><span class="linenos">573</span></a>                <span class="n">sn</span><span class="o">=</span><span class="n">chip_no</span>
</span><span id="Scheduler.run-574"><a href="#Scheduler.run-574"><span class="linenos">574</span></a>            <span class="p">)</span>
</span><span id="Scheduler.run-575"><a href="#Scheduler.run-575"><span class="linenos">575</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span id="Scheduler.run-576"><a href="#Scheduler.run-576"><span class="linenos">576</span></a>            <span class="n">f_to_keep</span> <span class="o">=</span> <span class="n">FILES_TO_KEEP_RESEARCH</span> <span class="k">if</span> <span class="n">research_mode</span> <span class="k">else</span> <span class="n">FILES_TO_KEEP</span>
</span><span id="Scheduler.run-577"><a href="#Scheduler.run-577"><span class="linenos">577</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">del_files</span><span class="p">(</span><span class="n">f_to_keep</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run the main pipeline for processing the images.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>chip_no (str):</strong>  The serial number of the chip.</li>
<li><strong>input_image (str):</strong>  The path to the input image file.</li>
<li><strong>stain_type (str):</strong>  The type of stain used in the image.</li>
<li><strong>param_file (str):</strong>  The path to the parameter file.</li>
<li><strong>output_path (str):</strong>  The directory where the output files will be saved.</li>
<li><strong>ipr_path (str):</strong>  The path to the image process record file.</li>
<li><strong>matrix_path (str):</strong>  The path to the matrix file.</li>
<li><strong>kit (str):</strong>  The type of kit used (e.g., Transcriptomics, Protein).</li>
<li><strong>debug (bool):</strong>  Flag to enable debug mode.</li>
<li><strong>research_mode (bool):</strong>  Flag to enable research mode.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="Scheduler.del_files" class="classattr">
                                        <input id="Scheduler.del_files-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">del_files</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">f_to_keep</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Scheduler.del_files-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.del_files"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.del_files-579"><a href="#Scheduler.del_files-579"><span class="linenos">579</span></a>    <span class="k">def</span> <span class="nf">del_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_to_keep</span><span class="p">):</span>
</span><span id="Scheduler.del_files-580"><a href="#Scheduler.del_files-580"><span class="linenos">580</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Scheduler.del_files-581"><a href="#Scheduler.del_files-581"><span class="linenos">581</span></a><span class="sd">        Deletes files from the output directory, excluding those specified to be kept.</span>
</span><span id="Scheduler.del_files-582"><a href="#Scheduler.del_files-582"><span class="linenos">582</span></a>
</span><span id="Scheduler.del_files-583"><a href="#Scheduler.del_files-583"><span class="linenos">583</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler.del_files-584"><a href="#Scheduler.del_files-584"><span class="linenos">584</span></a><span class="sd">            f_to_keep (list): List of file properties that should not be deleted.</span>
</span><span id="Scheduler.del_files-585"><a href="#Scheduler.del_files-585"><span class="linenos">585</span></a>
</span><span id="Scheduler.del_files-586"><a href="#Scheduler.del_files-586"><span class="linenos">586</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler.del_files-587"><a href="#Scheduler.del_files-587"><span class="linenos">587</span></a><span class="sd">            None</span>
</span><span id="Scheduler.del_files-588"><a href="#Scheduler.del_files-588"><span class="linenos">588</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.del_files-589"><a href="#Scheduler.del_files-589"><span class="linenos">589</span></a>        <span class="c1"># List to store all file paths</span>
</span><span id="Scheduler.del_files-590"><a href="#Scheduler.del_files-590"><span class="linenos">590</span></a>        <span class="n">all_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler.del_files-591"><a href="#Scheduler.del_files-591"><span class="linenos">591</span></a>        <span class="c1"># List to store file paths that should be kept</span>
</span><span id="Scheduler.del_files-592"><a href="#Scheduler.del_files-592"><span class="linenos">592</span></a>        <span class="n">k_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler.del_files-593"><a href="#Scheduler.del_files-593"><span class="linenos">593</span></a>        <span class="c1"># List to store file paths that should be removed</span>
</span><span id="Scheduler.del_files-594"><a href="#Scheduler.del_files-594"><span class="linenos">594</span></a>        <span class="n">remove_</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Scheduler.del_files-595"><a href="#Scheduler.del_files-595"><span class="linenos">595</span></a>        
</span><span id="Scheduler.del_files-596"><a href="#Scheduler.del_files-596"><span class="linenos">596</span></a>        <span class="c1"># Iterate over files in self._files</span>
</span><span id="Scheduler.del_files-597"><a href="#Scheduler.del_files-597"><span class="linenos">597</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler.del_files-598"><a href="#Scheduler.del_files-598"><span class="linenos">598</span></a>            <span class="c1"># Get group name for the file</span>
</span><span id="Scheduler.del_files-599"><a href="#Scheduler.del_files-599"><span class="linenos">599</span></a>            <span class="n">g_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">)</span>
</span><span id="Scheduler.del_files-600"><a href="#Scheduler.del_files-600"><span class="linenos">600</span></a>            
</span><span id="Scheduler.del_files-601"><a href="#Scheduler.del_files-601"><span class="linenos">601</span></a>            <span class="c1"># Check if the file is a matrix</span>
</span><span id="Scheduler.del_files-602"><a href="#Scheduler.del_files-602"><span class="linenos">602</span></a>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_matrix</span><span class="p">:</span>
</span><span id="Scheduler.del_files-603"><a href="#Scheduler.del_files-603"><span class="linenos">603</span></a>                <span class="c1"># Create DumpMatrixFileNaming object for matrix files</span>
</span><span id="Scheduler.del_files-604"><a href="#Scheduler.del_files-604"><span class="linenos">604</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.del_files-605"><a href="#Scheduler.del_files-605"><span class="linenos">605</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.del_files-606"><a href="#Scheduler.del_files-606"><span class="linenos">606</span></a>                    <span class="n">m_type</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Scheduler.del_files-607"><a href="#Scheduler.del_files-607"><span class="linenos">607</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="Scheduler.del_files-608"><a href="#Scheduler.del_files-608"><span class="linenos">608</span></a>                <span class="p">)</span>
</span><span id="Scheduler.del_files-609"><a href="#Scheduler.del_files-609"><span class="linenos">609</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.del_files-610"><a href="#Scheduler.del_files-610"><span class="linenos">610</span></a>                <span class="c1"># Create DumpImageFileNaming object for image files</span>
</span><span id="Scheduler.del_files-611"><a href="#Scheduler.del_files-611"><span class="linenos">611</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="Scheduler.del_files-612"><a href="#Scheduler.del_files-612"><span class="linenos">612</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param_chip</span><span class="o">.</span><span class="n">chip_name</span><span class="p">,</span>
</span><span id="Scheduler.del_files-613"><a href="#Scheduler.del_files-613"><span class="linenos">613</span></a>                    <span class="n">stain_type</span><span class="o">=</span><span class="n">g_name</span><span class="p">,</span>
</span><span id="Scheduler.del_files-614"><a href="#Scheduler.del_files-614"><span class="linenos">614</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="Scheduler.del_files-615"><a href="#Scheduler.del_files-615"><span class="linenos">615</span></a>                <span class="p">)</span>
</span><span id="Scheduler.del_files-616"><a href="#Scheduler.del_files-616"><span class="linenos">616</span></a>            
</span><span id="Scheduler.del_files-617"><a href="#Scheduler.del_files-617"><span class="linenos">617</span></a>            <span class="c1"># Iterate over attributes of the file naming object</span>
</span><span id="Scheduler.del_files-618"><a href="#Scheduler.del_files-618"><span class="linenos">618</span></a>            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">f_name</span><span class="p">):</span>
</span><span id="Scheduler.del_files-619"><a href="#Scheduler.del_files-619"><span class="linenos">619</span></a>                <span class="n">att</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="Scheduler.del_files-620"><a href="#Scheduler.del_files-620"><span class="linenos">620</span></a>                <span class="n">pt</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="Scheduler.del_files-621"><a href="#Scheduler.del_files-621"><span class="linenos">621</span></a>                
</span><span id="Scheduler.del_files-622"><a href="#Scheduler.del_files-622"><span class="linenos">622</span></a>                <span class="c1"># Check if the attribute is a property and the file exists</span>
</span><span id="Scheduler.del_files-623"><a href="#Scheduler.del_files-623"><span class="linenos">623</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="ow">and</span> <span class="n">att</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler.del_files-624"><a href="#Scheduler.del_files-624"><span class="linenos">624</span></a>                    <span class="n">all_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="Scheduler.del_files-625"><a href="#Scheduler.del_files-625"><span class="linenos">625</span></a>                    
</span><span id="Scheduler.del_files-626"><a href="#Scheduler.del_files-626"><span class="linenos">626</span></a>                    <span class="c1"># Check if the file should be removed or kept</span>
</span><span id="Scheduler.del_files-627"><a href="#Scheduler.del_files-627"><span class="linenos">627</span></a>                    <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_to_keep</span><span class="p">:</span>
</span><span id="Scheduler.del_files-628"><a href="#Scheduler.del_files-628"><span class="linenos">628</span></a>                        <span class="n">remove_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="Scheduler.del_files-629"><a href="#Scheduler.del_files-629"><span class="linenos">629</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.del_files-630"><a href="#Scheduler.del_files-630"><span class="linenos">630</span></a>                        <span class="n">k_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
</span><span id="Scheduler.del_files-631"><a href="#Scheduler.del_files-631"><span class="linenos">631</span></a>        
</span><span id="Scheduler.del_files-632"><a href="#Scheduler.del_files-632"><span class="linenos">632</span></a>        <span class="c1"># Iterate over attributes of self.p_naming</span>
</span><span id="Scheduler.del_files-633"><a href="#Scheduler.del_files-633"><span class="linenos">633</span></a>        <span class="k">for</span> <span class="n">p_p</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">):</span>
</span><span id="Scheduler.del_files-634"><a href="#Scheduler.del_files-634"><span class="linenos">634</span></a>            <span class="n">p_att</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="p">,</span> <span class="n">p_p</span><span class="p">)</span>
</span><span id="Scheduler.del_files-635"><a href="#Scheduler.del_files-635"><span class="linenos">635</span></a>            <span class="n">p_pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_naming</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_p</span><span class="p">)</span>
</span><span id="Scheduler.del_files-636"><a href="#Scheduler.del_files-636"><span class="linenos">636</span></a>            
</span><span id="Scheduler.del_files-637"><a href="#Scheduler.del_files-637"><span class="linenos">637</span></a>            <span class="c1"># Check if the attribute is a property and the file exists</span>
</span><span id="Scheduler.del_files-638"><a href="#Scheduler.del_files-638"><span class="linenos">638</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_pt</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p_att</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Scheduler.del_files-639"><a href="#Scheduler.del_files-639"><span class="linenos">639</span></a>                <span class="n">all_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="Scheduler.del_files-640"><a href="#Scheduler.del_files-640"><span class="linenos">640</span></a>                
</span><span id="Scheduler.del_files-641"><a href="#Scheduler.del_files-641"><span class="linenos">641</span></a>                <span class="c1"># Check if the file should be removed or kept</span>
</span><span id="Scheduler.del_files-642"><a href="#Scheduler.del_files-642"><span class="linenos">642</span></a>                <span class="k">if</span> <span class="n">p_pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_to_keep</span><span class="p">:</span>
</span><span id="Scheduler.del_files-643"><a href="#Scheduler.del_files-643"><span class="linenos">643</span></a>                    <span class="n">remove_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="Scheduler.del_files-644"><a href="#Scheduler.del_files-644"><span class="linenos">644</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Scheduler.del_files-645"><a href="#Scheduler.del_files-645"><span class="linenos">645</span></a>                    <span class="n">k_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_att</span><span class="p">)</span>
</span><span id="Scheduler.del_files-646"><a href="#Scheduler.del_files-646"><span class="linenos">646</span></a>        
</span><span id="Scheduler.del_files-647"><a href="#Scheduler.del_files-647"><span class="linenos">647</span></a>        <span class="c1"># Iterate over files in the output directory</span>
</span><span id="Scheduler.del_files-648"><a href="#Scheduler.del_files-648"><span class="linenos">648</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">):</span>
</span><span id="Scheduler.del_files-649"><a href="#Scheduler.del_files-649"><span class="linenos">649</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="Scheduler.del_files-650"><a href="#Scheduler.del_files-650"><span class="linenos">650</span></a>            
</span><span id="Scheduler.del_files-651"><a href="#Scheduler.del_files-651"><span class="linenos">651</span></a>            <span class="c1"># Remove the file if it is in the remove_ list</span>
</span><span id="Scheduler.del_files-652"><a href="#Scheduler.del_files-652"><span class="linenos">652</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">remove_</span><span class="p">:</span>
</span><span id="Scheduler.del_files-653"><a href="#Scheduler.del_files-653"><span class="linenos">653</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Deletes files from the output directory, excluding those specified to be kept.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>f_to_keep (list):</strong>  List of file properties that should not be deleted.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="scheduler_pipeline">
                            <input id="scheduler_pipeline-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">scheduler_pipeline</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">ipr_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">kit</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">research_mode</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="scheduler_pipeline-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#scheduler_pipeline"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="scheduler_pipeline-656"><a href="#scheduler_pipeline-656"><span class="linenos">656</span></a><span class="k">def</span> <span class="nf">scheduler_pipeline</span><span class="p">(</span><span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="scheduler_pipeline-657"><a href="#scheduler_pipeline-657"><span class="linenos">657</span></a>                       <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ipr_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="scheduler_pipeline-658"><a href="#scheduler_pipeline-658"><span class="linenos">658</span></a>                       <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">research_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="scheduler_pipeline-659"><a href="#scheduler_pipeline-659"><span class="linenos">659</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="scheduler_pipeline-660"><a href="#scheduler_pipeline-660"><span class="linenos">660</span></a><span class="sd">    This function serves as the main pipeline for scheduling the image processing tasks.</span>
</span><span id="scheduler_pipeline-661"><a href="#scheduler_pipeline-661"><span class="linenos">661</span></a>
</span><span id="scheduler_pipeline-662"><a href="#scheduler_pipeline-662"><span class="linenos">662</span></a><span class="sd">    Args:</span>
</span><span id="scheduler_pipeline-663"><a href="#scheduler_pipeline-663"><span class="linenos">663</span></a><span class="sd">        weights_root (str): Local directory path for storing CNN weight files.</span>
</span><span id="scheduler_pipeline-664"><a href="#scheduler_pipeline-664"><span class="linenos">664</span></a><span class="sd">        chip_no (str): Sample chip number.</span>
</span><span id="scheduler_pipeline-665"><a href="#scheduler_pipeline-665"><span class="linenos">665</span></a><span class="sd">        input_image (str): Local path of the stained image.</span>
</span><span id="scheduler_pipeline-666"><a href="#scheduler_pipeline-666"><span class="linenos">666</span></a><span class="sd">        stain_type (str): Staining type corresponding to the stained image.</span>
</span><span id="scheduler_pipeline-667"><a href="#scheduler_pipeline-667"><span class="linenos">667</span></a><span class="sd">        param_file (str): Local path of the parameter file.</span>
</span><span id="scheduler_pipeline-668"><a href="#scheduler_pipeline-668"><span class="linenos">668</span></a><span class="sd">        output_path (str): Local directory path for storing output files.</span>
</span><span id="scheduler_pipeline-669"><a href="#scheduler_pipeline-669"><span class="linenos">669</span></a><span class="sd">        matrix_path (str): Local directory path for storing the expression matrix.</span>
</span><span id="scheduler_pipeline-670"><a href="#scheduler_pipeline-670"><span class="linenos">670</span></a><span class="sd">        ipr_path (str): Local directory path for storing the image processing record file.</span>
</span><span id="scheduler_pipeline-671"><a href="#scheduler_pipeline-671"><span class="linenos">671</span></a><span class="sd">        kit (str): Kit type (e.g., Transcriptomics, Protein).</span>
</span><span id="scheduler_pipeline-672"><a href="#scheduler_pipeline-672"><span class="linenos">672</span></a><span class="sd">        debug (bool, optional): Debug mode flag. Defaults to False.</span>
</span><span id="scheduler_pipeline-673"><a href="#scheduler_pipeline-673"><span class="linenos">673</span></a><span class="sd">        research_mode (bool, optional): Research mode flag. Defaults to False.</span>
</span><span id="scheduler_pipeline-674"><a href="#scheduler_pipeline-674"><span class="linenos">674</span></a>
</span><span id="scheduler_pipeline-675"><a href="#scheduler_pipeline-675"><span class="linenos">675</span></a><span class="sd">    Returns:</span>
</span><span id="scheduler_pipeline-676"><a href="#scheduler_pipeline-676"><span class="linenos">676</span></a><span class="sd">        int: Status code.</span>
</span><span id="scheduler_pipeline-677"><a href="#scheduler_pipeline-677"><span class="linenos">677</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="scheduler_pipeline-678"><a href="#scheduler_pipeline-678"><span class="linenos">678</span></a>    <span class="n">curr_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="scheduler_pipeline-679"><a href="#scheduler_pipeline-679"><span class="linenos">679</span></a>    <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;../config/cellbin.yaml&#39;</span><span class="p">)</span>
</span><span id="scheduler_pipeline-680"><a href="#scheduler_pipeline-680"><span class="linenos">680</span></a>    <span class="n">chip_mask_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;../config/chip_mask.json&#39;</span><span class="p">)</span>
</span><span id="scheduler_pipeline-681"><a href="#scheduler_pipeline-681"><span class="linenos">681</span></a>
</span><span id="scheduler_pipeline-682"><a href="#scheduler_pipeline-682"><span class="linenos">682</span></a>    <span class="c1"># Initialize the Scheduler with configuration and weights</span>
</span><span id="scheduler_pipeline-683"><a href="#scheduler_pipeline-683"><span class="linenos">683</span></a>    <span class="n">iqc</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="o">=</span><span class="n">chip_mask_file</span><span class="p">,</span> <span class="n">weights_root</span><span class="o">=</span><span class="n">weights_root</span><span class="p">)</span>
</span><span id="scheduler_pipeline-684"><a href="#scheduler_pipeline-684"><span class="linenos">684</span></a>    <span class="c1"># Run the main pipeline with the provided parameters</span>
</span><span id="scheduler_pipeline-685"><a href="#scheduler_pipeline-685"><span class="linenos">685</span></a>    <span class="n">iqc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="scheduler_pipeline-686"><a href="#scheduler_pipeline-686"><span class="linenos">686</span></a>            <span class="n">input_image</span><span class="o">=</span><span class="n">input_image</span><span class="p">,</span>
</span><span id="scheduler_pipeline-687"><a href="#scheduler_pipeline-687"><span class="linenos">687</span></a>            <span class="n">stain_type</span><span class="o">=</span><span class="n">stain_type</span><span class="p">,</span>
</span><span id="scheduler_pipeline-688"><a href="#scheduler_pipeline-688"><span class="linenos">688</span></a>            <span class="n">param_file</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span>
</span><span id="scheduler_pipeline-689"><a href="#scheduler_pipeline-689"><span class="linenos">689</span></a>            <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
</span><span id="scheduler_pipeline-690"><a href="#scheduler_pipeline-690"><span class="linenos">690</span></a>            <span class="n">ipr_path</span><span class="o">=</span><span class="n">ipr_path</span><span class="p">,</span>
</span><span id="scheduler_pipeline-691"><a href="#scheduler_pipeline-691"><span class="linenos">691</span></a>            <span class="n">matrix_path</span><span class="o">=</span><span class="n">matrix_path</span><span class="p">,</span> <span class="n">kit</span><span class="o">=</span><span class="n">kit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">research_mode</span><span class="o">=</span><span class="n">research_mode</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This function serves as the main pipeline for scheduling the image processing tasks.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>weights_root (str):</strong>  Local directory path for storing CNN weight files.</li>
<li><strong>chip_no (str):</strong>  Sample chip number.</li>
<li><strong>input_image (str):</strong>  Local path of the stained image.</li>
<li><strong>stain_type (str):</strong>  Staining type corresponding to the stained image.</li>
<li><strong>param_file (str):</strong>  Local path of the parameter file.</li>
<li><strong>output_path (str):</strong>  Local directory path for storing output files.</li>
<li><strong>matrix_path (str):</strong>  Local directory path for storing the expression matrix.</li>
<li><strong>ipr_path (str):</strong>  Local directory path for storing the image processing record file.</li>
<li><strong>kit (str):</strong>  Kit type (e.g., Transcriptomics, Protein).</li>
<li><strong>debug (bool, optional):</strong>  Debug mode flag. Defaults to False.</li>
<li><strong>research_mode (bool, optional):</strong>  Research mode flag. Defaults to False.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: Status code.</p>
</blockquote>
</div>


                </section>
                <section id="main">
                            <input id="main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">main</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">args</span>, </span><span class="param"><span class="n">para</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="main-694"><a href="#main-694"><span class="linenos">694</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">para</span><span class="p">):</span>
</span><span id="main-695"><a href="#main-695"><span class="linenos">695</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="main-696"><a href="#main-696"><span class="linenos">696</span></a><span class="sd">    The main function that initializes and runs the scheduler pipeline.</span>
</span><span id="main-697"><a href="#main-697"><span class="linenos">697</span></a>
</span><span id="main-698"><a href="#main-698"><span class="linenos">698</span></a><span class="sd">    Args:</span>
</span><span id="main-699"><a href="#main-699"><span class="linenos">699</span></a><span class="sd">        args (argparse.Namespace): Parsed command - line arguments containing the configuration and input data.</span>
</span><span id="main-700"><a href="#main-700"><span class="linenos">700</span></a><span class="sd">        para (dict): Additional parameters required for the pipeline.</span>
</span><span id="main-701"><a href="#main-701"><span class="linenos">701</span></a>
</span><span id="main-702"><a href="#main-702"><span class="linenos">702</span></a><span class="sd">    Returns:</span>
</span><span id="main-703"><a href="#main-703"><span class="linenos">703</span></a><span class="sd">        None</span>
</span><span id="main-704"><a href="#main-704"><span class="linenos">704</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="main-705"><a href="#main-705"><span class="linenos">705</span></a>    <span class="c1"># Call the scheduler_pipeline function with the parsed arguments</span>
</span><span id="main-706"><a href="#main-706"><span class="linenos">706</span></a>    <span class="n">scheduler_pipeline</span><span class="p">(</span><span class="n">weights_root</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">weights_root</span><span class="p">,</span> <span class="n">chip_no</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="main-707"><a href="#main-707"><span class="linenos">707</span></a>                       <span class="n">input_image</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">image_path</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">stain_type</span><span class="p">,</span>
</span><span id="main-708"><a href="#main-708"><span class="linenos">708</span></a>                       <span class="n">param_file</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">param_file</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
</span><span id="main-709"><a href="#main-709"><span class="linenos">709</span></a>                       <span class="n">ipr_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ipr_path</span><span class="p">,</span> <span class="n">matrix_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">matrix_path</span><span class="p">,</span> <span class="n">kit</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">kit</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>The main function that initializes and runs the scheduler pipeline.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>args (argparse.Namespace):</strong>  Parsed command - line arguments containing the configuration and input data.</li>
<li><strong>para (dict):</strong>  Additional parameters required for the pipeline.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>