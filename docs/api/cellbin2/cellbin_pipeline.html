<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>cellbin2.cellbin_pipeline API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../cellbin2.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;cellbin2</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#CURR_PATH">CURR_PATH</a>
            </li>
            <li>
                    <a class="variable" href="#CB2_PATH">CB2_PATH</a>
            </li>
            <li>
                    <a class="variable" href="#CONFIG_PATH">CONFIG_PATH</a>
            </li>
            <li>
                    <a class="variable" href="#CONFIG_FILE">CONFIG_FILE</a>
            </li>
            <li>
                    <a class="variable" href="#CHIP_MASK_FILE">CHIP_MASK_FILE</a>
            </li>
            <li>
                    <a class="variable" href="#DEFAULT_PARAM_FILE">DEFAULT_PARAM_FILE</a>
            </li>
            <li>
                    <a class="variable" href="#SUPPORTED_TRACK_STAINED_TYPES">SUPPORTED_TRACK_STAINED_TYPES</a>
            </li>
            <li>
                    <a class="variable" href="#SUPPORTED_STAINED_Types">SUPPORTED_STAINED_Types</a>
            </li>
            <li>
                    <a class="class" href="#CellBinPipeline">CellBinPipeline</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CellBinPipeline.__init__">CellBinPipeline</a>
                        </li>
                        <li>
                                <a class="variable" href="#CellBinPipeline.pp">pp</a>
                        </li>
                        <li>
                                <a class="variable" href="#CellBinPipeline.config">config</a>
                        </li>
                        <li>
                                <a class="variable" href="#CellBinPipeline.more_images">more_images</a>
                        </li>
                        <li>
                                <a class="variable" href="#CellBinPipeline.research">research</a>
                        </li>
                        <li>
                                <a class="function" href="#CellBinPipeline.image_quality_control">image_quality_control</a>
                        </li>
                        <li>
                                <a class="function" href="#CellBinPipeline.image_analysis">image_analysis</a>
                        </li>
                        <li>
                                <a class="function" href="#CellBinPipeline.m_extract">m_extract</a>
                        </li>
                        <li>
                                <a class="function" href="#CellBinPipeline.metrics">metrics</a>
                        </li>
                        <li>
                                <a class="function" href="#CellBinPipeline.export_report">export_report</a>
                        </li>
                        <li>
                                <a class="function" href="#CellBinPipeline.usr_inp_to_param">usr_inp_to_param</a>
                        </li>
                        <li>
                                <a class="function" href="#CellBinPipeline.run">run</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#pipeline">pipeline</a>
            </li>
            <li>
                    <a class="function" href="#main">main</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../cellbin2.html">cellbin2</a><wbr>.cellbin_pipeline    </h1>

                
                        <input id="mod-cellbin_pipeline-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-cellbin_pipeline-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="n">CURR_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="n">CB2_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">CURR_PATH</span><span class="p">)</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CB2_PATH</span><span class="p">)</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.common</span> <span class="kn">import</span> <span class="n">TechType</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">naming</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils</span> <span class="kn">import</span> <span class="n">clog</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">cellbin2</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils</span> <span class="kn">import</span> <span class="n">ipr</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">cellbin2.modules.metadata</span> <span class="kn">import</span> <span class="n">read_param_file</span><span class="p">,</span> <span class="n">ProcParam</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">,</span> <span class="n">print_main_modules</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.config</span> <span class="kn">import</span> <span class="n">Config</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils</span> <span class="kn">import</span> <span class="n">dict2json</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.common</span> <span class="kn">import</span> <span class="n">KIT_VERSIONS</span><span class="p">,</span> <span class="n">KIT_VERSIONS_R</span><span class="p">,</span> <span class="n">sPlaceHolder</span><span class="p">,</span> <span class="n">bPlaceHolder</span><span class="p">,</span> <span class="n">ErrorCode</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.pro_monitor</span> <span class="kn">import</span> <span class="n">process_decorator</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span> <span class="nn">cellbin2.utils.weights_manager</span> <span class="kn">import</span> <span class="n">DEFAULT_WEIGHTS_DIR</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="n">CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CURR_PATH</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="c1"># DEFAULT_WEIGHTS_DIR = os.path.join(CURR_PATH, &quot;weights&quot;)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="n">CONFIG_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="s1">&#39;cellbin.yaml&#39;</span><span class="p">)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="n">CHIP_MASK_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="s1">&#39;chip_mask.json&#39;</span><span class="p">)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="n">DEFAULT_PARAM_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="s1">&#39;default_param.json&#39;</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="n">SUPPORTED_TRACK_STAINED_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">TechType</span><span class="o">.</span><span class="n">ssDNA</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">TechType</span><span class="o">.</span><span class="n">DAPI</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">TechType</span><span class="o">.</span><span class="n">HE</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="n">SUPPORTED_STAINED_Types</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="k">class</span> <span class="nc">CellBinPipeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    CellBinPipeline class is designed to handle the entire pipeline of cellular image processing and analysis.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">    It includes steps such as image quality control, image analysis, matrix extraction, metrics calculation, and report generation.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">        Initialize the CellBinPipeline class.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        Args:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">            config_file (str): The path to the configuration file.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">            chip_mask_file (str): The path to the chip mask file.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">            weights_root (str): The path to the weights root directory.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        Returns:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">            None</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        <span class="c1"># alg</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_mask_file</span> <span class="o">=</span> <span class="n">chip_mask_file</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span> <span class="o">=</span> <span class="n">weights_root</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="c1"># data</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">TechType</span><span class="o">.</span><span class="n">ssDNA</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="c1"># naming</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="c1"># 内部需要的</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="p">:</span> <span class="n">ProcParam</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="c1">#</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">research</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="k">def</span> <span class="nf">image_quality_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">        Perform image quality control.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">        This method checks if the QC flag in the processing parameters is set.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">        If set, it imports the image_qc module and runs the image_quality_control function</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        with the specified parameters. If the function returns a non-zero status code,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        the program exits with a status code of 1.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">        Returns:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">            None</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">qc</span><span class="p">:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">image_qc</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>            <span class="c1"># if self._naming.ipr.exists():</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="c1">#     clog.info(&#39;Image QC has been done&#39;)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>            <span class="c1">#     return 0</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>            <span class="n">s_code</span> <span class="o">=</span> <span class="n">image_qc</span><span class="o">.</span><span class="n">image_quality_control</span><span class="p">(</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>                <span class="n">weights_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>                <span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>                <span class="n">input_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>                <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>                <span class="n">param_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>                <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>                <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            <span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="k">if</span> <span class="n">s_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">image_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        Perform various image processing tasks including alignment, registration, calibration, segmentation, and matrix extraction.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        This method utilizes the scheduler pipeline to process the images based on the provided parameters.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        Returns:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">            None</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">alignment</span><span class="p">:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">scheduler</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>            <span class="c1"># if self._naming.rpi.exists():</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="c1">#     clog.info(&#39;scheduler has been done&#39;)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="c1">#     return 0</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">scheduler_pipeline</span><span class="p">(</span><span class="n">weights_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">,</span> <span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>                                         <span class="n">input_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>                                         <span class="n">param_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>                                         <span class="n">matrix_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span><span class="p">,</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>                                         <span class="n">ipr_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">,</span> <span class="n">kit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>                                         <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">m_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">        Extract matrices from the processed images.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">        This method runs the matrix extraction process if the corresponding flag is set in the processing parameters.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">        Returns:</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">            None</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">matrix_extract</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules.extract.matrix_extract</span> <span class="kn">import</span> <span class="n">extract4matrix</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="n">mcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="n">p_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mcf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>                    <span class="k">continue</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>                <span class="n">matrix</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span><span class="p">]</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>                <span class="n">extract4matrix</span><span class="p">(</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>                    <span class="n">p_naming</span><span class="o">=</span><span class="n">p_naming</span><span class="p">,</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>                    <span class="n">image_file</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                    <span class="n">m_naming</span><span class="o">=</span><span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>                        <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>                        <span class="n">m_type</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                        <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>                    <span class="p">),</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>                <span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>    <span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">        Calculate metrics for the processed images and matrices.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">        This method calculates various metrics if the corresponding flag is set in the processing parameters.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">        Returns:</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">            None</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="k">def</span> <span class="nf">_get_stitched</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">],</span> <span class="n">g_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sn</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span> <span class="o">==</span> <span class="n">g_name</span><span class="p">:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">file_path</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules.metrics</span> <span class="kn">import</span> <span class="n">ImageSource</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">metrics</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Metrics step has been done&#39;</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                <span class="k">return</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="n">ipr_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="n">rpi_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="c1"># 图片类的输入</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="n">ipr_r</span><span class="p">,</span> <span class="n">channel_images</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ipr_file</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="n">src_img_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="k">for</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">c_info</span> <span class="ow">in</span> <span class="n">channel_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>                <span class="n">c_pipeline_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>                <span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>                <span class="n">src_img_dict</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>                <span class="k">for</span> <span class="n">filed_name</span><span class="p">,</span> <span class="n">filed</span> <span class="ow">in</span> <span class="n">ImageSource</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                    <span class="k">if</span> <span class="n">filed_name</span> <span class="o">==</span> <span class="s2">&quot;cell_correct_mask&quot;</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;final_cell_mask&quot;</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>                    <span class="k">elif</span> <span class="n">filed_name</span> <span class="o">==</span> <span class="s1">&#39;stitch_image&#39;</span><span class="p">:</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="n">_get_stitched</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">g_name</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c_pipeline_name</span><span class="p">,</span> <span class="n">filed_name</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)):</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                    <span class="n">src_img_dict</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">filed_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>            <span class="n">gene_matrix</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>            <span class="n">matrix_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">gene_matrix</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                <span class="n">matrix</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span><span class="p">]</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>                <span class="n">cur_m_type</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>                <span class="k">if</span> <span class="n">cur_m_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matrix_dict</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>                    <span class="n">cur_m_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">m_type</span><span class="o">=</span><span class="n">cur_m_type</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>                                                             <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>                    <span class="n">cur_m_src_files</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MatrixArray</span><span class="p">(</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                        <span class="n">tissue_bin_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">tissue_bin_matrix</span><span class="p">),</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                        <span class="n">cell_bin_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">cell_bin_matrix</span><span class="p">),</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                        <span class="n">cell_bin_adjusted_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">cell_correct_bin_matrix</span><span class="p">),</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                        <span class="n">bin1_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">file_path</span><span class="p">),</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>                        <span class="n">matrix_type</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">tech</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>                    <span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>                    <span class="n">matrix_dict</span><span class="p">[</span><span class="n">cur_m_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_m_src_files</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="n">matrix_lists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matrix_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="n">fs</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">FileSource</span><span class="p">(</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                <span class="n">ipr_file</span><span class="o">=</span><span class="n">ipr_file</span><span class="p">,</span> <span class="n">rpi_file</span><span class="o">=</span><span class="n">rpi_file</span><span class="p">,</span> <span class="n">matrix_list</span><span class="o">=</span><span class="p">[</span><span class="n">matrix_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                <span class="n">image_dict</span><span class="o">=</span><span class="n">src_img_dict</span><span class="p">)</span>  <span class="c1"># TODO 蛋白矩阵没放进去</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="n">metrics</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metrics generated&quot;</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>    <span class="k">def</span> <span class="nf">export_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        Export the analysis report.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        This method generates and exports the report if the corresponding flag is set in the processing parameters.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        Returns:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">            None</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">report_m</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="n">src_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">metrics</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="n">report_m</span><span class="o">.</span><span class="n">creat_report</span><span class="p">(</span><span class="n">matric_json</span><span class="o">=</span><span class="n">src_file_path</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    <span class="k">def</span> <span class="nf">usr_inp_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        Convert user input to processing parameters.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">        This method converts the user-provided input into a set of processing parameters that will be used</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        throughout the pipeline.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        Returns:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">            None</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">):</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">research</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the input image can not be empty if param file is not provided&quot;</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="n">tech</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">):</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                <span class="n">param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="n">tech</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; R&quot;</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                <span class="n">param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="n">tech</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="n">new_pp</span> <span class="o">=</span> <span class="n">ProcParam</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="c1"># track image (ssDNA, HE, DAPI)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="n">im_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            <span class="n">trans_exp_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="n">protein_exp_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">nuclear_cell_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">template</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="n">nuclear_cell_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="c1"># 转录组矩阵</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                <span class="n">trans_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Transcriptomics</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="n">trans_tp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trans_tp</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                <span class="n">trans_exp_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">=</span> <span class="n">trans_exp_idx</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="c1"># more images, IF, H&amp;E</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                <span class="k">for</span> <span class="n">stain_type</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                    <span class="k">if</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">stain_type</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                        <span class="c1"># IF images</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                        <span class="n">inner_stain_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">TechType</span><span class="p">,</span> <span class="n">stain_type</span><span class="p">,</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                        <span class="n">im_process_cp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">inner_stain_type</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                        <span class="n">im_process_cp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                        <span class="c1"># im_process_cp.tech_type = stain_type</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                        <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">im_process_cp</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                        <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span> <span class="o">=</span> <span class="n">nuclear_cell_idx</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                        <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                        <span class="c1"># H&amp;E</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not supported&quot;</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                <span class="n">protein_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Protein</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                <span class="n">protein_tp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">protein_tp</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="n">protein_exp_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                <span class="k">if</span> <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                    <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">=</span> <span class="n">protein_exp_idx</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="c1"># end of image part info parsing</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="c1"># 矩阵提取</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="k">if</span> <span class="n">trans_exp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                <span class="n">trans_m_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Transcriptomics</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="n">trans_m_tp</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">=</span> <span class="n">trans_exp_idx</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="n">trans_m_tp</span><span class="o">.</span><span class="n">cell_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclear_cell_idx</span><span class="p">]</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans_m_tp</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="n">protein_exp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                <span class="n">protein_m_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Protein</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                <span class="n">protein_m_tp</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">=</span> <span class="n">protein_exp_idx</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                <span class="n">protein_m_tp</span><span class="o">.</span><span class="n">cell_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclear_cell_idx</span><span class="p">]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protein_m_tp</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="n">new_pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="n">param_f_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">input_json</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="n">dict2json</span><span class="p">(</span><span class="n">new_pp</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="n">json_path</span><span class="o">=</span><span class="n">param_f_p</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="o">=</span> <span class="n">param_f_p</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">new_pp</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>            <span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">print_main_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">more_images</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">protein_matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">if_report</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="sd">        Run the full analysis pipeline.</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        This method runs the entire pipeline for image analysis, including the following steps:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        - Convert user input to parameters</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        - Perform image quality control</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        - Perform image analysis</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="sd">        - Extract matrix</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">        - Calculate metrics</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">        - Generate report</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        Args:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">            chip_no (str): The serial number of the chip.</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a><span class="sd">            input_image (str): The path of the input image file.</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">            more_images (str): The paths of other input image files.</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">            stain_type (str): The stain type of the input image.</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="sd">            param_file (str): The path of the input parameter file.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">            output_path (str): The path of the output directory.</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">            matrix_path (str): The path of the transcriptomics matrix file.</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">            protein_matrix_path (str): The path of the protein matrix file.</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">            kit (str): The version of the kit.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">            if_report (bool): Whether to generate a report.</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">            debug (bool): Whether to run in debug mode.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        Returns:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">            None</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span> <span class="o">=</span> <span class="n">chip_no</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span> <span class="o">=</span> <span class="n">more_images</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span> <span class="o">=</span> <span class="n">stain_type</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="o">=</span> <span class="n">param_file</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">output_path</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span> <span class="o">=</span> <span class="n">matrix_path</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span> <span class="o">=</span> <span class="n">protein_matrix_path</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span> <span class="o">=</span> <span class="n">kit</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="o">=</span> <span class="n">if_report</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="c1"># self.pipe_run_state = PipelineRunState(self._chip_no, self._output_path)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usr_inp_to_param</span><span class="p">()</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_quality_control</span><span class="p">()</span>  <span class="c1"># 图像质控</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_analysis</span><span class="p">()</span>  <span class="c1"># 图像分析</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">m_extract</span><span class="p">()</span>  <span class="c1"># 矩阵提取</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">()</span>  <span class="c1"># 指标计算</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">export_report</span><span class="p">()</span>  <span class="c1"># 生成报告</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="nd">@process_decorator</span><span class="p">(</span><span class="s1">&#39;GiB&#39;</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">chip_no</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">input_image</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="n">more_images</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">stain_type</span><span class="p">,</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="n">param_file</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="n">output_path</span><span class="p">,</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="n">matrix_path</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="n">protein_matrix_path</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="n">kit</span><span class="p">,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="n">if_report</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="n">weights_root</span><span class="p">,</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="p">):</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">    This function is used to execute the cellbin pipeline.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">    Args:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        weights_root (str): The local storage directory path of CNN weight files.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">        chip_no (str): The sample chip number.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        input_image (str): The local path of the stained image.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">        stain_type (str): The staining type corresponding to the stained image.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        param_file (str): The local path of the input parameter file.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">        kit (str): The sequencing technology.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">        output_path (str): The local storage directory path for output files.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">        matrix_path (str): The local storage path of the expression matrix.</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">    Returns:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">        int: The status code.</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>    <span class="n">clog</span><span class="o">.</span><span class="n">log2file</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>    <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CellBin Version: </span><span class="si">{</span><span class="n">cellbin2</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="k">if</span> <span class="n">weights_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>            <span class="c1"># if user does not provide weight path, use default</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="n">weights_root</span> <span class="o">=</span> <span class="n">DEFAULT_WEIGHTS_DIR</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">weights_root</span><span class="p">):</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                <span class="n">weights_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CURR_PATH</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="n">weights_root</span> <span class="o">=</span> <span class="n">weights_root</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="n">cbp</span> <span class="o">=</span> <span class="n">CellBinPipeline</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="n">CONFIG_FILE</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="o">=</span><span class="n">CHIP_MASK_FILE</span><span class="p">,</span> <span class="n">weights_root</span><span class="o">=</span><span class="n">weights_root</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="n">cbp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="n">input_image</span><span class="o">=</span><span class="n">input_image</span><span class="p">,</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="n">more_images</span><span class="o">=</span><span class="n">more_images</span><span class="p">,</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="n">stain_type</span><span class="o">=</span><span class="n">stain_type</span><span class="p">,</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>            <span class="n">param_file</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">matrix_path</span><span class="o">=</span><span class="n">matrix_path</span><span class="p">,</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">protein_matrix_path</span><span class="o">=</span><span class="n">protein_matrix_path</span><span class="p">,</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="n">kit</span><span class="o">=</span><span class="n">kit</span><span class="p">,</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="n">if_report</span><span class="o">=</span><span class="n">if_report</span><span class="p">,</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="n">clog</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Unexpected Error: &#39;</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">unexpectedError</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">para</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">    Main function to execute the cellbin pipeline.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">    This function acts as the entry - point for the cellbin pipeline. It retrieves the essential parameters</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">    from the parsed command - line arguments and additional parameter dictionary, and then passes them to</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">    the `pipeline` function for execution.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">    Args:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">        args (argparse.Namespace): The parsed command - line arguments, which hold various parameters necessary</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">            for the pipeline operation.</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">        para (dict): Additional parameters for the pipeline. These are typically used to provide supplementary</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">            configuration details or context information.</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">    Returns:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">        None</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>    <span class="n">chip_no</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">chip_no</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="n">input_image</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">input_image</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>    <span class="n">more_images</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">more_images</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>    <span class="n">stain_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">stain_type</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>    <span class="n">param_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">param_file</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>    <span class="n">output_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_path</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>    <span class="n">matrix_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">matrix_file</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>    <span class="n">protein_matrix_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">protein_matrix_file</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>    <span class="n">kit</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">kit</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>    <span class="n">weights_root</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">weights_root</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>    <span class="n">if_report</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">report</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>    <span class="n">debug</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    <span class="n">pipeline</span><span class="p">(</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="n">chip_no</span><span class="p">,</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="n">input_image</span><span class="p">,</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="n">more_images</span><span class="p">,</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">stain_type</span><span class="p">,</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="n">param_file</span><span class="p">,</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="n">output_path</span><span class="p">,</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="n">matrix_path</span><span class="p">,</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="n">protein_matrix_path</span><span class="p">,</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="n">kit</span><span class="p">,</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="n">if_report</span><span class="p">,</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="n">weights_root</span><span class="p">,</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>    <span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>  <span class="c1"># main()</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>    <span class="kn">import</span> <span class="nn">argparse</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="n">_VERSION_</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>    <span class="n">usage_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">python </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                <span class="sa">f</span><span class="s2">&quot;-c  A03599D1 </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>                <span class="sa">f</span><span class="s2">&quot;-i  A03599D1_DAPI_fov_stitched.tif </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>                <span class="sa">f</span><span class="s2">&quot;-mi IF=A02677B5_IF.tif </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>                <span class="sa">f</span><span class="s2">&quot;-s  DAPI </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                <span class="sa">f</span><span class="s2">&quot;-m  A03599D1.raw.gef </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                <span class="sa">f</span><span class="s2">&quot;-pr A03599D1.protein.raw.gef </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                <span class="sa">f</span><span class="s2">&quot;-w  /cellbin2/weights </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                <span class="sa">f</span><span class="s2">&quot;-o  /cellbin2/test/A03599D1_demo1_1 </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>                <span class="sa">f</span><span class="s2">&quot;-k  </span><span class="se">\&quot;</span><span class="s2">Stereo-CITE T FF V1.0 R</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>                <span class="sa">f</span><span class="s2">&quot;-r&quot;</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>    <span class="c1"># 负责接收字典类的参数</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>    <span class="k">class</span> <span class="nc">MoreimsKwargs</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>            <span class="n">mif_im_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>                    <span class="c1"># split it into key and value</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>                    <span class="c1"># assign into dictionary</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                        <span class="nb">getattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;unknown</span><span class="si">{</span><span class="n">mif_im_count</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>                            <span class="nb">getattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>                    <span class="k">if</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>                        <span class="n">mif_im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input error: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, input like &#39;key=value&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="n">usage</span><span class="o">=</span><span class="n">usage_str</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">_VERSION_</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CHIP_NUMBER&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;chip_no&quot;</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The SN of chip.&quot;</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TRACK_IMAGE_FILE_PATH&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;input_image&quot;</span><span class="p">,</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The path of track image file, choices are: </span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SUPPORTED_TRACK_STAINED_TYPES</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TRACK_IMAGE_STAIN_TYPE&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;stain_type&quot;</span><span class="p">,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>                        <span class="n">choices</span><span class="o">=</span><span class="n">SUPPORTED_TRACK_STAINED_TYPES</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>                        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The stain type of input image, choices are </span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SUPPORTED_TRACK_STAINED_TYPES</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-mi&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">MoreimsKwargs</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;more_images&quot;</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of other image input file.&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{STAIN_TYPE}</span><span class="s2">=</span><span class="si">{FILE_PATH}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TRANSCRIPTOMICS_MATRIX_FILE&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;matrix_file&quot;</span><span class="p">,</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of transcriptomics matrix file.&quot;</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-pr&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PROTEIN_MATRIX_FILE&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;protein_matrix_file&quot;</span><span class="p">,</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of protein matrix file.&quot;</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Stereo-CITE T FF V1.0 R&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;KIT_VERSION&quot;</span><span class="p">,</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>                        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;kit&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">KIT_VERSIONS</span> <span class="o">+</span> <span class="n">KIT_VERSIONS_R</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Kit version&quot;</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path of input param file.&quot;</span><span class="p">,</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PARAM_FILE&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;param_file&quot;</span><span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;WEIGHTS_DIR&quot;</span><span class="p">,</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The weights root folder.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;weights_root&quot;</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT_PATH&quot;</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The results output folder.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output_path&quot;</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If run report.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;report&quot;</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">bPlaceHolder</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Debug mode&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">main</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>    <span class="n">para</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="CURR_PATH">
                    <div class="attr variable">
            <span class="name">CURR_PATH</span>        =
<span class="default_value">&#39;/media/Data1/user/dengzhonghan/code/cellbin2dev/cellbin2/cellbin2&#39;</span>

        
    </div>
    <a class="headerlink" href="#CURR_PATH"></a>
    
    

                </section>
                <section id="CB2_PATH">
                    <div class="attr variable">
            <span class="name">CB2_PATH</span>        =
<span class="default_value">$PWD</span>

        
    </div>
    <a class="headerlink" href="#CB2_PATH"></a>
    
    

                </section>
                <section id="CONFIG_PATH">
                    <div class="attr variable">
            <span class="name">CONFIG_PATH</span>        =
<span class="default_value">&#39;/media/Data1/user/dengzhonghan/code/cellbin2dev/cellbin2/cellbin2/config&#39;</span>

        
    </div>
    <a class="headerlink" href="#CONFIG_PATH"></a>
    
    

                </section>
                <section id="CONFIG_FILE">
                    <div class="attr variable">
            <span class="name">CONFIG_FILE</span>        =
<span class="default_value">&#39;/media/Data1/user/dengzhonghan/code/cellbin2dev/cellbin2/cellbin2/config/cellbin.yaml&#39;</span>

        
    </div>
    <a class="headerlink" href="#CONFIG_FILE"></a>
    
    

                </section>
                <section id="CHIP_MASK_FILE">
                    <div class="attr variable">
            <span class="name">CHIP_MASK_FILE</span>        =
<span class="default_value">&#39;/media/Data1/user/dengzhonghan/code/cellbin2dev/cellbin2/cellbin2/config/chip_mask.json&#39;</span>

        
    </div>
    <a class="headerlink" href="#CHIP_MASK_FILE"></a>
    
    

                </section>
                <section id="DEFAULT_PARAM_FILE">
                    <div class="attr variable">
            <span class="name">DEFAULT_PARAM_FILE</span>        =
<span class="default_value">&#39;/media/Data1/user/dengzhonghan/code/cellbin2dev/cellbin2/cellbin2/config/default_param.json&#39;</span>

        
    </div>
    <a class="headerlink" href="#DEFAULT_PARAM_FILE"></a>
    
    

                </section>
                <section id="SUPPORTED_TRACK_STAINED_TYPES">
                    <div class="attr variable">
            <span class="name">SUPPORTED_TRACK_STAINED_TYPES</span>        =
<span class="default_value">(&#39;ssDNA&#39;, &#39;DAPI&#39;, &#39;HE&#39;)</span>

        
    </div>
    <a class="headerlink" href="#SUPPORTED_TRACK_STAINED_TYPES"></a>
    
    

                </section>
                <section id="SUPPORTED_STAINED_Types">
                    <div class="attr variable">
            <span class="name">SUPPORTED_STAINED_Types</span>        =
<span class="default_value">[]</span>

        
    </div>
    <a class="headerlink" href="#SUPPORTED_STAINED_Types"></a>
    
    

                </section>
                <section id="CellBinPipeline">
                            <input id="CellBinPipeline-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CellBinPipeline</span>:

                <label class="view-source-button" for="CellBinPipeline-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline-32"><a href="#CellBinPipeline-32"><span class="linenos"> 32</span></a><span class="k">class</span> <span class="nc">CellBinPipeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="CellBinPipeline-33"><a href="#CellBinPipeline-33"><span class="linenos"> 33</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-34"><a href="#CellBinPipeline-34"><span class="linenos"> 34</span></a><span class="sd">    CellBinPipeline class is designed to handle the entire pipeline of cellular image processing and analysis.</span>
</span><span id="CellBinPipeline-35"><a href="#CellBinPipeline-35"><span class="linenos"> 35</span></a><span class="sd">    It includes steps such as image quality control, image analysis, matrix extraction, metrics calculation, and report generation.</span>
</span><span id="CellBinPipeline-36"><a href="#CellBinPipeline-36"><span class="linenos"> 36</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-37"><a href="#CellBinPipeline-37"><span class="linenos"> 37</span></a>
</span><span id="CellBinPipeline-38"><a href="#CellBinPipeline-38"><span class="linenos"> 38</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline-39"><a href="#CellBinPipeline-39"><span class="linenos"> 39</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-40"><a href="#CellBinPipeline-40"><span class="linenos"> 40</span></a><span class="sd">        Initialize the CellBinPipeline class.</span>
</span><span id="CellBinPipeline-41"><a href="#CellBinPipeline-41"><span class="linenos"> 41</span></a>
</span><span id="CellBinPipeline-42"><a href="#CellBinPipeline-42"><span class="linenos"> 42</span></a><span class="sd">        Args:</span>
</span><span id="CellBinPipeline-43"><a href="#CellBinPipeline-43"><span class="linenos"> 43</span></a><span class="sd">            config_file (str): The path to the configuration file.</span>
</span><span id="CellBinPipeline-44"><a href="#CellBinPipeline-44"><span class="linenos"> 44</span></a><span class="sd">            chip_mask_file (str): The path to the chip mask file.</span>
</span><span id="CellBinPipeline-45"><a href="#CellBinPipeline-45"><span class="linenos"> 45</span></a><span class="sd">            weights_root (str): The path to the weights root directory.</span>
</span><span id="CellBinPipeline-46"><a href="#CellBinPipeline-46"><span class="linenos"> 46</span></a>
</span><span id="CellBinPipeline-47"><a href="#CellBinPipeline-47"><span class="linenos"> 47</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-48"><a href="#CellBinPipeline-48"><span class="linenos"> 48</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-49"><a href="#CellBinPipeline-49"><span class="linenos"> 49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-50"><a href="#CellBinPipeline-50"><span class="linenos"> 50</span></a>        <span class="c1"># alg</span>
</span><span id="CellBinPipeline-51"><a href="#CellBinPipeline-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_mask_file</span> <span class="o">=</span> <span class="n">chip_mask_file</span>
</span><span id="CellBinPipeline-52"><a href="#CellBinPipeline-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
</span><span id="CellBinPipeline-53"><a href="#CellBinPipeline-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span> <span class="o">=</span> <span class="n">weights_root</span>
</span><span id="CellBinPipeline-54"><a href="#CellBinPipeline-54"><span class="linenos"> 54</span></a>
</span><span id="CellBinPipeline-55"><a href="#CellBinPipeline-55"><span class="linenos"> 55</span></a>        <span class="c1"># data</span>
</span><span id="CellBinPipeline-56"><a href="#CellBinPipeline-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline-57"><a href="#CellBinPipeline-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline-58"><a href="#CellBinPipeline-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">TechType</span><span class="o">.</span><span class="n">ssDNA</span><span class="o">.</span><span class="n">name</span>
</span><span id="CellBinPipeline-59"><a href="#CellBinPipeline-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline-60"><a href="#CellBinPipeline-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline-61"><a href="#CellBinPipeline-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline-62"><a href="#CellBinPipeline-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline-63"><a href="#CellBinPipeline-63"><span class="linenos"> 63</span></a>
</span><span id="CellBinPipeline-64"><a href="#CellBinPipeline-64"><span class="linenos"> 64</span></a>        <span class="c1"># naming</span>
</span><span id="CellBinPipeline-65"><a href="#CellBinPipeline-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CellBinPipeline-66"><a href="#CellBinPipeline-66"><span class="linenos"> 66</span></a>
</span><span id="CellBinPipeline-67"><a href="#CellBinPipeline-67"><span class="linenos"> 67</span></a>        <span class="c1"># 内部需要的</span>
</span><span id="CellBinPipeline-68"><a href="#CellBinPipeline-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="p">:</span> <span class="n">ProcParam</span>
</span><span id="CellBinPipeline-69"><a href="#CellBinPipeline-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span>
</span><span id="CellBinPipeline-70"><a href="#CellBinPipeline-70"><span class="linenos"> 70</span></a>
</span><span id="CellBinPipeline-71"><a href="#CellBinPipeline-71"><span class="linenos"> 71</span></a>        <span class="c1">#</span>
</span><span id="CellBinPipeline-72"><a href="#CellBinPipeline-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CellBinPipeline-73"><a href="#CellBinPipeline-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CellBinPipeline-74"><a href="#CellBinPipeline-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline-75"><a href="#CellBinPipeline-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">research</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CellBinPipeline-76"><a href="#CellBinPipeline-76"><span class="linenos"> 76</span></a>
</span><span id="CellBinPipeline-77"><a href="#CellBinPipeline-77"><span class="linenos"> 77</span></a>    <span class="k">def</span> <span class="nf">image_quality_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline-78"><a href="#CellBinPipeline-78"><span class="linenos"> 78</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-79"><a href="#CellBinPipeline-79"><span class="linenos"> 79</span></a><span class="sd">        Perform image quality control.</span>
</span><span id="CellBinPipeline-80"><a href="#CellBinPipeline-80"><span class="linenos"> 80</span></a>
</span><span id="CellBinPipeline-81"><a href="#CellBinPipeline-81"><span class="linenos"> 81</span></a><span class="sd">        This method checks if the QC flag in the processing parameters is set.</span>
</span><span id="CellBinPipeline-82"><a href="#CellBinPipeline-82"><span class="linenos"> 82</span></a><span class="sd">        If set, it imports the image_qc module and runs the image_quality_control function</span>
</span><span id="CellBinPipeline-83"><a href="#CellBinPipeline-83"><span class="linenos"> 83</span></a><span class="sd">        with the specified parameters. If the function returns a non-zero status code,</span>
</span><span id="CellBinPipeline-84"><a href="#CellBinPipeline-84"><span class="linenos"> 84</span></a><span class="sd">        the program exits with a status code of 1.</span>
</span><span id="CellBinPipeline-85"><a href="#CellBinPipeline-85"><span class="linenos"> 85</span></a>
</span><span id="CellBinPipeline-86"><a href="#CellBinPipeline-86"><span class="linenos"> 86</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-87"><a href="#CellBinPipeline-87"><span class="linenos"> 87</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-88"><a href="#CellBinPipeline-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-89"><a href="#CellBinPipeline-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">qc</span><span class="p">:</span>
</span><span id="CellBinPipeline-90"><a href="#CellBinPipeline-90"><span class="linenos"> 90</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">image_qc</span>
</span><span id="CellBinPipeline-91"><a href="#CellBinPipeline-91"><span class="linenos"> 91</span></a>            <span class="c1"># if self._naming.ipr.exists():</span>
</span><span id="CellBinPipeline-92"><a href="#CellBinPipeline-92"><span class="linenos"> 92</span></a>            <span class="c1">#     clog.info(&#39;Image QC has been done&#39;)</span>
</span><span id="CellBinPipeline-93"><a href="#CellBinPipeline-93"><span class="linenos"> 93</span></a>            <span class="c1">#     return 0</span>
</span><span id="CellBinPipeline-94"><a href="#CellBinPipeline-94"><span class="linenos"> 94</span></a>            <span class="n">s_code</span> <span class="o">=</span> <span class="n">image_qc</span><span class="o">.</span><span class="n">image_quality_control</span><span class="p">(</span>
</span><span id="CellBinPipeline-95"><a href="#CellBinPipeline-95"><span class="linenos"> 95</span></a>                <span class="n">weights_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">,</span>
</span><span id="CellBinPipeline-96"><a href="#CellBinPipeline-96"><span class="linenos"> 96</span></a>                <span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline-97"><a href="#CellBinPipeline-97"><span class="linenos"> 97</span></a>                <span class="n">input_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">,</span>
</span><span id="CellBinPipeline-98"><a href="#CellBinPipeline-98"><span class="linenos"> 98</span></a>                <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">,</span>
</span><span id="CellBinPipeline-99"><a href="#CellBinPipeline-99"><span class="linenos"> 99</span></a>                <span class="n">param_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span>
</span><span id="CellBinPipeline-100"><a href="#CellBinPipeline-100"><span class="linenos">100</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="CellBinPipeline-101"><a href="#CellBinPipeline-101"><span class="linenos">101</span></a>                <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">,</span>
</span><span id="CellBinPipeline-102"><a href="#CellBinPipeline-102"><span class="linenos">102</span></a>                <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research</span>
</span><span id="CellBinPipeline-103"><a href="#CellBinPipeline-103"><span class="linenos">103</span></a>            <span class="p">)</span>
</span><span id="CellBinPipeline-104"><a href="#CellBinPipeline-104"><span class="linenos">104</span></a>            <span class="k">if</span> <span class="n">s_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CellBinPipeline-105"><a href="#CellBinPipeline-105"><span class="linenos">105</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CellBinPipeline-106"><a href="#CellBinPipeline-106"><span class="linenos">106</span></a>
</span><span id="CellBinPipeline-107"><a href="#CellBinPipeline-107"><span class="linenos">107</span></a>    <span class="k">def</span> <span class="nf">image_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline-108"><a href="#CellBinPipeline-108"><span class="linenos">108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-109"><a href="#CellBinPipeline-109"><span class="linenos">109</span></a><span class="sd">        Perform various image processing tasks including alignment, registration, calibration, segmentation, and matrix extraction.</span>
</span><span id="CellBinPipeline-110"><a href="#CellBinPipeline-110"><span class="linenos">110</span></a>
</span><span id="CellBinPipeline-111"><a href="#CellBinPipeline-111"><span class="linenos">111</span></a><span class="sd">        This method utilizes the scheduler pipeline to process the images based on the provided parameters.</span>
</span><span id="CellBinPipeline-112"><a href="#CellBinPipeline-112"><span class="linenos">112</span></a>
</span><span id="CellBinPipeline-113"><a href="#CellBinPipeline-113"><span class="linenos">113</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-114"><a href="#CellBinPipeline-114"><span class="linenos">114</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-115"><a href="#CellBinPipeline-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-116"><a href="#CellBinPipeline-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">alignment</span><span class="p">:</span>
</span><span id="CellBinPipeline-117"><a href="#CellBinPipeline-117"><span class="linenos">117</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">scheduler</span>
</span><span id="CellBinPipeline-118"><a href="#CellBinPipeline-118"><span class="linenos">118</span></a>            <span class="c1"># if self._naming.rpi.exists():</span>
</span><span id="CellBinPipeline-119"><a href="#CellBinPipeline-119"><span class="linenos">119</span></a>            <span class="c1">#     clog.info(&#39;scheduler has been done&#39;)</span>
</span><span id="CellBinPipeline-120"><a href="#CellBinPipeline-120"><span class="linenos">120</span></a>            <span class="c1">#     return 0</span>
</span><span id="CellBinPipeline-121"><a href="#CellBinPipeline-121"><span class="linenos">121</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">scheduler_pipeline</span><span class="p">(</span><span class="n">weights_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">,</span> <span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline-122"><a href="#CellBinPipeline-122"><span class="linenos">122</span></a>                                         <span class="n">input_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">,</span>
</span><span id="CellBinPipeline-123"><a href="#CellBinPipeline-123"><span class="linenos">123</span></a>                                         <span class="n">param_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="CellBinPipeline-124"><a href="#CellBinPipeline-124"><span class="linenos">124</span></a>                                         <span class="n">matrix_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span><span class="p">,</span>
</span><span id="CellBinPipeline-125"><a href="#CellBinPipeline-125"><span class="linenos">125</span></a>                                         <span class="n">ipr_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">,</span> <span class="n">kit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">,</span>
</span><span id="CellBinPipeline-126"><a href="#CellBinPipeline-126"><span class="linenos">126</span></a>                                         <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research</span><span class="p">)</span>
</span><span id="CellBinPipeline-127"><a href="#CellBinPipeline-127"><span class="linenos">127</span></a>
</span><span id="CellBinPipeline-128"><a href="#CellBinPipeline-128"><span class="linenos">128</span></a>    <span class="k">def</span> <span class="nf">m_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CellBinPipeline-129"><a href="#CellBinPipeline-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-130"><a href="#CellBinPipeline-130"><span class="linenos">130</span></a><span class="sd">        Extract matrices from the processed images.</span>
</span><span id="CellBinPipeline-131"><a href="#CellBinPipeline-131"><span class="linenos">131</span></a>
</span><span id="CellBinPipeline-132"><a href="#CellBinPipeline-132"><span class="linenos">132</span></a><span class="sd">        This method runs the matrix extraction process if the corresponding flag is set in the processing parameters.</span>
</span><span id="CellBinPipeline-133"><a href="#CellBinPipeline-133"><span class="linenos">133</span></a>
</span><span id="CellBinPipeline-134"><a href="#CellBinPipeline-134"><span class="linenos">134</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-135"><a href="#CellBinPipeline-135"><span class="linenos">135</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-136"><a href="#CellBinPipeline-136"><span class="linenos">136</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-137"><a href="#CellBinPipeline-137"><span class="linenos">137</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">matrix_extract</span><span class="p">:</span>
</span><span id="CellBinPipeline-138"><a href="#CellBinPipeline-138"><span class="linenos">138</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules.extract.matrix_extract</span> <span class="kn">import</span> <span class="n">extract4matrix</span>
</span><span id="CellBinPipeline-139"><a href="#CellBinPipeline-139"><span class="linenos">139</span></a>            <span class="n">mcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span>
</span><span id="CellBinPipeline-140"><a href="#CellBinPipeline-140"><span class="linenos">140</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CellBinPipeline-141"><a href="#CellBinPipeline-141"><span class="linenos">141</span></a>            <span class="n">p_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline-142"><a href="#CellBinPipeline-142"><span class="linenos">142</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mcf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline-143"><a href="#CellBinPipeline-143"><span class="linenos">143</span></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline-144"><a href="#CellBinPipeline-144"><span class="linenos">144</span></a>                    <span class="k">continue</span>
</span><span id="CellBinPipeline-145"><a href="#CellBinPipeline-145"><span class="linenos">145</span></a>                <span class="n">matrix</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span><span class="p">]</span>
</span><span id="CellBinPipeline-146"><a href="#CellBinPipeline-146"><span class="linenos">146</span></a>                <span class="n">extract4matrix</span><span class="p">(</span>
</span><span id="CellBinPipeline-147"><a href="#CellBinPipeline-147"><span class="linenos">147</span></a>                    <span class="n">p_naming</span><span class="o">=</span><span class="n">p_naming</span><span class="p">,</span>
</span><span id="CellBinPipeline-148"><a href="#CellBinPipeline-148"><span class="linenos">148</span></a>                    <span class="n">image_file</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span>
</span><span id="CellBinPipeline-149"><a href="#CellBinPipeline-149"><span class="linenos">149</span></a>                    <span class="n">m_naming</span><span class="o">=</span><span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="CellBinPipeline-150"><a href="#CellBinPipeline-150"><span class="linenos">150</span></a>                        <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline-151"><a href="#CellBinPipeline-151"><span class="linenos">151</span></a>                        <span class="n">m_type</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="CellBinPipeline-152"><a href="#CellBinPipeline-152"><span class="linenos">152</span></a>                        <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="CellBinPipeline-153"><a href="#CellBinPipeline-153"><span class="linenos">153</span></a>                    <span class="p">),</span>
</span><span id="CellBinPipeline-154"><a href="#CellBinPipeline-154"><span class="linenos">154</span></a>                <span class="p">)</span>
</span><span id="CellBinPipeline-155"><a href="#CellBinPipeline-155"><span class="linenos">155</span></a>
</span><span id="CellBinPipeline-156"><a href="#CellBinPipeline-156"><span class="linenos">156</span></a>    <span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline-157"><a href="#CellBinPipeline-157"><span class="linenos">157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-158"><a href="#CellBinPipeline-158"><span class="linenos">158</span></a><span class="sd">        Calculate metrics for the processed images and matrices.</span>
</span><span id="CellBinPipeline-159"><a href="#CellBinPipeline-159"><span class="linenos">159</span></a>
</span><span id="CellBinPipeline-160"><a href="#CellBinPipeline-160"><span class="linenos">160</span></a><span class="sd">        This method calculates various metrics if the corresponding flag is set in the processing parameters.</span>
</span><span id="CellBinPipeline-161"><a href="#CellBinPipeline-161"><span class="linenos">161</span></a>
</span><span id="CellBinPipeline-162"><a href="#CellBinPipeline-162"><span class="linenos">162</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-163"><a href="#CellBinPipeline-163"><span class="linenos">163</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-164"><a href="#CellBinPipeline-164"><span class="linenos">164</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-165"><a href="#CellBinPipeline-165"><span class="linenos">165</span></a>        <span class="k">def</span> <span class="nf">_get_stitched</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">],</span> <span class="n">g_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sn</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="CellBinPipeline-166"><a href="#CellBinPipeline-166"><span class="linenos">166</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline-167"><a href="#CellBinPipeline-167"><span class="linenos">167</span></a>                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span> <span class="o">==</span> <span class="n">g_name</span><span class="p">:</span>
</span><span id="CellBinPipeline-168"><a href="#CellBinPipeline-168"><span class="linenos">168</span></a>                    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">file_path</span>
</span><span id="CellBinPipeline-169"><a href="#CellBinPipeline-169"><span class="linenos">169</span></a>
</span><span id="CellBinPipeline-170"><a href="#CellBinPipeline-170"><span class="linenos">170</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
</span><span id="CellBinPipeline-171"><a href="#CellBinPipeline-171"><span class="linenos">171</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules.metrics</span> <span class="kn">import</span> <span class="n">ImageSource</span>
</span><span id="CellBinPipeline-172"><a href="#CellBinPipeline-172"><span class="linenos">172</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">metrics</span>
</span><span id="CellBinPipeline-173"><a href="#CellBinPipeline-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="CellBinPipeline-174"><a href="#CellBinPipeline-174"><span class="linenos">174</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Metrics step has been done&#39;</span><span class="p">)</span>
</span><span id="CellBinPipeline-175"><a href="#CellBinPipeline-175"><span class="linenos">175</span></a>                <span class="k">return</span>
</span><span id="CellBinPipeline-176"><a href="#CellBinPipeline-176"><span class="linenos">176</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">)</span>
</span><span id="CellBinPipeline-177"><a href="#CellBinPipeline-177"><span class="linenos">177</span></a>            <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span><span id="CellBinPipeline-178"><a href="#CellBinPipeline-178"><span class="linenos">178</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CellBinPipeline-179"><a href="#CellBinPipeline-179"><span class="linenos">179</span></a>            <span class="n">ipr_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">)</span>
</span><span id="CellBinPipeline-180"><a href="#CellBinPipeline-180"><span class="linenos">180</span></a>            <span class="n">rpi_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">)</span>
</span><span id="CellBinPipeline-181"><a href="#CellBinPipeline-181"><span class="linenos">181</span></a>            <span class="c1"># 图片类的输入</span>
</span><span id="CellBinPipeline-182"><a href="#CellBinPipeline-182"><span class="linenos">182</span></a>            <span class="n">ipr_r</span><span class="p">,</span> <span class="n">channel_images</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ipr_file</span><span class="p">)</span>
</span><span id="CellBinPipeline-183"><a href="#CellBinPipeline-183"><span class="linenos">183</span></a>            <span class="n">src_img_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CellBinPipeline-184"><a href="#CellBinPipeline-184"><span class="linenos">184</span></a>            <span class="k">for</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">c_info</span> <span class="ow">in</span> <span class="n">channel_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline-185"><a href="#CellBinPipeline-185"><span class="linenos">185</span></a>                <span class="n">c_pipeline_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="CellBinPipeline-186"><a href="#CellBinPipeline-186"><span class="linenos">186</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span>
</span><span id="CellBinPipeline-187"><a href="#CellBinPipeline-187"><span class="linenos">187</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="CellBinPipeline-188"><a href="#CellBinPipeline-188"><span class="linenos">188</span></a>                <span class="p">)</span>
</span><span id="CellBinPipeline-189"><a href="#CellBinPipeline-189"><span class="linenos">189</span></a>                <span class="n">src_img_dict</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CellBinPipeline-190"><a href="#CellBinPipeline-190"><span class="linenos">190</span></a>                <span class="k">for</span> <span class="n">filed_name</span><span class="p">,</span> <span class="n">filed</span> <span class="ow">in</span> <span class="n">ImageSource</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline-191"><a href="#CellBinPipeline-191"><span class="linenos">191</span></a>                    <span class="k">if</span> <span class="n">filed_name</span> <span class="o">==</span> <span class="s2">&quot;cell_correct_mask&quot;</span><span class="p">:</span>
</span><span id="CellBinPipeline-192"><a href="#CellBinPipeline-192"><span class="linenos">192</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;final_cell_mask&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline-193"><a href="#CellBinPipeline-193"><span class="linenos">193</span></a>                    <span class="k">elif</span> <span class="n">filed_name</span> <span class="o">==</span> <span class="s1">&#39;stitch_image&#39;</span><span class="p">:</span>
</span><span id="CellBinPipeline-194"><a href="#CellBinPipeline-194"><span class="linenos">194</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="n">_get_stitched</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">g_name</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">)</span>
</span><span id="CellBinPipeline-195"><a href="#CellBinPipeline-195"><span class="linenos">195</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline-196"><a href="#CellBinPipeline-196"><span class="linenos">196</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c_pipeline_name</span><span class="p">,</span> <span class="n">filed_name</span><span class="p">)</span>
</span><span id="CellBinPipeline-197"><a href="#CellBinPipeline-197"><span class="linenos">197</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)):</span>
</span><span id="CellBinPipeline-198"><a href="#CellBinPipeline-198"><span class="linenos">198</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="CellBinPipeline-199"><a href="#CellBinPipeline-199"><span class="linenos">199</span></a>                    <span class="n">src_img_dict</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">filed_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</span><span id="CellBinPipeline-200"><a href="#CellBinPipeline-200"><span class="linenos">200</span></a>            <span class="n">gene_matrix</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="CellBinPipeline-201"><a href="#CellBinPipeline-201"><span class="linenos">201</span></a>            <span class="n">matrix_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CellBinPipeline-202"><a href="#CellBinPipeline-202"><span class="linenos">202</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">gene_matrix</span><span class="p">:</span>
</span><span id="CellBinPipeline-203"><a href="#CellBinPipeline-203"><span class="linenos">203</span></a>                <span class="n">matrix</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span><span class="p">]</span>
</span><span id="CellBinPipeline-204"><a href="#CellBinPipeline-204"><span class="linenos">204</span></a>                <span class="n">cur_m_type</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span>
</span><span id="CellBinPipeline-205"><a href="#CellBinPipeline-205"><span class="linenos">205</span></a>                <span class="k">if</span> <span class="n">cur_m_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matrix_dict</span><span class="p">:</span>
</span><span id="CellBinPipeline-206"><a href="#CellBinPipeline-206"><span class="linenos">206</span></a>                    <span class="n">cur_m_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">m_type</span><span class="o">=</span><span class="n">cur_m_type</span><span class="p">,</span>
</span><span id="CellBinPipeline-207"><a href="#CellBinPipeline-207"><span class="linenos">207</span></a>                                                             <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline-208"><a href="#CellBinPipeline-208"><span class="linenos">208</span></a>                    <span class="n">cur_m_src_files</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MatrixArray</span><span class="p">(</span>
</span><span id="CellBinPipeline-209"><a href="#CellBinPipeline-209"><span class="linenos">209</span></a>                        <span class="n">tissue_bin_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">tissue_bin_matrix</span><span class="p">),</span>
</span><span id="CellBinPipeline-210"><a href="#CellBinPipeline-210"><span class="linenos">210</span></a>                        <span class="n">cell_bin_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">cell_bin_matrix</span><span class="p">),</span>
</span><span id="CellBinPipeline-211"><a href="#CellBinPipeline-211"><span class="linenos">211</span></a>                        <span class="n">cell_bin_adjusted_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">cell_correct_bin_matrix</span><span class="p">),</span>
</span><span id="CellBinPipeline-212"><a href="#CellBinPipeline-212"><span class="linenos">212</span></a>                        <span class="n">bin1_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">file_path</span><span class="p">),</span>
</span><span id="CellBinPipeline-213"><a href="#CellBinPipeline-213"><span class="linenos">213</span></a>                        <span class="n">matrix_type</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">tech</span>
</span><span id="CellBinPipeline-214"><a href="#CellBinPipeline-214"><span class="linenos">214</span></a>                    <span class="p">)</span>
</span><span id="CellBinPipeline-215"><a href="#CellBinPipeline-215"><span class="linenos">215</span></a>                    <span class="n">matrix_dict</span><span class="p">[</span><span class="n">cur_m_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_m_src_files</span>
</span><span id="CellBinPipeline-216"><a href="#CellBinPipeline-216"><span class="linenos">216</span></a>            <span class="n">matrix_lists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matrix_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="CellBinPipeline-217"><a href="#CellBinPipeline-217"><span class="linenos">217</span></a>            <span class="n">fs</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">FileSource</span><span class="p">(</span>
</span><span id="CellBinPipeline-218"><a href="#CellBinPipeline-218"><span class="linenos">218</span></a>                <span class="n">ipr_file</span><span class="o">=</span><span class="n">ipr_file</span><span class="p">,</span> <span class="n">rpi_file</span><span class="o">=</span><span class="n">rpi_file</span><span class="p">,</span> <span class="n">matrix_list</span><span class="o">=</span><span class="p">[</span><span class="n">matrix_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline-219"><a href="#CellBinPipeline-219"><span class="linenos">219</span></a>                <span class="n">image_dict</span><span class="o">=</span><span class="n">src_img_dict</span><span class="p">)</span>  <span class="c1"># TODO 蛋白矩阵没放进去</span>
</span><span id="CellBinPipeline-220"><a href="#CellBinPipeline-220"><span class="linenos">220</span></a>            <span class="n">metrics</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline-221"><a href="#CellBinPipeline-221"><span class="linenos">221</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metrics generated&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline-222"><a href="#CellBinPipeline-222"><span class="linenos">222</span></a>
</span><span id="CellBinPipeline-223"><a href="#CellBinPipeline-223"><span class="linenos">223</span></a>    <span class="k">def</span> <span class="nf">export_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline-224"><a href="#CellBinPipeline-224"><span class="linenos">224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-225"><a href="#CellBinPipeline-225"><span class="linenos">225</span></a><span class="sd">        Export the analysis report.</span>
</span><span id="CellBinPipeline-226"><a href="#CellBinPipeline-226"><span class="linenos">226</span></a>
</span><span id="CellBinPipeline-227"><a href="#CellBinPipeline-227"><span class="linenos">227</span></a><span class="sd">        This method generates and exports the report if the corresponding flag is set in the processing parameters.</span>
</span><span id="CellBinPipeline-228"><a href="#CellBinPipeline-228"><span class="linenos">228</span></a>
</span><span id="CellBinPipeline-229"><a href="#CellBinPipeline-229"><span class="linenos">229</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-230"><a href="#CellBinPipeline-230"><span class="linenos">230</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-231"><a href="#CellBinPipeline-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-232"><a href="#CellBinPipeline-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
</span><span id="CellBinPipeline-233"><a href="#CellBinPipeline-233"><span class="linenos">233</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">report_m</span>
</span><span id="CellBinPipeline-234"><a href="#CellBinPipeline-234"><span class="linenos">234</span></a>
</span><span id="CellBinPipeline-235"><a href="#CellBinPipeline-235"><span class="linenos">235</span></a>            <span class="n">src_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">metrics</span>
</span><span id="CellBinPipeline-236"><a href="#CellBinPipeline-236"><span class="linenos">236</span></a>            <span class="n">report_m</span><span class="o">.</span><span class="n">creat_report</span><span class="p">(</span><span class="n">matric_json</span><span class="o">=</span><span class="n">src_file_path</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline-237"><a href="#CellBinPipeline-237"><span class="linenos">237</span></a>
</span><span id="CellBinPipeline-238"><a href="#CellBinPipeline-238"><span class="linenos">238</span></a>    <span class="k">def</span> <span class="nf">usr_inp_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CellBinPipeline-239"><a href="#CellBinPipeline-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-240"><a href="#CellBinPipeline-240"><span class="linenos">240</span></a><span class="sd">        Convert user input to processing parameters.</span>
</span><span id="CellBinPipeline-241"><a href="#CellBinPipeline-241"><span class="linenos">241</span></a>
</span><span id="CellBinPipeline-242"><a href="#CellBinPipeline-242"><span class="linenos">242</span></a><span class="sd">        This method converts the user-provided input into a set of processing parameters that will be used</span>
</span><span id="CellBinPipeline-243"><a href="#CellBinPipeline-243"><span class="linenos">243</span></a><span class="sd">        throughout the pipeline.</span>
</span><span id="CellBinPipeline-244"><a href="#CellBinPipeline-244"><span class="linenos">244</span></a>
</span><span id="CellBinPipeline-245"><a href="#CellBinPipeline-245"><span class="linenos">245</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-246"><a href="#CellBinPipeline-246"><span class="linenos">246</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-247"><a href="#CellBinPipeline-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-248"><a href="#CellBinPipeline-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">):</span>
</span><span id="CellBinPipeline-249"><a href="#CellBinPipeline-249"><span class="linenos">249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">research</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CellBinPipeline-250"><a href="#CellBinPipeline-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">)</span>
</span><span id="CellBinPipeline-251"><a href="#CellBinPipeline-251"><span class="linenos">251</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline-252"><a href="#CellBinPipeline-252"><span class="linenos">252</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline-253"><a href="#CellBinPipeline-253"><span class="linenos">253</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the input image can not be empty if param file is not provided&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline-254"><a href="#CellBinPipeline-254"><span class="linenos">254</span></a>            <span class="n">tech</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline-255"><a href="#CellBinPipeline-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">):</span>
</span><span id="CellBinPipeline-256"><a href="#CellBinPipeline-256"><span class="linenos">256</span></a>                <span class="n">param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="n">tech</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; R&quot;</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline-257"><a href="#CellBinPipeline-257"><span class="linenos">257</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline-258"><a href="#CellBinPipeline-258"><span class="linenos">258</span></a>                <span class="n">param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="n">tech</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline-259"><a href="#CellBinPipeline-259"><span class="linenos">259</span></a>            <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span><span id="CellBinPipeline-260"><a href="#CellBinPipeline-260"><span class="linenos">260</span></a>            <span class="n">new_pp</span> <span class="o">=</span> <span class="n">ProcParam</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="CellBinPipeline-261"><a href="#CellBinPipeline-261"><span class="linenos">261</span></a>            <span class="c1"># track image (ssDNA, HE, DAPI)</span>
</span><span id="CellBinPipeline-262"><a href="#CellBinPipeline-262"><span class="linenos">262</span></a>            <span class="n">im_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CellBinPipeline-263"><a href="#CellBinPipeline-263"><span class="linenos">263</span></a>            <span class="n">trans_exp_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CellBinPipeline-264"><a href="#CellBinPipeline-264"><span class="linenos">264</span></a>            <span class="n">protein_exp_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CellBinPipeline-265"><a href="#CellBinPipeline-265"><span class="linenos">265</span></a>            <span class="n">nuclear_cell_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CellBinPipeline-266"><a href="#CellBinPipeline-266"><span class="linenos">266</span></a>
</span><span id="CellBinPipeline-267"><a href="#CellBinPipeline-267"><span class="linenos">267</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">]</span>
</span><span id="CellBinPipeline-268"><a href="#CellBinPipeline-268"><span class="linenos">268</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span>
</span><span id="CellBinPipeline-269"><a href="#CellBinPipeline-269"><span class="linenos">269</span></a>            <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">template</span>
</span><span id="CellBinPipeline-270"><a href="#CellBinPipeline-270"><span class="linenos">270</span></a>            <span class="n">nuclear_cell_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="CellBinPipeline-271"><a href="#CellBinPipeline-271"><span class="linenos">271</span></a>            <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CellBinPipeline-272"><a href="#CellBinPipeline-272"><span class="linenos">272</span></a>
</span><span id="CellBinPipeline-273"><a href="#CellBinPipeline-273"><span class="linenos">273</span></a>            <span class="c1"># 转录组矩阵</span>
</span><span id="CellBinPipeline-274"><a href="#CellBinPipeline-274"><span class="linenos">274</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline-275"><a href="#CellBinPipeline-275"><span class="linenos">275</span></a>                <span class="n">trans_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Transcriptomics</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline-276"><a href="#CellBinPipeline-276"><span class="linenos">276</span></a>                <span class="n">trans_tp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span>
</span><span id="CellBinPipeline-277"><a href="#CellBinPipeline-277"><span class="linenos">277</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trans_tp</span>
</span><span id="CellBinPipeline-278"><a href="#CellBinPipeline-278"><span class="linenos">278</span></a>                <span class="n">trans_exp_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="CellBinPipeline-279"><a href="#CellBinPipeline-279"><span class="linenos">279</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">=</span> <span class="n">trans_exp_idx</span>
</span><span id="CellBinPipeline-280"><a href="#CellBinPipeline-280"><span class="linenos">280</span></a>                <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CellBinPipeline-281"><a href="#CellBinPipeline-281"><span class="linenos">281</span></a>
</span><span id="CellBinPipeline-282"><a href="#CellBinPipeline-282"><span class="linenos">282</span></a>            <span class="c1"># more images, IF, H&amp;E</span>
</span><span id="CellBinPipeline-283"><a href="#CellBinPipeline-283"><span class="linenos">283</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline-284"><a href="#CellBinPipeline-284"><span class="linenos">284</span></a>                <span class="k">for</span> <span class="n">stain_type</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline-285"><a href="#CellBinPipeline-285"><span class="linenos">285</span></a>                    <span class="k">if</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">stain_type</span><span class="p">:</span>
</span><span id="CellBinPipeline-286"><a href="#CellBinPipeline-286"><span class="linenos">286</span></a>                        <span class="c1"># IF images</span>
</span><span id="CellBinPipeline-287"><a href="#CellBinPipeline-287"><span class="linenos">287</span></a>                        <span class="n">inner_stain_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">TechType</span><span class="p">,</span> <span class="n">stain_type</span><span class="p">,</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="p">)</span>
</span><span id="CellBinPipeline-288"><a href="#CellBinPipeline-288"><span class="linenos">288</span></a>                        <span class="n">im_process_cp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">inner_stain_type</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</span><span id="CellBinPipeline-289"><a href="#CellBinPipeline-289"><span class="linenos">289</span></a>                        <span class="n">im_process_cp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="CellBinPipeline-290"><a href="#CellBinPipeline-290"><span class="linenos">290</span></a>                        <span class="c1"># im_process_cp.tech_type = stain_type</span>
</span><span id="CellBinPipeline-291"><a href="#CellBinPipeline-291"><span class="linenos">291</span></a>                        <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">im_process_cp</span>
</span><span id="CellBinPipeline-292"><a href="#CellBinPipeline-292"><span class="linenos">292</span></a>                        <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span> <span class="o">=</span> <span class="n">nuclear_cell_idx</span>
</span><span id="CellBinPipeline-293"><a href="#CellBinPipeline-293"><span class="linenos">293</span></a>                        <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CellBinPipeline-294"><a href="#CellBinPipeline-294"><span class="linenos">294</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline-295"><a href="#CellBinPipeline-295"><span class="linenos">295</span></a>                        <span class="c1"># H&amp;E</span>
</span><span id="CellBinPipeline-296"><a href="#CellBinPipeline-296"><span class="linenos">296</span></a>                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not supported&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline-297"><a href="#CellBinPipeline-297"><span class="linenos">297</span></a>
</span><span id="CellBinPipeline-298"><a href="#CellBinPipeline-298"><span class="linenos">298</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline-299"><a href="#CellBinPipeline-299"><span class="linenos">299</span></a>                <span class="n">protein_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Protein</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline-300"><a href="#CellBinPipeline-300"><span class="linenos">300</span></a>                <span class="n">protein_tp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span>
</span><span id="CellBinPipeline-301"><a href="#CellBinPipeline-301"><span class="linenos">301</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">protein_tp</span>
</span><span id="CellBinPipeline-302"><a href="#CellBinPipeline-302"><span class="linenos">302</span></a>                <span class="n">protein_exp_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="CellBinPipeline-303"><a href="#CellBinPipeline-303"><span class="linenos">303</span></a>                <span class="k">if</span> <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline-304"><a href="#CellBinPipeline-304"><span class="linenos">304</span></a>                    <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">=</span> <span class="n">protein_exp_idx</span>
</span><span id="CellBinPipeline-305"><a href="#CellBinPipeline-305"><span class="linenos">305</span></a>
</span><span id="CellBinPipeline-306"><a href="#CellBinPipeline-306"><span class="linenos">306</span></a>            <span class="c1"># end of image part info parsing</span>
</span><span id="CellBinPipeline-307"><a href="#CellBinPipeline-307"><span class="linenos">307</span></a>
</span><span id="CellBinPipeline-308"><a href="#CellBinPipeline-308"><span class="linenos">308</span></a>            <span class="c1"># 矩阵提取</span>
</span><span id="CellBinPipeline-309"><a href="#CellBinPipeline-309"><span class="linenos">309</span></a>            <span class="k">if</span> <span class="n">trans_exp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline-310"><a href="#CellBinPipeline-310"><span class="linenos">310</span></a>                <span class="n">trans_m_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Transcriptomics</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline-311"><a href="#CellBinPipeline-311"><span class="linenos">311</span></a>                <span class="n">trans_m_tp</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">=</span> <span class="n">trans_exp_idx</span>
</span><span id="CellBinPipeline-312"><a href="#CellBinPipeline-312"><span class="linenos">312</span></a>                <span class="n">trans_m_tp</span><span class="o">.</span><span class="n">cell_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclear_cell_idx</span><span class="p">]</span>
</span><span id="CellBinPipeline-313"><a href="#CellBinPipeline-313"><span class="linenos">313</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans_m_tp</span>
</span><span id="CellBinPipeline-314"><a href="#CellBinPipeline-314"><span class="linenos">314</span></a>
</span><span id="CellBinPipeline-315"><a href="#CellBinPipeline-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">protein_exp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline-316"><a href="#CellBinPipeline-316"><span class="linenos">316</span></a>                <span class="n">protein_m_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Protein</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline-317"><a href="#CellBinPipeline-317"><span class="linenos">317</span></a>                <span class="n">protein_m_tp</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">=</span> <span class="n">protein_exp_idx</span>
</span><span id="CellBinPipeline-318"><a href="#CellBinPipeline-318"><span class="linenos">318</span></a>                <span class="n">protein_m_tp</span><span class="o">.</span><span class="n">cell_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclear_cell_idx</span><span class="p">]</span>
</span><span id="CellBinPipeline-319"><a href="#CellBinPipeline-319"><span class="linenos">319</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protein_m_tp</span>
</span><span id="CellBinPipeline-320"><a href="#CellBinPipeline-320"><span class="linenos">320</span></a>            <span class="n">new_pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="CellBinPipeline-321"><a href="#CellBinPipeline-321"><span class="linenos">321</span></a>            <span class="n">param_f_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">input_json</span>
</span><span id="CellBinPipeline-322"><a href="#CellBinPipeline-322"><span class="linenos">322</span></a>            <span class="n">dict2json</span><span class="p">(</span><span class="n">new_pp</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="n">json_path</span><span class="o">=</span><span class="n">param_f_p</span><span class="p">)</span>
</span><span id="CellBinPipeline-323"><a href="#CellBinPipeline-323"><span class="linenos">323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="o">=</span> <span class="n">param_f_p</span>
</span><span id="CellBinPipeline-324"><a href="#CellBinPipeline-324"><span class="linenos">324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">new_pp</span>
</span><span id="CellBinPipeline-325"><a href="#CellBinPipeline-325"><span class="linenos">325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline-326"><a href="#CellBinPipeline-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span>
</span><span id="CellBinPipeline-327"><a href="#CellBinPipeline-327"><span class="linenos">327</span></a>                <span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span>
</span><span id="CellBinPipeline-328"><a href="#CellBinPipeline-328"><span class="linenos">328</span></a>                <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span>
</span><span id="CellBinPipeline-329"><a href="#CellBinPipeline-329"><span class="linenos">329</span></a>            <span class="p">)</span>
</span><span id="CellBinPipeline-330"><a href="#CellBinPipeline-330"><span class="linenos">330</span></a>        <span class="n">print_main_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">)</span>
</span><span id="CellBinPipeline-331"><a href="#CellBinPipeline-331"><span class="linenos">331</span></a>
</span><span id="CellBinPipeline-332"><a href="#CellBinPipeline-332"><span class="linenos">332</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">more_images</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CellBinPipeline-333"><a href="#CellBinPipeline-333"><span class="linenos">333</span></a>            <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CellBinPipeline-334"><a href="#CellBinPipeline-334"><span class="linenos">334</span></a>            <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">protein_matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">if_report</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="CellBinPipeline-335"><a href="#CellBinPipeline-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-336"><a href="#CellBinPipeline-336"><span class="linenos">336</span></a><span class="sd">        Run the full analysis pipeline.</span>
</span><span id="CellBinPipeline-337"><a href="#CellBinPipeline-337"><span class="linenos">337</span></a>
</span><span id="CellBinPipeline-338"><a href="#CellBinPipeline-338"><span class="linenos">338</span></a><span class="sd">        This method runs the entire pipeline for image analysis, including the following steps:</span>
</span><span id="CellBinPipeline-339"><a href="#CellBinPipeline-339"><span class="linenos">339</span></a><span class="sd">        - Convert user input to parameters</span>
</span><span id="CellBinPipeline-340"><a href="#CellBinPipeline-340"><span class="linenos">340</span></a><span class="sd">        - Perform image quality control</span>
</span><span id="CellBinPipeline-341"><a href="#CellBinPipeline-341"><span class="linenos">341</span></a><span class="sd">        - Perform image analysis</span>
</span><span id="CellBinPipeline-342"><a href="#CellBinPipeline-342"><span class="linenos">342</span></a><span class="sd">        - Extract matrix</span>
</span><span id="CellBinPipeline-343"><a href="#CellBinPipeline-343"><span class="linenos">343</span></a><span class="sd">        - Calculate metrics</span>
</span><span id="CellBinPipeline-344"><a href="#CellBinPipeline-344"><span class="linenos">344</span></a><span class="sd">        - Generate report</span>
</span><span id="CellBinPipeline-345"><a href="#CellBinPipeline-345"><span class="linenos">345</span></a>
</span><span id="CellBinPipeline-346"><a href="#CellBinPipeline-346"><span class="linenos">346</span></a><span class="sd">        Args:</span>
</span><span id="CellBinPipeline-347"><a href="#CellBinPipeline-347"><span class="linenos">347</span></a><span class="sd">            chip_no (str): The serial number of the chip.</span>
</span><span id="CellBinPipeline-348"><a href="#CellBinPipeline-348"><span class="linenos">348</span></a><span class="sd">            input_image (str): The path of the input image file.</span>
</span><span id="CellBinPipeline-349"><a href="#CellBinPipeline-349"><span class="linenos">349</span></a><span class="sd">            more_images (str): The paths of other input image files.</span>
</span><span id="CellBinPipeline-350"><a href="#CellBinPipeline-350"><span class="linenos">350</span></a><span class="sd">            stain_type (str): The stain type of the input image.</span>
</span><span id="CellBinPipeline-351"><a href="#CellBinPipeline-351"><span class="linenos">351</span></a><span class="sd">            param_file (str): The path of the input parameter file.</span>
</span><span id="CellBinPipeline-352"><a href="#CellBinPipeline-352"><span class="linenos">352</span></a><span class="sd">            output_path (str): The path of the output directory.</span>
</span><span id="CellBinPipeline-353"><a href="#CellBinPipeline-353"><span class="linenos">353</span></a><span class="sd">            matrix_path (str): The path of the transcriptomics matrix file.</span>
</span><span id="CellBinPipeline-354"><a href="#CellBinPipeline-354"><span class="linenos">354</span></a><span class="sd">            protein_matrix_path (str): The path of the protein matrix file.</span>
</span><span id="CellBinPipeline-355"><a href="#CellBinPipeline-355"><span class="linenos">355</span></a><span class="sd">            kit (str): The version of the kit.</span>
</span><span id="CellBinPipeline-356"><a href="#CellBinPipeline-356"><span class="linenos">356</span></a><span class="sd">            if_report (bool): Whether to generate a report.</span>
</span><span id="CellBinPipeline-357"><a href="#CellBinPipeline-357"><span class="linenos">357</span></a><span class="sd">            debug (bool): Whether to run in debug mode.</span>
</span><span id="CellBinPipeline-358"><a href="#CellBinPipeline-358"><span class="linenos">358</span></a>
</span><span id="CellBinPipeline-359"><a href="#CellBinPipeline-359"><span class="linenos">359</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline-360"><a href="#CellBinPipeline-360"><span class="linenos">360</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline-361"><a href="#CellBinPipeline-361"><span class="linenos">361</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline-362"><a href="#CellBinPipeline-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span> <span class="o">=</span> <span class="n">chip_no</span>
</span><span id="CellBinPipeline-363"><a href="#CellBinPipeline-363"><span class="linenos">363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="CellBinPipeline-364"><a href="#CellBinPipeline-364"><span class="linenos">364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span> <span class="o">=</span> <span class="n">more_images</span>
</span><span id="CellBinPipeline-365"><a href="#CellBinPipeline-365"><span class="linenos">365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span> <span class="o">=</span> <span class="n">stain_type</span>
</span><span id="CellBinPipeline-366"><a href="#CellBinPipeline-366"><span class="linenos">366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="o">=</span> <span class="n">param_file</span>
</span><span id="CellBinPipeline-367"><a href="#CellBinPipeline-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">output_path</span>
</span><span id="CellBinPipeline-368"><a href="#CellBinPipeline-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span> <span class="o">=</span> <span class="n">matrix_path</span>
</span><span id="CellBinPipeline-369"><a href="#CellBinPipeline-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span> <span class="o">=</span> <span class="n">protein_matrix_path</span>
</span><span id="CellBinPipeline-370"><a href="#CellBinPipeline-370"><span class="linenos">370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span> <span class="o">=</span> <span class="n">kit</span>
</span><span id="CellBinPipeline-371"><a href="#CellBinPipeline-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="o">=</span> <span class="n">if_report</span>
</span><span id="CellBinPipeline-372"><a href="#CellBinPipeline-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="CellBinPipeline-373"><a href="#CellBinPipeline-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline-374"><a href="#CellBinPipeline-374"><span class="linenos">374</span></a>        <span class="c1"># self.pipe_run_state = PipelineRunState(self._chip_no, self._output_path)</span>
</span><span id="CellBinPipeline-375"><a href="#CellBinPipeline-375"><span class="linenos">375</span></a>
</span><span id="CellBinPipeline-376"><a href="#CellBinPipeline-376"><span class="linenos">376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usr_inp_to_param</span><span class="p">()</span>
</span><span id="CellBinPipeline-377"><a href="#CellBinPipeline-377"><span class="linenos">377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_quality_control</span><span class="p">()</span>  <span class="c1"># 图像质控</span>
</span><span id="CellBinPipeline-378"><a href="#CellBinPipeline-378"><span class="linenos">378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_analysis</span><span class="p">()</span>  <span class="c1"># 图像分析</span>
</span><span id="CellBinPipeline-379"><a href="#CellBinPipeline-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">m_extract</span><span class="p">()</span>  <span class="c1"># 矩阵提取</span>
</span><span id="CellBinPipeline-380"><a href="#CellBinPipeline-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">()</span>  <span class="c1"># 指标计算</span>
</span><span id="CellBinPipeline-381"><a href="#CellBinPipeline-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">export_report</span><span class="p">()</span>  <span class="c1"># 生成报告</span>
</span></pre></div>


            <div class="docstring"><p>CellBinPipeline class is designed to handle the entire pipeline of cellular image processing and analysis.
It includes steps such as image quality control, image analysis, matrix extraction, metrics calculation, and report generation.</p>
</div>


                            <div id="CellBinPipeline.__init__" class="classattr">
                                        <input id="CellBinPipeline.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CellBinPipeline</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="CellBinPipeline.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.__init__-38"><a href="#CellBinPipeline.__init__-38"><span class="linenos">38</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chip_mask_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">weights_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline.__init__-39"><a href="#CellBinPipeline.__init__-39"><span class="linenos">39</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.__init__-40"><a href="#CellBinPipeline.__init__-40"><span class="linenos">40</span></a><span class="sd">        Initialize the CellBinPipeline class.</span>
</span><span id="CellBinPipeline.__init__-41"><a href="#CellBinPipeline.__init__-41"><span class="linenos">41</span></a>
</span><span id="CellBinPipeline.__init__-42"><a href="#CellBinPipeline.__init__-42"><span class="linenos">42</span></a><span class="sd">        Args:</span>
</span><span id="CellBinPipeline.__init__-43"><a href="#CellBinPipeline.__init__-43"><span class="linenos">43</span></a><span class="sd">            config_file (str): The path to the configuration file.</span>
</span><span id="CellBinPipeline.__init__-44"><a href="#CellBinPipeline.__init__-44"><span class="linenos">44</span></a><span class="sd">            chip_mask_file (str): The path to the chip mask file.</span>
</span><span id="CellBinPipeline.__init__-45"><a href="#CellBinPipeline.__init__-45"><span class="linenos">45</span></a><span class="sd">            weights_root (str): The path to the weights root directory.</span>
</span><span id="CellBinPipeline.__init__-46"><a href="#CellBinPipeline.__init__-46"><span class="linenos">46</span></a>
</span><span id="CellBinPipeline.__init__-47"><a href="#CellBinPipeline.__init__-47"><span class="linenos">47</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.__init__-48"><a href="#CellBinPipeline.__init__-48"><span class="linenos">48</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.__init__-49"><a href="#CellBinPipeline.__init__-49"><span class="linenos">49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.__init__-50"><a href="#CellBinPipeline.__init__-50"><span class="linenos">50</span></a>        <span class="c1"># alg</span>
</span><span id="CellBinPipeline.__init__-51"><a href="#CellBinPipeline.__init__-51"><span class="linenos">51</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_mask_file</span> <span class="o">=</span> <span class="n">chip_mask_file</span>
</span><span id="CellBinPipeline.__init__-52"><a href="#CellBinPipeline.__init__-52"><span class="linenos">52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
</span><span id="CellBinPipeline.__init__-53"><a href="#CellBinPipeline.__init__-53"><span class="linenos">53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span> <span class="o">=</span> <span class="n">weights_root</span>
</span><span id="CellBinPipeline.__init__-54"><a href="#CellBinPipeline.__init__-54"><span class="linenos">54</span></a>
</span><span id="CellBinPipeline.__init__-55"><a href="#CellBinPipeline.__init__-55"><span class="linenos">55</span></a>        <span class="c1"># data</span>
</span><span id="CellBinPipeline.__init__-56"><a href="#CellBinPipeline.__init__-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline.__init__-57"><a href="#CellBinPipeline.__init__-57"><span class="linenos">57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline.__init__-58"><a href="#CellBinPipeline.__init__-58"><span class="linenos">58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">TechType</span><span class="o">.</span><span class="n">ssDNA</span><span class="o">.</span><span class="n">name</span>
</span><span id="CellBinPipeline.__init__-59"><a href="#CellBinPipeline.__init__-59"><span class="linenos">59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline.__init__-60"><a href="#CellBinPipeline.__init__-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline.__init__-61"><a href="#CellBinPipeline.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline.__init__-62"><a href="#CellBinPipeline.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline.__init__-63"><a href="#CellBinPipeline.__init__-63"><span class="linenos">63</span></a>
</span><span id="CellBinPipeline.__init__-64"><a href="#CellBinPipeline.__init__-64"><span class="linenos">64</span></a>        <span class="c1"># naming</span>
</span><span id="CellBinPipeline.__init__-65"><a href="#CellBinPipeline.__init__-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CellBinPipeline.__init__-66"><a href="#CellBinPipeline.__init__-66"><span class="linenos">66</span></a>
</span><span id="CellBinPipeline.__init__-67"><a href="#CellBinPipeline.__init__-67"><span class="linenos">67</span></a>        <span class="c1"># 内部需要的</span>
</span><span id="CellBinPipeline.__init__-68"><a href="#CellBinPipeline.__init__-68"><span class="linenos">68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="p">:</span> <span class="n">ProcParam</span>
</span><span id="CellBinPipeline.__init__-69"><a href="#CellBinPipeline.__init__-69"><span class="linenos">69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span>
</span><span id="CellBinPipeline.__init__-70"><a href="#CellBinPipeline.__init__-70"><span class="linenos">70</span></a>
</span><span id="CellBinPipeline.__init__-71"><a href="#CellBinPipeline.__init__-71"><span class="linenos">71</span></a>        <span class="c1">#</span>
</span><span id="CellBinPipeline.__init__-72"><a href="#CellBinPipeline.__init__-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CellBinPipeline.__init__-73"><a href="#CellBinPipeline.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CellBinPipeline.__init__-74"><a href="#CellBinPipeline.__init__-74"><span class="linenos">74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="CellBinPipeline.__init__-75"><a href="#CellBinPipeline.__init__-75"><span class="linenos">75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">research</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the CellBinPipeline class.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>config_file (str):</strong>  The path to the configuration file.</li>
<li><strong>chip_mask_file (str):</strong>  The path to the chip mask file.</li>
<li><strong>weights_root (str):</strong>  The path to the weights root directory.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="CellBinPipeline.pp" class="classattr">
                                <div class="attr variable">
            <span class="name">pp</span><span class="annotation">: <a href="modules/metadata.html#ProcParam">cellbin2.modules.metadata.ProcParam</a></span>

        
    </div>
    <a class="headerlink" href="#CellBinPipeline.pp"></a>
    
    

                            </div>
                            <div id="CellBinPipeline.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span><span class="annotation">: <a href="utils/config.html#Config">cellbin2.utils.config.Config</a></span>

        
    </div>
    <a class="headerlink" href="#CellBinPipeline.config"></a>
    
    

                            </div>
                            <div id="CellBinPipeline.more_images" class="classattr">
                                <div class="attr variable">
            <span class="name">more_images</span><span class="annotation">: Union[Dict, NoneType]</span>

        
    </div>
    <a class="headerlink" href="#CellBinPipeline.more_images"></a>
    
    

                            </div>
                            <div id="CellBinPipeline.research" class="classattr">
                                <div class="attr variable">
            <span class="name">research</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#CellBinPipeline.research"></a>
    
    

                            </div>
                            <div id="CellBinPipeline.image_quality_control" class="classattr">
                                        <input id="CellBinPipeline.image_quality_control-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">image_quality_control</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CellBinPipeline.image_quality_control-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.image_quality_control"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.image_quality_control-77"><a href="#CellBinPipeline.image_quality_control-77"><span class="linenos"> 77</span></a>    <span class="k">def</span> <span class="nf">image_quality_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline.image_quality_control-78"><a href="#CellBinPipeline.image_quality_control-78"><span class="linenos"> 78</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.image_quality_control-79"><a href="#CellBinPipeline.image_quality_control-79"><span class="linenos"> 79</span></a><span class="sd">        Perform image quality control.</span>
</span><span id="CellBinPipeline.image_quality_control-80"><a href="#CellBinPipeline.image_quality_control-80"><span class="linenos"> 80</span></a>
</span><span id="CellBinPipeline.image_quality_control-81"><a href="#CellBinPipeline.image_quality_control-81"><span class="linenos"> 81</span></a><span class="sd">        This method checks if the QC flag in the processing parameters is set.</span>
</span><span id="CellBinPipeline.image_quality_control-82"><a href="#CellBinPipeline.image_quality_control-82"><span class="linenos"> 82</span></a><span class="sd">        If set, it imports the image_qc module and runs the image_quality_control function</span>
</span><span id="CellBinPipeline.image_quality_control-83"><a href="#CellBinPipeline.image_quality_control-83"><span class="linenos"> 83</span></a><span class="sd">        with the specified parameters. If the function returns a non-zero status code,</span>
</span><span id="CellBinPipeline.image_quality_control-84"><a href="#CellBinPipeline.image_quality_control-84"><span class="linenos"> 84</span></a><span class="sd">        the program exits with a status code of 1.</span>
</span><span id="CellBinPipeline.image_quality_control-85"><a href="#CellBinPipeline.image_quality_control-85"><span class="linenos"> 85</span></a>
</span><span id="CellBinPipeline.image_quality_control-86"><a href="#CellBinPipeline.image_quality_control-86"><span class="linenos"> 86</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.image_quality_control-87"><a href="#CellBinPipeline.image_quality_control-87"><span class="linenos"> 87</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.image_quality_control-88"><a href="#CellBinPipeline.image_quality_control-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.image_quality_control-89"><a href="#CellBinPipeline.image_quality_control-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">qc</span><span class="p">:</span>
</span><span id="CellBinPipeline.image_quality_control-90"><a href="#CellBinPipeline.image_quality_control-90"><span class="linenos"> 90</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">image_qc</span>
</span><span id="CellBinPipeline.image_quality_control-91"><a href="#CellBinPipeline.image_quality_control-91"><span class="linenos"> 91</span></a>            <span class="c1"># if self._naming.ipr.exists():</span>
</span><span id="CellBinPipeline.image_quality_control-92"><a href="#CellBinPipeline.image_quality_control-92"><span class="linenos"> 92</span></a>            <span class="c1">#     clog.info(&#39;Image QC has been done&#39;)</span>
</span><span id="CellBinPipeline.image_quality_control-93"><a href="#CellBinPipeline.image_quality_control-93"><span class="linenos"> 93</span></a>            <span class="c1">#     return 0</span>
</span><span id="CellBinPipeline.image_quality_control-94"><a href="#CellBinPipeline.image_quality_control-94"><span class="linenos"> 94</span></a>            <span class="n">s_code</span> <span class="o">=</span> <span class="n">image_qc</span><span class="o">.</span><span class="n">image_quality_control</span><span class="p">(</span>
</span><span id="CellBinPipeline.image_quality_control-95"><a href="#CellBinPipeline.image_quality_control-95"><span class="linenos"> 95</span></a>                <span class="n">weights_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_quality_control-96"><a href="#CellBinPipeline.image_quality_control-96"><span class="linenos"> 96</span></a>                <span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_quality_control-97"><a href="#CellBinPipeline.image_quality_control-97"><span class="linenos"> 97</span></a>                <span class="n">input_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_quality_control-98"><a href="#CellBinPipeline.image_quality_control-98"><span class="linenos"> 98</span></a>                <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_quality_control-99"><a href="#CellBinPipeline.image_quality_control-99"><span class="linenos"> 99</span></a>                <span class="n">param_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_quality_control-100"><a href="#CellBinPipeline.image_quality_control-100"><span class="linenos">100</span></a>                <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_quality_control-101"><a href="#CellBinPipeline.image_quality_control-101"><span class="linenos">101</span></a>                <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_quality_control-102"><a href="#CellBinPipeline.image_quality_control-102"><span class="linenos">102</span></a>                <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research</span>
</span><span id="CellBinPipeline.image_quality_control-103"><a href="#CellBinPipeline.image_quality_control-103"><span class="linenos">103</span></a>            <span class="p">)</span>
</span><span id="CellBinPipeline.image_quality_control-104"><a href="#CellBinPipeline.image_quality_control-104"><span class="linenos">104</span></a>            <span class="k">if</span> <span class="n">s_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CellBinPipeline.image_quality_control-105"><a href="#CellBinPipeline.image_quality_control-105"><span class="linenos">105</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Perform image quality control.</p>

<p>This method checks if the QC flag in the processing parameters is set.
If set, it imports the image_qc module and runs the image_quality_control function
with the specified parameters. If the function returns a non-zero status code,
the program exits with a status code of 1.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="CellBinPipeline.image_analysis" class="classattr">
                                        <input id="CellBinPipeline.image_analysis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">image_analysis</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CellBinPipeline.image_analysis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.image_analysis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.image_analysis-107"><a href="#CellBinPipeline.image_analysis-107"><span class="linenos">107</span></a>    <span class="k">def</span> <span class="nf">image_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline.image_analysis-108"><a href="#CellBinPipeline.image_analysis-108"><span class="linenos">108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.image_analysis-109"><a href="#CellBinPipeline.image_analysis-109"><span class="linenos">109</span></a><span class="sd">        Perform various image processing tasks including alignment, registration, calibration, segmentation, and matrix extraction.</span>
</span><span id="CellBinPipeline.image_analysis-110"><a href="#CellBinPipeline.image_analysis-110"><span class="linenos">110</span></a>
</span><span id="CellBinPipeline.image_analysis-111"><a href="#CellBinPipeline.image_analysis-111"><span class="linenos">111</span></a><span class="sd">        This method utilizes the scheduler pipeline to process the images based on the provided parameters.</span>
</span><span id="CellBinPipeline.image_analysis-112"><a href="#CellBinPipeline.image_analysis-112"><span class="linenos">112</span></a>
</span><span id="CellBinPipeline.image_analysis-113"><a href="#CellBinPipeline.image_analysis-113"><span class="linenos">113</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.image_analysis-114"><a href="#CellBinPipeline.image_analysis-114"><span class="linenos">114</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.image_analysis-115"><a href="#CellBinPipeline.image_analysis-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.image_analysis-116"><a href="#CellBinPipeline.image_analysis-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">alignment</span><span class="p">:</span>
</span><span id="CellBinPipeline.image_analysis-117"><a href="#CellBinPipeline.image_analysis-117"><span class="linenos">117</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">scheduler</span>
</span><span id="CellBinPipeline.image_analysis-118"><a href="#CellBinPipeline.image_analysis-118"><span class="linenos">118</span></a>            <span class="c1"># if self._naming.rpi.exists():</span>
</span><span id="CellBinPipeline.image_analysis-119"><a href="#CellBinPipeline.image_analysis-119"><span class="linenos">119</span></a>            <span class="c1">#     clog.info(&#39;scheduler has been done&#39;)</span>
</span><span id="CellBinPipeline.image_analysis-120"><a href="#CellBinPipeline.image_analysis-120"><span class="linenos">120</span></a>            <span class="c1">#     return 0</span>
</span><span id="CellBinPipeline.image_analysis-121"><a href="#CellBinPipeline.image_analysis-121"><span class="linenos">121</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">scheduler_pipeline</span><span class="p">(</span><span class="n">weights_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">,</span> <span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_analysis-122"><a href="#CellBinPipeline.image_analysis-122"><span class="linenos">122</span></a>                                         <span class="n">input_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_analysis-123"><a href="#CellBinPipeline.image_analysis-123"><span class="linenos">123</span></a>                                         <span class="n">param_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_analysis-124"><a href="#CellBinPipeline.image_analysis-124"><span class="linenos">124</span></a>                                         <span class="n">matrix_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_analysis-125"><a href="#CellBinPipeline.image_analysis-125"><span class="linenos">125</span></a>                                         <span class="n">ipr_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">,</span> <span class="n">kit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">,</span>
</span><span id="CellBinPipeline.image_analysis-126"><a href="#CellBinPipeline.image_analysis-126"><span class="linenos">126</span></a>                                         <span class="n">research_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">research</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Perform various image processing tasks including alignment, registration, calibration, segmentation, and matrix extraction.</p>

<p>This method utilizes the scheduler pipeline to process the images based on the provided parameters.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="CellBinPipeline.m_extract" class="classattr">
                                        <input id="CellBinPipeline.m_extract-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">m_extract</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CellBinPipeline.m_extract-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.m_extract"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.m_extract-128"><a href="#CellBinPipeline.m_extract-128"><span class="linenos">128</span></a>    <span class="k">def</span> <span class="nf">m_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CellBinPipeline.m_extract-129"><a href="#CellBinPipeline.m_extract-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.m_extract-130"><a href="#CellBinPipeline.m_extract-130"><span class="linenos">130</span></a><span class="sd">        Extract matrices from the processed images.</span>
</span><span id="CellBinPipeline.m_extract-131"><a href="#CellBinPipeline.m_extract-131"><span class="linenos">131</span></a>
</span><span id="CellBinPipeline.m_extract-132"><a href="#CellBinPipeline.m_extract-132"><span class="linenos">132</span></a><span class="sd">        This method runs the matrix extraction process if the corresponding flag is set in the processing parameters.</span>
</span><span id="CellBinPipeline.m_extract-133"><a href="#CellBinPipeline.m_extract-133"><span class="linenos">133</span></a>
</span><span id="CellBinPipeline.m_extract-134"><a href="#CellBinPipeline.m_extract-134"><span class="linenos">134</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.m_extract-135"><a href="#CellBinPipeline.m_extract-135"><span class="linenos">135</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.m_extract-136"><a href="#CellBinPipeline.m_extract-136"><span class="linenos">136</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.m_extract-137"><a href="#CellBinPipeline.m_extract-137"><span class="linenos">137</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">matrix_extract</span><span class="p">:</span>
</span><span id="CellBinPipeline.m_extract-138"><a href="#CellBinPipeline.m_extract-138"><span class="linenos">138</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules.extract.matrix_extract</span> <span class="kn">import</span> <span class="n">extract4matrix</span>
</span><span id="CellBinPipeline.m_extract-139"><a href="#CellBinPipeline.m_extract-139"><span class="linenos">139</span></a>            <span class="n">mcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span>
</span><span id="CellBinPipeline.m_extract-140"><a href="#CellBinPipeline.m_extract-140"><span class="linenos">140</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CellBinPipeline.m_extract-141"><a href="#CellBinPipeline.m_extract-141"><span class="linenos">141</span></a>            <span class="n">p_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline.m_extract-142"><a href="#CellBinPipeline.m_extract-142"><span class="linenos">142</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mcf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline.m_extract-143"><a href="#CellBinPipeline.m_extract-143"><span class="linenos">143</span></a>                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline.m_extract-144"><a href="#CellBinPipeline.m_extract-144"><span class="linenos">144</span></a>                    <span class="k">continue</span>
</span><span id="CellBinPipeline.m_extract-145"><a href="#CellBinPipeline.m_extract-145"><span class="linenos">145</span></a>                <span class="n">matrix</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span><span class="p">]</span>
</span><span id="CellBinPipeline.m_extract-146"><a href="#CellBinPipeline.m_extract-146"><span class="linenos">146</span></a>                <span class="n">extract4matrix</span><span class="p">(</span>
</span><span id="CellBinPipeline.m_extract-147"><a href="#CellBinPipeline.m_extract-147"><span class="linenos">147</span></a>                    <span class="n">p_naming</span><span class="o">=</span><span class="n">p_naming</span><span class="p">,</span>
</span><span id="CellBinPipeline.m_extract-148"><a href="#CellBinPipeline.m_extract-148"><span class="linenos">148</span></a>                    <span class="n">image_file</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span>
</span><span id="CellBinPipeline.m_extract-149"><a href="#CellBinPipeline.m_extract-149"><span class="linenos">149</span></a>                    <span class="n">m_naming</span><span class="o">=</span><span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span>
</span><span id="CellBinPipeline.m_extract-150"><a href="#CellBinPipeline.m_extract-150"><span class="linenos">150</span></a>                        <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline.m_extract-151"><a href="#CellBinPipeline.m_extract-151"><span class="linenos">151</span></a>                        <span class="n">m_type</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="CellBinPipeline.m_extract-152"><a href="#CellBinPipeline.m_extract-152"><span class="linenos">152</span></a>                        <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="CellBinPipeline.m_extract-153"><a href="#CellBinPipeline.m_extract-153"><span class="linenos">153</span></a>                    <span class="p">),</span>
</span><span id="CellBinPipeline.m_extract-154"><a href="#CellBinPipeline.m_extract-154"><span class="linenos">154</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Extract matrices from the processed images.</p>

<p>This method runs the matrix extraction process if the corresponding flag is set in the processing parameters.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="CellBinPipeline.metrics" class="classattr">
                                        <input id="CellBinPipeline.metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">metrics</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CellBinPipeline.metrics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.metrics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.metrics-156"><a href="#CellBinPipeline.metrics-156"><span class="linenos">156</span></a>    <span class="k">def</span> <span class="nf">metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline.metrics-157"><a href="#CellBinPipeline.metrics-157"><span class="linenos">157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.metrics-158"><a href="#CellBinPipeline.metrics-158"><span class="linenos">158</span></a><span class="sd">        Calculate metrics for the processed images and matrices.</span>
</span><span id="CellBinPipeline.metrics-159"><a href="#CellBinPipeline.metrics-159"><span class="linenos">159</span></a>
</span><span id="CellBinPipeline.metrics-160"><a href="#CellBinPipeline.metrics-160"><span class="linenos">160</span></a><span class="sd">        This method calculates various metrics if the corresponding flag is set in the processing parameters.</span>
</span><span id="CellBinPipeline.metrics-161"><a href="#CellBinPipeline.metrics-161"><span class="linenos">161</span></a>
</span><span id="CellBinPipeline.metrics-162"><a href="#CellBinPipeline.metrics-162"><span class="linenos">162</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.metrics-163"><a href="#CellBinPipeline.metrics-163"><span class="linenos">163</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.metrics-164"><a href="#CellBinPipeline.metrics-164"><span class="linenos">164</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.metrics-165"><a href="#CellBinPipeline.metrics-165"><span class="linenos">165</span></a>        <span class="k">def</span> <span class="nf">_get_stitched</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ProcFile</span><span class="p">],</span> <span class="n">g_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sn</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="CellBinPipeline.metrics-166"><a href="#CellBinPipeline.metrics-166"><span class="linenos">166</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline.metrics-167"><a href="#CellBinPipeline.metrics-167"><span class="linenos">167</span></a>                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span> <span class="o">==</span> <span class="n">g_name</span><span class="p">:</span>
</span><span id="CellBinPipeline.metrics-168"><a href="#CellBinPipeline.metrics-168"><span class="linenos">168</span></a>                    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">file_path</span>
</span><span id="CellBinPipeline.metrics-169"><a href="#CellBinPipeline.metrics-169"><span class="linenos">169</span></a>
</span><span id="CellBinPipeline.metrics-170"><a href="#CellBinPipeline.metrics-170"><span class="linenos">170</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
</span><span id="CellBinPipeline.metrics-171"><a href="#CellBinPipeline.metrics-171"><span class="linenos">171</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules.metrics</span> <span class="kn">import</span> <span class="n">ImageSource</span>
</span><span id="CellBinPipeline.metrics-172"><a href="#CellBinPipeline.metrics-172"><span class="linenos">172</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">metrics</span>
</span><span id="CellBinPipeline.metrics-173"><a href="#CellBinPipeline.metrics-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="CellBinPipeline.metrics-174"><a href="#CellBinPipeline.metrics-174"><span class="linenos">174</span></a>                <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Metrics step has been done&#39;</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-175"><a href="#CellBinPipeline.metrics-175"><span class="linenos">175</span></a>                <span class="k">return</span>
</span><span id="CellBinPipeline.metrics-176"><a href="#CellBinPipeline.metrics-176"><span class="linenos">176</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-177"><a href="#CellBinPipeline.metrics-177"><span class="linenos">177</span></a>            <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-178"><a href="#CellBinPipeline.metrics-178"><span class="linenos">178</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">do_image_qc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_scheduler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cheek_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-179"><a href="#CellBinPipeline.metrics-179"><span class="linenos">179</span></a>            <span class="n">ipr_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">ipr</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-180"><a href="#CellBinPipeline.metrics-180"><span class="linenos">180</span></a>            <span class="n">rpi_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">rpi</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-181"><a href="#CellBinPipeline.metrics-181"><span class="linenos">181</span></a>            <span class="c1"># 图片类的输入</span>
</span><span id="CellBinPipeline.metrics-182"><a href="#CellBinPipeline.metrics-182"><span class="linenos">182</span></a>            <span class="n">ipr_r</span><span class="p">,</span> <span class="n">channel_images</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ipr_file</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-183"><a href="#CellBinPipeline.metrics-183"><span class="linenos">183</span></a>            <span class="n">src_img_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CellBinPipeline.metrics-184"><a href="#CellBinPipeline.metrics-184"><span class="linenos">184</span></a>            <span class="k">for</span> <span class="n">c_name</span><span class="p">,</span> <span class="n">c_info</span> <span class="ow">in</span> <span class="n">channel_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline.metrics-185"><a href="#CellBinPipeline.metrics-185"><span class="linenos">185</span></a>                <span class="n">c_pipeline_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpImageFileNaming</span><span class="p">(</span>
</span><span id="CellBinPipeline.metrics-186"><a href="#CellBinPipeline.metrics-186"><span class="linenos">186</span></a>                    <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">stain_type</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span>
</span><span id="CellBinPipeline.metrics-187"><a href="#CellBinPipeline.metrics-187"><span class="linenos">187</span></a>                    <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>
</span><span id="CellBinPipeline.metrics-188"><a href="#CellBinPipeline.metrics-188"><span class="linenos">188</span></a>                <span class="p">)</span>
</span><span id="CellBinPipeline.metrics-189"><a href="#CellBinPipeline.metrics-189"><span class="linenos">189</span></a>                <span class="n">src_img_dict</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CellBinPipeline.metrics-190"><a href="#CellBinPipeline.metrics-190"><span class="linenos">190</span></a>                <span class="k">for</span> <span class="n">filed_name</span><span class="p">,</span> <span class="n">filed</span> <span class="ow">in</span> <span class="n">ImageSource</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline.metrics-191"><a href="#CellBinPipeline.metrics-191"><span class="linenos">191</span></a>                    <span class="k">if</span> <span class="n">filed_name</span> <span class="o">==</span> <span class="s2">&quot;cell_correct_mask&quot;</span><span class="p">:</span>
</span><span id="CellBinPipeline.metrics-192"><a href="#CellBinPipeline.metrics-192"><span class="linenos">192</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;final_cell_mask&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-193"><a href="#CellBinPipeline.metrics-193"><span class="linenos">193</span></a>                    <span class="k">elif</span> <span class="n">filed_name</span> <span class="o">==</span> <span class="s1">&#39;stitch_image&#39;</span><span class="p">:</span>
</span><span id="CellBinPipeline.metrics-194"><a href="#CellBinPipeline.metrics-194"><span class="linenos">194</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="n">_get_stitched</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">g_name</span><span class="o">=</span><span class="n">c_name</span><span class="p">,</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-195"><a href="#CellBinPipeline.metrics-195"><span class="linenos">195</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline.metrics-196"><a href="#CellBinPipeline.metrics-196"><span class="linenos">196</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c_pipeline_name</span><span class="p">,</span> <span class="n">filed_name</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-197"><a href="#CellBinPipeline.metrics-197"><span class="linenos">197</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)):</span>
</span><span id="CellBinPipeline.metrics-198"><a href="#CellBinPipeline.metrics-198"><span class="linenos">198</span></a>                        <span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="CellBinPipeline.metrics-199"><a href="#CellBinPipeline.metrics-199"><span class="linenos">199</span></a>                    <span class="n">src_img_dict</span><span class="p">[</span><span class="n">c_name</span><span class="p">][</span><span class="n">filed_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-200"><a href="#CellBinPipeline.metrics-200"><span class="linenos">200</span></a>            <span class="n">gene_matrix</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get_molecular_classify</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="CellBinPipeline.metrics-201"><a href="#CellBinPipeline.metrics-201"><span class="linenos">201</span></a>            <span class="n">matrix_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="CellBinPipeline.metrics-202"><a href="#CellBinPipeline.metrics-202"><span class="linenos">202</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">gene_matrix</span><span class="p">:</span>
</span><span id="CellBinPipeline.metrics-203"><a href="#CellBinPipeline.metrics-203"><span class="linenos">203</span></a>                <span class="n">matrix</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">exp_matrix</span><span class="p">]</span>
</span><span id="CellBinPipeline.metrics-204"><a href="#CellBinPipeline.metrics-204"><span class="linenos">204</span></a>                <span class="n">cur_m_type</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">tech</span><span class="o">.</span><span class="n">name</span>
</span><span id="CellBinPipeline.metrics-205"><a href="#CellBinPipeline.metrics-205"><span class="linenos">205</span></a>                <span class="k">if</span> <span class="n">cur_m_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matrix_dict</span><span class="p">:</span>
</span><span id="CellBinPipeline.metrics-206"><a href="#CellBinPipeline.metrics-206"><span class="linenos">206</span></a>                    <span class="n">cur_m_name</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpMatrixFileNaming</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span> <span class="n">m_type</span><span class="o">=</span><span class="n">cur_m_type</span><span class="p">,</span>
</span><span id="CellBinPipeline.metrics-207"><a href="#CellBinPipeline.metrics-207"><span class="linenos">207</span></a>                                                             <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-208"><a href="#CellBinPipeline.metrics-208"><span class="linenos">208</span></a>                    <span class="n">cur_m_src_files</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MatrixArray</span><span class="p">(</span>
</span><span id="CellBinPipeline.metrics-209"><a href="#CellBinPipeline.metrics-209"><span class="linenos">209</span></a>                        <span class="n">tissue_bin_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">tissue_bin_matrix</span><span class="p">),</span>
</span><span id="CellBinPipeline.metrics-210"><a href="#CellBinPipeline.metrics-210"><span class="linenos">210</span></a>                        <span class="n">cell_bin_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">cell_bin_matrix</span><span class="p">),</span>
</span><span id="CellBinPipeline.metrics-211"><a href="#CellBinPipeline.metrics-211"><span class="linenos">211</span></a>                        <span class="n">cell_bin_adjusted_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_m_name</span><span class="o">.</span><span class="n">cell_correct_bin_matrix</span><span class="p">),</span>
</span><span id="CellBinPipeline.metrics-212"><a href="#CellBinPipeline.metrics-212"><span class="linenos">212</span></a>                        <span class="n">bin1_matrix</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">file_path</span><span class="p">),</span>
</span><span id="CellBinPipeline.metrics-213"><a href="#CellBinPipeline.metrics-213"><span class="linenos">213</span></a>                        <span class="n">matrix_type</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">tech</span>
</span><span id="CellBinPipeline.metrics-214"><a href="#CellBinPipeline.metrics-214"><span class="linenos">214</span></a>                    <span class="p">)</span>
</span><span id="CellBinPipeline.metrics-215"><a href="#CellBinPipeline.metrics-215"><span class="linenos">215</span></a>                    <span class="n">matrix_dict</span><span class="p">[</span><span class="n">cur_m_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_m_src_files</span>
</span><span id="CellBinPipeline.metrics-216"><a href="#CellBinPipeline.metrics-216"><span class="linenos">216</span></a>            <span class="n">matrix_lists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matrix_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="CellBinPipeline.metrics-217"><a href="#CellBinPipeline.metrics-217"><span class="linenos">217</span></a>            <span class="n">fs</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">FileSource</span><span class="p">(</span>
</span><span id="CellBinPipeline.metrics-218"><a href="#CellBinPipeline.metrics-218"><span class="linenos">218</span></a>                <span class="n">ipr_file</span><span class="o">=</span><span class="n">ipr_file</span><span class="p">,</span> <span class="n">rpi_file</span><span class="o">=</span><span class="n">rpi_file</span><span class="p">,</span> <span class="n">matrix_list</span><span class="o">=</span><span class="p">[</span><span class="n">matrix_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">,</span>
</span><span id="CellBinPipeline.metrics-219"><a href="#CellBinPipeline.metrics-219"><span class="linenos">219</span></a>                <span class="n">image_dict</span><span class="o">=</span><span class="n">src_img_dict</span><span class="p">)</span>  <span class="c1"># TODO 蛋白矩阵没放进去</span>
</span><span id="CellBinPipeline.metrics-220"><a href="#CellBinPipeline.metrics-220"><span class="linenos">220</span></a>            <span class="n">metrics</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline.metrics-221"><a href="#CellBinPipeline.metrics-221"><span class="linenos">221</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metrics generated&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calculate metrics for the processed images and matrices.</p>

<p>This method calculates various metrics if the corresponding flag is set in the processing parameters.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="CellBinPipeline.export_report" class="classattr">
                                        <input id="CellBinPipeline.export_report-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">export_report</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CellBinPipeline.export_report-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.export_report"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.export_report-223"><a href="#CellBinPipeline.export_report-223"><span class="linenos">223</span></a>    <span class="k">def</span> <span class="nf">export_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
</span><span id="CellBinPipeline.export_report-224"><a href="#CellBinPipeline.export_report-224"><span class="linenos">224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.export_report-225"><a href="#CellBinPipeline.export_report-225"><span class="linenos">225</span></a><span class="sd">        Export the analysis report.</span>
</span><span id="CellBinPipeline.export_report-226"><a href="#CellBinPipeline.export_report-226"><span class="linenos">226</span></a>
</span><span id="CellBinPipeline.export_report-227"><a href="#CellBinPipeline.export_report-227"><span class="linenos">227</span></a><span class="sd">        This method generates and exports the report if the corresponding flag is set in the processing parameters.</span>
</span><span id="CellBinPipeline.export_report-228"><a href="#CellBinPipeline.export_report-228"><span class="linenos">228</span></a>
</span><span id="CellBinPipeline.export_report-229"><a href="#CellBinPipeline.export_report-229"><span class="linenos">229</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.export_report-230"><a href="#CellBinPipeline.export_report-230"><span class="linenos">230</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.export_report-231"><a href="#CellBinPipeline.export_report-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.export_report-232"><a href="#CellBinPipeline.export_report-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
</span><span id="CellBinPipeline.export_report-233"><a href="#CellBinPipeline.export_report-233"><span class="linenos">233</span></a>            <span class="kn">from</span> <span class="nn">cellbin2.modules</span> <span class="kn">import</span> <span class="n">report_m</span>
</span><span id="CellBinPipeline.export_report-234"><a href="#CellBinPipeline.export_report-234"><span class="linenos">234</span></a>
</span><span id="CellBinPipeline.export_report-235"><a href="#CellBinPipeline.export_report-235"><span class="linenos">235</span></a>            <span class="n">src_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">metrics</span>
</span><span id="CellBinPipeline.export_report-236"><a href="#CellBinPipeline.export_report-236"><span class="linenos">236</span></a>            <span class="n">report_m</span><span class="o">.</span><span class="n">creat_report</span><span class="p">(</span><span class="n">matric_json</span><span class="o">=</span><span class="n">src_file_path</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Export the analysis report.</p>

<p>This method generates and exports the report if the corresponding flag is set in the processing parameters.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="CellBinPipeline.usr_inp_to_param" class="classattr">
                                        <input id="CellBinPipeline.usr_inp_to_param-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">usr_inp_to_param</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CellBinPipeline.usr_inp_to_param-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.usr_inp_to_param"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.usr_inp_to_param-238"><a href="#CellBinPipeline.usr_inp_to_param-238"><span class="linenos">238</span></a>    <span class="k">def</span> <span class="nf">usr_inp_to_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CellBinPipeline.usr_inp_to_param-239"><a href="#CellBinPipeline.usr_inp_to_param-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.usr_inp_to_param-240"><a href="#CellBinPipeline.usr_inp_to_param-240"><span class="linenos">240</span></a><span class="sd">        Convert user input to processing parameters.</span>
</span><span id="CellBinPipeline.usr_inp_to_param-241"><a href="#CellBinPipeline.usr_inp_to_param-241"><span class="linenos">241</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-242"><a href="#CellBinPipeline.usr_inp_to_param-242"><span class="linenos">242</span></a><span class="sd">        This method converts the user-provided input into a set of processing parameters that will be used</span>
</span><span id="CellBinPipeline.usr_inp_to_param-243"><a href="#CellBinPipeline.usr_inp_to_param-243"><span class="linenos">243</span></a><span class="sd">        throughout the pipeline.</span>
</span><span id="CellBinPipeline.usr_inp_to_param-244"><a href="#CellBinPipeline.usr_inp_to_param-244"><span class="linenos">244</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-245"><a href="#CellBinPipeline.usr_inp_to_param-245"><span class="linenos">245</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-246"><a href="#CellBinPipeline.usr_inp_to_param-246"><span class="linenos">246</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.usr_inp_to_param-247"><a href="#CellBinPipeline.usr_inp_to_param-247"><span class="linenos">247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.usr_inp_to_param-248"><a href="#CellBinPipeline.usr_inp_to_param-248"><span class="linenos">248</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">):</span>
</span><span id="CellBinPipeline.usr_inp_to_param-249"><a href="#CellBinPipeline.usr_inp_to_param-249"><span class="linenos">249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">research</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CellBinPipeline.usr_inp_to_param-250"><a href="#CellBinPipeline.usr_inp_to_param-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_root</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-251"><a href="#CellBinPipeline.usr_inp_to_param-251"><span class="linenos">251</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-252"><a href="#CellBinPipeline.usr_inp_to_param-252"><span class="linenos">252</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-253"><a href="#CellBinPipeline.usr_inp_to_param-253"><span class="linenos">253</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the input image can not be empty if param file is not provided&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-254"><a href="#CellBinPipeline.usr_inp_to_param-254"><span class="linenos">254</span></a>            <span class="n">tech</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-255"><a href="#CellBinPipeline.usr_inp_to_param-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">):</span>
</span><span id="CellBinPipeline.usr_inp_to_param-256"><a href="#CellBinPipeline.usr_inp_to_param-256"><span class="linenos">256</span></a>                <span class="n">param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="n">tech</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; R&quot;</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-257"><a href="#CellBinPipeline.usr_inp_to_param-257"><span class="linenos">257</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-258"><a href="#CellBinPipeline.usr_inp_to_param-258"><span class="linenos">258</span></a>                <span class="n">param_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="n">tech</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-259"><a href="#CellBinPipeline.usr_inp_to_param-259"><span class="linenos">259</span></a>            <span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">param_file</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-260"><a href="#CellBinPipeline.usr_inp_to_param-260"><span class="linenos">260</span></a>            <span class="n">new_pp</span> <span class="o">=</span> <span class="n">ProcParam</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">pp</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-261"><a href="#CellBinPipeline.usr_inp_to_param-261"><span class="linenos">261</span></a>            <span class="c1"># track image (ssDNA, HE, DAPI)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-262"><a href="#CellBinPipeline.usr_inp_to_param-262"><span class="linenos">262</span></a>            <span class="n">im_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CellBinPipeline.usr_inp_to_param-263"><a href="#CellBinPipeline.usr_inp_to_param-263"><span class="linenos">263</span></a>            <span class="n">trans_exp_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CellBinPipeline.usr_inp_to_param-264"><a href="#CellBinPipeline.usr_inp_to_param-264"><span class="linenos">264</span></a>            <span class="n">protein_exp_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CellBinPipeline.usr_inp_to_param-265"><a href="#CellBinPipeline.usr_inp_to_param-265"><span class="linenos">265</span></a>            <span class="n">nuclear_cell_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="CellBinPipeline.usr_inp_to_param-266"><a href="#CellBinPipeline.usr_inp_to_param-266"><span class="linenos">266</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-267"><a href="#CellBinPipeline.usr_inp_to_param-267"><span class="linenos">267</span></a>            <span class="n">template</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span><span class="p">]</span>
</span><span id="CellBinPipeline.usr_inp_to_param-268"><a href="#CellBinPipeline.usr_inp_to_param-268"><span class="linenos">268</span></a>            <span class="n">template</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span>
</span><span id="CellBinPipeline.usr_inp_to_param-269"><a href="#CellBinPipeline.usr_inp_to_param-269"><span class="linenos">269</span></a>            <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">template</span>
</span><span id="CellBinPipeline.usr_inp_to_param-270"><a href="#CellBinPipeline.usr_inp_to_param-270"><span class="linenos">270</span></a>            <span class="n">nuclear_cell_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="CellBinPipeline.usr_inp_to_param-271"><a href="#CellBinPipeline.usr_inp_to_param-271"><span class="linenos">271</span></a>            <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CellBinPipeline.usr_inp_to_param-272"><a href="#CellBinPipeline.usr_inp_to_param-272"><span class="linenos">272</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-273"><a href="#CellBinPipeline.usr_inp_to_param-273"><span class="linenos">273</span></a>            <span class="c1"># 转录组矩阵</span>
</span><span id="CellBinPipeline.usr_inp_to_param-274"><a href="#CellBinPipeline.usr_inp_to_param-274"><span class="linenos">274</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-275"><a href="#CellBinPipeline.usr_inp_to_param-275"><span class="linenos">275</span></a>                <span class="n">trans_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Transcriptomics</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline.usr_inp_to_param-276"><a href="#CellBinPipeline.usr_inp_to_param-276"><span class="linenos">276</span></a>                <span class="n">trans_tp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span>
</span><span id="CellBinPipeline.usr_inp_to_param-277"><a href="#CellBinPipeline.usr_inp_to_param-277"><span class="linenos">277</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">trans_tp</span>
</span><span id="CellBinPipeline.usr_inp_to_param-278"><a href="#CellBinPipeline.usr_inp_to_param-278"><span class="linenos">278</span></a>                <span class="n">trans_exp_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="CellBinPipeline.usr_inp_to_param-279"><a href="#CellBinPipeline.usr_inp_to_param-279"><span class="linenos">279</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">=</span> <span class="n">trans_exp_idx</span>
</span><span id="CellBinPipeline.usr_inp_to_param-280"><a href="#CellBinPipeline.usr_inp_to_param-280"><span class="linenos">280</span></a>                <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CellBinPipeline.usr_inp_to_param-281"><a href="#CellBinPipeline.usr_inp_to_param-281"><span class="linenos">281</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-282"><a href="#CellBinPipeline.usr_inp_to_param-282"><span class="linenos">282</span></a>            <span class="c1"># more images, IF, H&amp;E</span>
</span><span id="CellBinPipeline.usr_inp_to_param-283"><a href="#CellBinPipeline.usr_inp_to_param-283"><span class="linenos">283</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-284"><a href="#CellBinPipeline.usr_inp_to_param-284"><span class="linenos">284</span></a>                <span class="k">for</span> <span class="n">stain_type</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="CellBinPipeline.usr_inp_to_param-285"><a href="#CellBinPipeline.usr_inp_to_param-285"><span class="linenos">285</span></a>                    <span class="k">if</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">stain_type</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-286"><a href="#CellBinPipeline.usr_inp_to_param-286"><span class="linenos">286</span></a>                        <span class="c1"># IF images</span>
</span><span id="CellBinPipeline.usr_inp_to_param-287"><a href="#CellBinPipeline.usr_inp_to_param-287"><span class="linenos">287</span></a>                        <span class="n">inner_stain_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">TechType</span><span class="p">,</span> <span class="n">stain_type</span><span class="p">,</span> <span class="n">TechType</span><span class="o">.</span><span class="n">IF</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-288"><a href="#CellBinPipeline.usr_inp_to_param-288"><span class="linenos">288</span></a>                        <span class="n">im_process_cp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">inner_stain_type</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</span><span id="CellBinPipeline.usr_inp_to_param-289"><a href="#CellBinPipeline.usr_inp_to_param-289"><span class="linenos">289</span></a>                        <span class="n">im_process_cp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span><span id="CellBinPipeline.usr_inp_to_param-290"><a href="#CellBinPipeline.usr_inp_to_param-290"><span class="linenos">290</span></a>                        <span class="c1"># im_process_cp.tech_type = stain_type</span>
</span><span id="CellBinPipeline.usr_inp_to_param-291"><a href="#CellBinPipeline.usr_inp_to_param-291"><span class="linenos">291</span></a>                        <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">im_process_cp</span>
</span><span id="CellBinPipeline.usr_inp_to_param-292"><a href="#CellBinPipeline.usr_inp_to_param-292"><span class="linenos">292</span></a>                        <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">reuse</span> <span class="o">=</span> <span class="n">nuclear_cell_idx</span>
</span><span id="CellBinPipeline.usr_inp_to_param-293"><a href="#CellBinPipeline.usr_inp_to_param-293"><span class="linenos">293</span></a>                        <span class="n">im_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CellBinPipeline.usr_inp_to_param-294"><a href="#CellBinPipeline.usr_inp_to_param-294"><span class="linenos">294</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-295"><a href="#CellBinPipeline.usr_inp_to_param-295"><span class="linenos">295</span></a>                        <span class="c1"># H&amp;E</span>
</span><span id="CellBinPipeline.usr_inp_to_param-296"><a href="#CellBinPipeline.usr_inp_to_param-296"><span class="linenos">296</span></a>                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not supported&quot;</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-297"><a href="#CellBinPipeline.usr_inp_to_param-297"><span class="linenos">297</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-298"><a href="#CellBinPipeline.usr_inp_to_param-298"><span class="linenos">298</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-299"><a href="#CellBinPipeline.usr_inp_to_param-299"><span class="linenos">299</span></a>                <span class="n">protein_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Protein</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline.usr_inp_to_param-300"><a href="#CellBinPipeline.usr_inp_to_param-300"><span class="linenos">300</span></a>                <span class="n">protein_tp</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span>
</span><span id="CellBinPipeline.usr_inp_to_param-301"><a href="#CellBinPipeline.usr_inp_to_param-301"><span class="linenos">301</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">im_count</span><span class="p">)]</span> <span class="o">=</span> <span class="n">protein_tp</span>
</span><span id="CellBinPipeline.usr_inp_to_param-302"><a href="#CellBinPipeline.usr_inp_to_param-302"><span class="linenos">302</span></a>                <span class="n">protein_exp_idx</span> <span class="o">=</span> <span class="n">im_count</span>
</span><span id="CellBinPipeline.usr_inp_to_param-303"><a href="#CellBinPipeline.usr_inp_to_param-303"><span class="linenos">303</span></a>                <span class="k">if</span> <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-304"><a href="#CellBinPipeline.usr_inp_to_param-304"><span class="linenos">304</span></a>                    <span class="n">new_pp</span><span class="o">.</span><span class="n">image_process</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nuclear_cell_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">fixed_image</span> <span class="o">=</span> <span class="n">protein_exp_idx</span>
</span><span id="CellBinPipeline.usr_inp_to_param-305"><a href="#CellBinPipeline.usr_inp_to_param-305"><span class="linenos">305</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-306"><a href="#CellBinPipeline.usr_inp_to_param-306"><span class="linenos">306</span></a>            <span class="c1"># end of image part info parsing</span>
</span><span id="CellBinPipeline.usr_inp_to_param-307"><a href="#CellBinPipeline.usr_inp_to_param-307"><span class="linenos">307</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-308"><a href="#CellBinPipeline.usr_inp_to_param-308"><span class="linenos">308</span></a>            <span class="c1"># 矩阵提取</span>
</span><span id="CellBinPipeline.usr_inp_to_param-309"><a href="#CellBinPipeline.usr_inp_to_param-309"><span class="linenos">309</span></a>            <span class="k">if</span> <span class="n">trans_exp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-310"><a href="#CellBinPipeline.usr_inp_to_param-310"><span class="linenos">310</span></a>                <span class="n">trans_m_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Transcriptomics</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline.usr_inp_to_param-311"><a href="#CellBinPipeline.usr_inp_to_param-311"><span class="linenos">311</span></a>                <span class="n">trans_m_tp</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">=</span> <span class="n">trans_exp_idx</span>
</span><span id="CellBinPipeline.usr_inp_to_param-312"><a href="#CellBinPipeline.usr_inp_to_param-312"><span class="linenos">312</span></a>                <span class="n">trans_m_tp</span><span class="o">.</span><span class="n">cell_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclear_cell_idx</span><span class="p">]</span>
</span><span id="CellBinPipeline.usr_inp_to_param-313"><a href="#CellBinPipeline.usr_inp_to_param-313"><span class="linenos">313</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans_m_tp</span>
</span><span id="CellBinPipeline.usr_inp_to_param-314"><a href="#CellBinPipeline.usr_inp_to_param-314"><span class="linenos">314</span></a>
</span><span id="CellBinPipeline.usr_inp_to_param-315"><a href="#CellBinPipeline.usr_inp_to_param-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">protein_exp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-316"><a href="#CellBinPipeline.usr_inp_to_param-316"><span class="linenos">316</span></a>                <span class="n">protein_m_tp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="n">TechType</span><span class="o">.</span><span class="n">Protein</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="CellBinPipeline.usr_inp_to_param-317"><a href="#CellBinPipeline.usr_inp_to_param-317"><span class="linenos">317</span></a>                <span class="n">protein_m_tp</span><span class="o">.</span><span class="n">exp_matrix</span> <span class="o">=</span> <span class="n">protein_exp_idx</span>
</span><span id="CellBinPipeline.usr_inp_to_param-318"><a href="#CellBinPipeline.usr_inp_to_param-318"><span class="linenos">318</span></a>                <span class="n">protein_m_tp</span><span class="o">.</span><span class="n">cell_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">nuclear_cell_idx</span><span class="p">]</span>
</span><span id="CellBinPipeline.usr_inp_to_param-319"><a href="#CellBinPipeline.usr_inp_to_param-319"><span class="linenos">319</span></a>                <span class="n">new_pp</span><span class="o">.</span><span class="n">molecular_classify</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protein_m_tp</span>
</span><span id="CellBinPipeline.usr_inp_to_param-320"><a href="#CellBinPipeline.usr_inp_to_param-320"><span class="linenos">320</span></a>            <span class="n">new_pp</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="k">else</span> <span class="kc">False</span>
</span><span id="CellBinPipeline.usr_inp_to_param-321"><a href="#CellBinPipeline.usr_inp_to_param-321"><span class="linenos">321</span></a>            <span class="n">param_f_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span><span class="o">.</span><span class="n">input_json</span>
</span><span id="CellBinPipeline.usr_inp_to_param-322"><a href="#CellBinPipeline.usr_inp_to_param-322"><span class="linenos">322</span></a>            <span class="n">dict2json</span><span class="p">(</span><span class="n">new_pp</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="n">json_path</span><span class="o">=</span><span class="n">param_f_p</span><span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-323"><a href="#CellBinPipeline.usr_inp_to_param-323"><span class="linenos">323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="o">=</span> <span class="n">param_f_p</span>
</span><span id="CellBinPipeline.usr_inp_to_param-324"><a href="#CellBinPipeline.usr_inp_to_param-324"><span class="linenos">324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">new_pp</span>
</span><span id="CellBinPipeline.usr_inp_to_param-325"><a href="#CellBinPipeline.usr_inp_to_param-325"><span class="linenos">325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CellBinPipeline.usr_inp_to_param-326"><a href="#CellBinPipeline.usr_inp_to_param-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pp</span> <span class="o">=</span> <span class="n">read_param_file</span><span class="p">(</span>
</span><span id="CellBinPipeline.usr_inp_to_param-327"><a href="#CellBinPipeline.usr_inp_to_param-327"><span class="linenos">327</span></a>                <span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span><span class="p">,</span>
</span><span id="CellBinPipeline.usr_inp_to_param-328"><a href="#CellBinPipeline.usr_inp_to_param-328"><span class="linenos">328</span></a>                <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span>
</span><span id="CellBinPipeline.usr_inp_to_param-329"><a href="#CellBinPipeline.usr_inp_to_param-329"><span class="linenos">329</span></a>            <span class="p">)</span>
</span><span id="CellBinPipeline.usr_inp_to_param-330"><a href="#CellBinPipeline.usr_inp_to_param-330"><span class="linenos">330</span></a>        <span class="n">print_main_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Convert user input to processing parameters.</p>

<p>This method converts the user-provided input into a set of processing parameters that will be used
throughout the pipeline.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="CellBinPipeline.run" class="classattr">
                                        <input id="CellBinPipeline.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">more_images</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">protein_matrix_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">kit</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">if_report</span><span class="p">:</span> <span class="nb">bool</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CellBinPipeline.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CellBinPipeline.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CellBinPipeline.run-332"><a href="#CellBinPipeline.run-332"><span class="linenos">332</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">more_images</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CellBinPipeline.run-333"><a href="#CellBinPipeline.run-333"><span class="linenos">333</span></a>            <span class="n">stain_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="CellBinPipeline.run-334"><a href="#CellBinPipeline.run-334"><span class="linenos">334</span></a>            <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">protein_matrix_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">if_report</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="CellBinPipeline.run-335"><a href="#CellBinPipeline.run-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.run-336"><a href="#CellBinPipeline.run-336"><span class="linenos">336</span></a><span class="sd">        Run the full analysis pipeline.</span>
</span><span id="CellBinPipeline.run-337"><a href="#CellBinPipeline.run-337"><span class="linenos">337</span></a>
</span><span id="CellBinPipeline.run-338"><a href="#CellBinPipeline.run-338"><span class="linenos">338</span></a><span class="sd">        This method runs the entire pipeline for image analysis, including the following steps:</span>
</span><span id="CellBinPipeline.run-339"><a href="#CellBinPipeline.run-339"><span class="linenos">339</span></a><span class="sd">        - Convert user input to parameters</span>
</span><span id="CellBinPipeline.run-340"><a href="#CellBinPipeline.run-340"><span class="linenos">340</span></a><span class="sd">        - Perform image quality control</span>
</span><span id="CellBinPipeline.run-341"><a href="#CellBinPipeline.run-341"><span class="linenos">341</span></a><span class="sd">        - Perform image analysis</span>
</span><span id="CellBinPipeline.run-342"><a href="#CellBinPipeline.run-342"><span class="linenos">342</span></a><span class="sd">        - Extract matrix</span>
</span><span id="CellBinPipeline.run-343"><a href="#CellBinPipeline.run-343"><span class="linenos">343</span></a><span class="sd">        - Calculate metrics</span>
</span><span id="CellBinPipeline.run-344"><a href="#CellBinPipeline.run-344"><span class="linenos">344</span></a><span class="sd">        - Generate report</span>
</span><span id="CellBinPipeline.run-345"><a href="#CellBinPipeline.run-345"><span class="linenos">345</span></a>
</span><span id="CellBinPipeline.run-346"><a href="#CellBinPipeline.run-346"><span class="linenos">346</span></a><span class="sd">        Args:</span>
</span><span id="CellBinPipeline.run-347"><a href="#CellBinPipeline.run-347"><span class="linenos">347</span></a><span class="sd">            chip_no (str): The serial number of the chip.</span>
</span><span id="CellBinPipeline.run-348"><a href="#CellBinPipeline.run-348"><span class="linenos">348</span></a><span class="sd">            input_image (str): The path of the input image file.</span>
</span><span id="CellBinPipeline.run-349"><a href="#CellBinPipeline.run-349"><span class="linenos">349</span></a><span class="sd">            more_images (str): The paths of other input image files.</span>
</span><span id="CellBinPipeline.run-350"><a href="#CellBinPipeline.run-350"><span class="linenos">350</span></a><span class="sd">            stain_type (str): The stain type of the input image.</span>
</span><span id="CellBinPipeline.run-351"><a href="#CellBinPipeline.run-351"><span class="linenos">351</span></a><span class="sd">            param_file (str): The path of the input parameter file.</span>
</span><span id="CellBinPipeline.run-352"><a href="#CellBinPipeline.run-352"><span class="linenos">352</span></a><span class="sd">            output_path (str): The path of the output directory.</span>
</span><span id="CellBinPipeline.run-353"><a href="#CellBinPipeline.run-353"><span class="linenos">353</span></a><span class="sd">            matrix_path (str): The path of the transcriptomics matrix file.</span>
</span><span id="CellBinPipeline.run-354"><a href="#CellBinPipeline.run-354"><span class="linenos">354</span></a><span class="sd">            protein_matrix_path (str): The path of the protein matrix file.</span>
</span><span id="CellBinPipeline.run-355"><a href="#CellBinPipeline.run-355"><span class="linenos">355</span></a><span class="sd">            kit (str): The version of the kit.</span>
</span><span id="CellBinPipeline.run-356"><a href="#CellBinPipeline.run-356"><span class="linenos">356</span></a><span class="sd">            if_report (bool): Whether to generate a report.</span>
</span><span id="CellBinPipeline.run-357"><a href="#CellBinPipeline.run-357"><span class="linenos">357</span></a><span class="sd">            debug (bool): Whether to run in debug mode.</span>
</span><span id="CellBinPipeline.run-358"><a href="#CellBinPipeline.run-358"><span class="linenos">358</span></a>
</span><span id="CellBinPipeline.run-359"><a href="#CellBinPipeline.run-359"><span class="linenos">359</span></a><span class="sd">        Returns:</span>
</span><span id="CellBinPipeline.run-360"><a href="#CellBinPipeline.run-360"><span class="linenos">360</span></a><span class="sd">            None</span>
</span><span id="CellBinPipeline.run-361"><a href="#CellBinPipeline.run-361"><span class="linenos">361</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CellBinPipeline.run-362"><a href="#CellBinPipeline.run-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_chip_no</span> <span class="o">=</span> <span class="n">chip_no</span>
</span><span id="CellBinPipeline.run-363"><a href="#CellBinPipeline.run-363"><span class="linenos">363</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_image</span> <span class="o">=</span> <span class="n">input_image</span>
</span><span id="CellBinPipeline.run-364"><a href="#CellBinPipeline.run-364"><span class="linenos">364</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">more_images</span> <span class="o">=</span> <span class="n">more_images</span>
</span><span id="CellBinPipeline.run-365"><a href="#CellBinPipeline.run-365"><span class="linenos">365</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stain_type</span> <span class="o">=</span> <span class="n">stain_type</span>
</span><span id="CellBinPipeline.run-366"><a href="#CellBinPipeline.run-366"><span class="linenos">366</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_param_file</span> <span class="o">=</span> <span class="n">param_file</span>
</span><span id="CellBinPipeline.run-367"><a href="#CellBinPipeline.run-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">output_path</span>
</span><span id="CellBinPipeline.run-368"><a href="#CellBinPipeline.run-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_matrix_path</span> <span class="o">=</span> <span class="n">matrix_path</span>
</span><span id="CellBinPipeline.run-369"><a href="#CellBinPipeline.run-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_protein_matrix_path</span> <span class="o">=</span> <span class="n">protein_matrix_path</span>
</span><span id="CellBinPipeline.run-370"><a href="#CellBinPipeline.run-370"><span class="linenos">370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_kit</span> <span class="o">=</span> <span class="n">kit</span>
</span><span id="CellBinPipeline.run-371"><a href="#CellBinPipeline.run-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_if_report</span> <span class="o">=</span> <span class="n">if_report</span>
</span><span id="CellBinPipeline.run-372"><a href="#CellBinPipeline.run-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
</span><span id="CellBinPipeline.run-373"><a href="#CellBinPipeline.run-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_naming</span> <span class="o">=</span> <span class="n">naming</span><span class="o">.</span><span class="n">DumpPipelineFileNaming</span><span class="p">(</span><span class="n">chip_no</span><span class="o">=</span><span class="n">chip_no</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span><span class="p">)</span>
</span><span id="CellBinPipeline.run-374"><a href="#CellBinPipeline.run-374"><span class="linenos">374</span></a>        <span class="c1"># self.pipe_run_state = PipelineRunState(self._chip_no, self._output_path)</span>
</span><span id="CellBinPipeline.run-375"><a href="#CellBinPipeline.run-375"><span class="linenos">375</span></a>
</span><span id="CellBinPipeline.run-376"><a href="#CellBinPipeline.run-376"><span class="linenos">376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usr_inp_to_param</span><span class="p">()</span>
</span><span id="CellBinPipeline.run-377"><a href="#CellBinPipeline.run-377"><span class="linenos">377</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_quality_control</span><span class="p">()</span>  <span class="c1"># 图像质控</span>
</span><span id="CellBinPipeline.run-378"><a href="#CellBinPipeline.run-378"><span class="linenos">378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_analysis</span><span class="p">()</span>  <span class="c1"># 图像分析</span>
</span><span id="CellBinPipeline.run-379"><a href="#CellBinPipeline.run-379"><span class="linenos">379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">m_extract</span><span class="p">()</span>  <span class="c1"># 矩阵提取</span>
</span><span id="CellBinPipeline.run-380"><a href="#CellBinPipeline.run-380"><span class="linenos">380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">()</span>  <span class="c1"># 指标计算</span>
</span><span id="CellBinPipeline.run-381"><a href="#CellBinPipeline.run-381"><span class="linenos">381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">export_report</span><span class="p">()</span>  <span class="c1"># 生成报告</span>
</span></pre></div>


            <div class="docstring"><p>Run the full analysis pipeline.</p>

<p>This method runs the entire pipeline for image analysis, including the following steps:</p>

<ul>
<li>Convert user input to parameters</li>
<li>Perform image quality control</li>
<li>Perform image analysis</li>
<li>Extract matrix</li>
<li>Calculate metrics</li>
<li>Generate report</li>
</ul>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>chip_no (str):</strong>  The serial number of the chip.</li>
<li><strong>input_image (str):</strong>  The path of the input image file.</li>
<li><strong>more_images (str):</strong>  The paths of other input image files.</li>
<li><strong>stain_type (str):</strong>  The stain type of the input image.</li>
<li><strong>param_file (str):</strong>  The path of the input parameter file.</li>
<li><strong>output_path (str):</strong>  The path of the output directory.</li>
<li><strong>matrix_path (str):</strong>  The path of the transcriptomics matrix file.</li>
<li><strong>protein_matrix_path (str):</strong>  The path of the protein matrix file.</li>
<li><strong>kit (str):</strong>  The version of the kit.</li>
<li><strong>if_report (bool):</strong>  Whether to generate a report.</li>
<li><strong>debug (bool):</strong>  Whether to run in debug mode.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="pipeline">
                            <input id="pipeline-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pipeline</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pipeline-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pipeline"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pipeline-19"><a href="#pipeline-19"><span class="linenos">19</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="pipeline-20"><a href="#pipeline-20"><span class="linenos">20</span></a>            <span class="n">tracemalloc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="pipeline-21"><a href="#pipeline-21"><span class="linenos">21</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="pipeline-22"><a href="#pipeline-22"><span class="linenos">22</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="pipeline-23"><a href="#pipeline-23"><span class="linenos">23</span></a>            <span class="n">mem_cur</span><span class="p">,</span> <span class="n">mem_peak</span> <span class="o">=</span> <span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()</span>
</span><span id="pipeline-24"><a href="#pipeline-24"><span class="linenos">24</span></a>            <span class="n">tracemalloc</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="pipeline-25"><a href="#pipeline-25"><span class="linenos">25</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> memory peak: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_peak</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ALL_UNITS</span><span class="p">[</span><span class="n">unit</span><span class="p">],</span><span class="w"> </span><span class="n">DECIMAL</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="pipeline-26"><a href="#pipeline-26"><span class="linenos">26</span></a>            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="pipeline-27"><a href="#pipeline-27"><span class="linenos">27</span></a>            <span class="n">clog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> took </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> seconds to execute.&quot;</span><span class="p">)</span>
</span><span id="pipeline-28"><a href="#pipeline-28"><span class="linenos">28</span></a>            <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>This function is used to execute the cellbin pipeline.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>weights_root (str):</strong>  The local storage directory path of CNN weight files.</li>
<li><strong>chip_no (str):</strong>  The sample chip number.</li>
<li><strong>input_image (str):</strong>  The local path of the stained image.</li>
<li><strong>stain_type (str):</strong>  The staining type corresponding to the stained image.</li>
<li><strong>param_file (str):</strong>  The local path of the input parameter file.</li>
<li><strong>kit (str):</strong>  The sequencing technology.</li>
<li><strong>output_path (str):</strong>  The local storage directory path for output files.</li>
<li><strong>matrix_path (str):</strong>  The local storage path of the expression matrix.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>int: The status code.</p>
</blockquote>
</div>


                </section>
                <section id="main">
                            <input id="main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">main</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">args</span>, </span><span class="param"><span class="n">para</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="main-447"><a href="#main-447"><span class="linenos">447</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">para</span><span class="p">):</span>
</span><span id="main-448"><a href="#main-448"><span class="linenos">448</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="main-449"><a href="#main-449"><span class="linenos">449</span></a><span class="sd">    Main function to execute the cellbin pipeline.</span>
</span><span id="main-450"><a href="#main-450"><span class="linenos">450</span></a>
</span><span id="main-451"><a href="#main-451"><span class="linenos">451</span></a><span class="sd">    This function acts as the entry - point for the cellbin pipeline. It retrieves the essential parameters</span>
</span><span id="main-452"><a href="#main-452"><span class="linenos">452</span></a><span class="sd">    from the parsed command - line arguments and additional parameter dictionary, and then passes them to</span>
</span><span id="main-453"><a href="#main-453"><span class="linenos">453</span></a><span class="sd">    the `pipeline` function for execution.</span>
</span><span id="main-454"><a href="#main-454"><span class="linenos">454</span></a>
</span><span id="main-455"><a href="#main-455"><span class="linenos">455</span></a><span class="sd">    Args:</span>
</span><span id="main-456"><a href="#main-456"><span class="linenos">456</span></a><span class="sd">        args (argparse.Namespace): The parsed command - line arguments, which hold various parameters necessary</span>
</span><span id="main-457"><a href="#main-457"><span class="linenos">457</span></a><span class="sd">            for the pipeline operation.</span>
</span><span id="main-458"><a href="#main-458"><span class="linenos">458</span></a><span class="sd">        para (dict): Additional parameters for the pipeline. These are typically used to provide supplementary</span>
</span><span id="main-459"><a href="#main-459"><span class="linenos">459</span></a><span class="sd">            configuration details or context information.</span>
</span><span id="main-460"><a href="#main-460"><span class="linenos">460</span></a>
</span><span id="main-461"><a href="#main-461"><span class="linenos">461</span></a><span class="sd">    Returns:</span>
</span><span id="main-462"><a href="#main-462"><span class="linenos">462</span></a><span class="sd">        None</span>
</span><span id="main-463"><a href="#main-463"><span class="linenos">463</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="main-464"><a href="#main-464"><span class="linenos">464</span></a>    <span class="n">chip_no</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">chip_no</span>
</span><span id="main-465"><a href="#main-465"><span class="linenos">465</span></a>    <span class="n">input_image</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">input_image</span>
</span><span id="main-466"><a href="#main-466"><span class="linenos">466</span></a>    <span class="n">more_images</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">more_images</span>
</span><span id="main-467"><a href="#main-467"><span class="linenos">467</span></a>    <span class="n">stain_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">stain_type</span>
</span><span id="main-468"><a href="#main-468"><span class="linenos">468</span></a>    <span class="n">param_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">param_file</span>
</span><span id="main-469"><a href="#main-469"><span class="linenos">469</span></a>    <span class="n">output_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_path</span>
</span><span id="main-470"><a href="#main-470"><span class="linenos">470</span></a>    <span class="n">matrix_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">matrix_file</span>
</span><span id="main-471"><a href="#main-471"><span class="linenos">471</span></a>    <span class="n">protein_matrix_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">protein_matrix_file</span>
</span><span id="main-472"><a href="#main-472"><span class="linenos">472</span></a>    <span class="n">kit</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">kit</span>
</span><span id="main-473"><a href="#main-473"><span class="linenos">473</span></a>    <span class="n">weights_root</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">weights_root</span>
</span><span id="main-474"><a href="#main-474"><span class="linenos">474</span></a>    <span class="n">if_report</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">report</span>
</span><span id="main-475"><a href="#main-475"><span class="linenos">475</span></a>    <span class="n">debug</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span>
</span><span id="main-476"><a href="#main-476"><span class="linenos">476</span></a>
</span><span id="main-477"><a href="#main-477"><span class="linenos">477</span></a>    <span class="n">pipeline</span><span class="p">(</span>
</span><span id="main-478"><a href="#main-478"><span class="linenos">478</span></a>        <span class="n">chip_no</span><span class="p">,</span>
</span><span id="main-479"><a href="#main-479"><span class="linenos">479</span></a>        <span class="n">input_image</span><span class="p">,</span>
</span><span id="main-480"><a href="#main-480"><span class="linenos">480</span></a>        <span class="n">more_images</span><span class="p">,</span>
</span><span id="main-481"><a href="#main-481"><span class="linenos">481</span></a>        <span class="n">stain_type</span><span class="p">,</span>
</span><span id="main-482"><a href="#main-482"><span class="linenos">482</span></a>        <span class="n">param_file</span><span class="p">,</span>
</span><span id="main-483"><a href="#main-483"><span class="linenos">483</span></a>        <span class="n">output_path</span><span class="p">,</span>
</span><span id="main-484"><a href="#main-484"><span class="linenos">484</span></a>        <span class="n">matrix_path</span><span class="p">,</span>
</span><span id="main-485"><a href="#main-485"><span class="linenos">485</span></a>        <span class="n">protein_matrix_path</span><span class="p">,</span>
</span><span id="main-486"><a href="#main-486"><span class="linenos">486</span></a>        <span class="n">kit</span><span class="p">,</span>
</span><span id="main-487"><a href="#main-487"><span class="linenos">487</span></a>        <span class="n">if_report</span><span class="p">,</span>
</span><span id="main-488"><a href="#main-488"><span class="linenos">488</span></a>        <span class="n">weights_root</span><span class="p">,</span>
</span><span id="main-489"><a href="#main-489"><span class="linenos">489</span></a>        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
</span><span id="main-490"><a href="#main-490"><span class="linenos">490</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Main function to execute the cellbin pipeline.</p>

<p>This function acts as the entry - point for the cellbin pipeline. It retrieves the essential parameters
from the parsed command - line arguments and additional parameter dictionary, and then passes them to
the <code><a href="#pipeline">pipeline</a></code> function for execution.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>args (argparse.Namespace):</strong>  The parsed command - line arguments, which hold various parameters necessary
for the pipeline operation.</li>
<li><strong>para (dict):</strong>  Additional parameters for the pipeline. These are typically used to provide supplementary
configuration details or context information.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>